<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>胖子叔叔的博客屋</title>
  
  
  <link href="https://loveychen.github.io/atom.xml" rel="self"/>
  
  <link href="https://loveychen.github.io/"/>
  <updated>2025-08-05T17:48:18.788Z</updated>
  <id>https://loveychen.github.io/</id>
  
  <author>
    <name>深钓大虾</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>LangChain Memory 类型详细对比分析</title>
    <link href="https://loveychen.github.io/2025/08/05/LangChain-Memory-Comparison/"/>
    <id>https://loveychen.github.io/2025/08/05/LangChain-Memory-Comparison/</id>
    <published>2025-08-05T12:44:14.000Z</published>
    <updated>2025-08-05T17:48:18.788Z</updated>
    
    <content type="html"><![CDATA[<h1>1. 概述</h1><p>LangChain 中的 Memory 系统用于在对话和链式调用中维护状态。Memory 可以存储关于过去执行的信息，并将这些信息注入到未来执行的输入中。这对于构建连贯的对话系统尤其重要。</p><p>需要注意的是，当前版本的 Memory 系统已被标记为废弃，将在 LangChain 1.0.0 版本中移除。官方推荐使用新的状态管理方式。</p><h1>2. Memory 类型层次结构</h1><pre class="mermaid">graph TD    A[BaseMemory] --> B[BaseChatMemory]    B --> C[ConversationBufferMemory]    B --> D[ConversationBufferWindowMemory]    E[BaseMemory] --> F[VectorStoreRetrieverMemory]    B --> G[ConversationSummaryMemory]    G --> H[ConversationSummaryBufferMemory]    A --> I[其他Memory实现]</pre><h1>3. 各 Memory 类型详细对比</h1><h2 id="3-1-BaseMemory-基础内存类">3.1 BaseMemory (基础内存类)</h2><p>文件路径: <a href="https://github.com/langchain-ai/langchain/blob/master/libs/core/langchain_core/memory.py">libs/core/langchain_core/memory.py</a></p><table><thead><tr><th>特性</th><th>说明</th></tr></thead><tbody><tr><td>类型</td><td>抽象基类</td></tr><tr><td>状态</td><td>已废弃 (since 0.3.3)</td></tr><tr><td>主要方法</td><td>memory_variables, load_memory_variables, save_context, clear</td></tr><tr><td>用途</td><td>所有 Memory 类型的基类</td></tr></tbody></table><p>核心抽象方法:</p><ul><li>memory_variables: 返回内存变量的键列表</li><li>load_memory_variables: 加载内存变量</li><li>save_context: 保存上下文</li><li>clear: 清除内存内容</li></ul><h2 id="3-2-BaseChatMemory-基础聊天内存类">3.2 BaseChatMemory (基础聊天内存类)</h2><p>文件路径: <a href="https://github.com/langchain-ai/langchain/blob/master/libs/langchain/langchain/memory/chat_memory.py">libs/langchain/langchain/memory/chat_memory.py</a></p><table><thead><tr><th>特性</th><th>说明</th></tr></thead><tbody><tr><td>类型</td><td>抽象基类</td></tr><tr><td>状态</td><td>已废弃 (since 0.3.1)</td></tr><tr><td>继承</td><td>BaseMemory</td></tr><tr><td>主要属性</td><td>chat_memory, output_key, input_key, return_messages</td></tr><tr><td>用途</td><td>聊天相关 Memory 的基类</td></tr></tbody></table><p>核心特性:</p><ul><li>使用 BaseChatMessageHistory 存储消息历史</li><li>提供 _get_input_output 方法来提取输入输出</li><li>实现了 save_context 和 clear 方法</li></ul><h2 id="3-3-ConversationBufferMemory-对话缓冲内存">3.3 ConversationBufferMemory (对话缓冲内存)</h2><p>文件路径: <a href="https://github.com/langchain-ai/langchain/blob/master/libs/langchain/langchain/memory/buffer.py">libs/langchain/langchain/memory/buffer.py</a></p><table><thead><tr><th>特性</th><th>说明</th></tr></thead><tbody><tr><td>类型</td><td>具体实现类</td></tr><tr><td>状态</td><td>已废弃 (since 0.3.1)</td></tr><tr><td>继承</td><td>BaseChatMemory</td></tr><tr><td>主要属性</td><td>human_prefix, ai_prefix, memory_key</td></tr><tr><td>缓冲区</td><td>存储完整对话历史</td></tr></tbody></table><p>核心特性:</p><ul><li>存储完整的对话历史（所有消息）</li><li>可以以字符串或消息列表形式返回历史</li><li>通过 buffer, buffer_as_str, buffer_as_messages 属性访问历史</li></ul><p>使用示例:</p><pre class="shiki shiki-themes everforest-light everforest-dark" style="background-color:#fdf6e3;--shiki-dark-bg:#2d353b;color:#5c6a72;--shiki-dark:#d3c6aa" tabindex="0"><code><span class="line"><span style="color:#DF69BA;--shiki-dark:#D699B6">from</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> langchain</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">memory </span><span style="color:#DF69BA;--shiki-dark:#D699B6">import</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> ConversationBufferMemory</span></span><span class="line"></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">memory </span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#8DA101;--shiki-dark:#A7C080"> ConversationBufferMemory</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">()</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">memory</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#8DA101;--shiki-dark:#A7C080">save_context</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(&#123;</span><span style="color:#DFA000;--shiki-dark:#DBBC7F">"input"</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">: </span><span style="color:#DFA000;--shiki-dark:#DBBC7F">"你好"</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">&#125;, &#123;</span><span style="color:#DFA000;--shiki-dark:#DBBC7F">"output"</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">: </span><span style="color:#DFA000;--shiki-dark:#DBBC7F">"你好！有什么我可以帮你的吗？"</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">&#125;)</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">memory</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#8DA101;--shiki-dark:#A7C080">save_context</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(&#123;</span><span style="color:#DFA000;--shiki-dark:#DBBC7F">"input"</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">: </span><span style="color:#DFA000;--shiki-dark:#DBBC7F">"我想了解LangChain"</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">&#125;, &#123;</span><span style="color:#DFA000;--shiki-dark:#DBBC7F">"output"</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">: </span><span style="color:#DFA000;--shiki-dark:#DBBC7F">"LangChain是一个用于构建LLM应用的框架"</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">&#125;)</span></span><span class="line"><span style="color:#8DA101;--shiki-dark:#A7C080">print</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(memory</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#8DA101;--shiki-dark:#A7C080">load_memory_variables</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(&#123;&#125;))</span></span><span class="line"><span style="color:#939F91;--shiki-light-font-style:italic;--shiki-dark:#859289;--shiki-dark-font-style:italic"># 输出包含所有对话历史</span></span></code></pre><p>图示说明:</p><pre class="mermaid">sequenceDiagram    participant U as 用户    participant M as ConversationBufferMemory    participant H as InMemoryChatMessageHistory    U->>M: save_context({"input": "你好"}, {"output": "你好！"})    M->>M: _get_input_output()    M->>H: add_messages([HumanMessage("你好"), AIMessage("你好！")])    U->>M: save_context({"input": "介绍一下LangChain"}, {"output": "LangChain是LLM应用框架"})    M->>M: _get_input_output()    M->>H: add_messages([HumanMessage("介绍一下LangChain"), AIMessage("LangChain是LLM应用框架")])    U->>M: load_memory_variables({})    M->>H: messages    H-->>M: [HumanMessage("你好"), AIMessage("你好！"), HumanMessage("介绍一下LangChain"), AIMessage("LangChain是LLM应用框架")]    M-->>U: {"history": "Human: 你好\nAI: 你好！\nHuman: 介绍一下LangChain\nAI: LangChain是LLM应用框架"}</pre><h2 id="3-4-ConversationBufferWindowMemory-窗口对话缓冲内存">3.4 ConversationBufferWindowMemory (窗口对话缓冲内存)</h2><p>文件路径: <a href="https://github.com/langchain-ai/langchain/blob/master/libs/langchain/langchain/memory/buffer_window.py">libs/langchain/langchain/memory/buffer_window.py</a></p><table><thead><tr><th>特性</th><th>说明</th></tr></thead><tbody><tr><td>类型</td><td>具体实现类</td></tr><tr><td>状态</td><td>已废弃 (since 0.3.1)</td></tr><tr><td>继承</td><td>BaseChatMemory</td></tr><tr><td>主要属性</td><td>human_prefix, ai_prefix, memory_key, k</td></tr><tr><td>缓冲区</td><td>存储最近 k 轮对话</td></tr></tbody></table><p>核心特性:</p><ul><li>仅存储最近 k 轮对话（默认 5 轮）</li><li>通过 k 参数控制窗口大小</li><li>自动丢弃超出窗口的历史消息</li></ul><p>使用示例:</p><pre class="shiki shiki-themes everforest-light everforest-dark" style="background-color:#fdf6e3;--shiki-dark-bg:#2d353b;color:#5c6a72;--shiki-dark:#d3c6aa" tabindex="0"><code><span class="line"><span style="color:#DF69BA;--shiki-dark:#D699B6">from</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> langchain</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">memory </span><span style="color:#DF69BA;--shiki-dark:#D699B6">import</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> ConversationBufferWindowMemory</span></span><span class="line"></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">memory </span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#8DA101;--shiki-dark:#A7C080"> ConversationBufferWindowMemory</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(k</span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#DF69BA;--shiki-dark:#D699B6">2</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">)  </span><span style="color:#939F91;--shiki-light-font-style:italic;--shiki-dark:#859289;--shiki-dark-font-style:italic"># 只保留最近2轮对话</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">memory</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#8DA101;--shiki-dark:#A7C080">save_context</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(&#123;</span><span style="color:#DFA000;--shiki-dark:#DBBC7F">"input"</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">: </span><span style="color:#DFA000;--shiki-dark:#DBBC7F">"你好"</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">&#125;, &#123;</span><span style="color:#DFA000;--shiki-dark:#DBBC7F">"output"</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">: </span><span style="color:#DFA000;--shiki-dark:#DBBC7F">"你好！"</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">&#125;)</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">memory</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#8DA101;--shiki-dark:#A7C080">save_context</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(&#123;</span><span style="color:#DFA000;--shiki-dark:#DBBC7F">"input"</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">: </span><span style="color:#DFA000;--shiki-dark:#DBBC7F">"介绍一下LangChain"</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">&#125;, &#123;</span><span style="color:#DFA000;--shiki-dark:#DBBC7F">"output"</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">: </span><span style="color:#DFA000;--shiki-dark:#DBBC7F">"LangChain是LLM应用框架"</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">&#125;)</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">memory</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#8DA101;--shiki-dark:#A7C080">save_context</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(&#123;</span><span style="color:#DFA000;--shiki-dark:#DBBC7F">"input"</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">: </span><span style="color:#DFA000;--shiki-dark:#DBBC7F">"它有什么特性"</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">&#125;, &#123;</span><span style="color:#DFA000;--shiki-dark:#DBBC7F">"output"</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">: </span><span style="color:#DFA000;--shiki-dark:#DBBC7F">"它提供了组件化、链式调用等功能"</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">&#125;)</span></span><span class="line"><span style="color:#8DA101;--shiki-dark:#A7C080">print</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(memory</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#8DA101;--shiki-dark:#A7C080">load_memory_variables</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(&#123;&#125;))</span></span><span class="line"><span style="color:#939F91;--shiki-light-font-style:italic;--shiki-dark:#859289;--shiki-dark-font-style:italic"># 只输出最近2轮对话</span></span></code></pre><p>图示说明:</p><pre class="mermaid">sequenceDiagram    participant U as 用户    participant M as ConversationBufferWindowMemory (k=2)    participant H as InMemoryChatMessageHistory    U->>M: save_context({"input": "你好"}, {"output": "你好！"})    M->>H: add_messages([HumanMessage("你好"), AIMessage("你好！")])    U->>M: save_context({"input": "介绍一下LangChain"}, {"output": "LangChain是LLM应用框架"})    M->>H: add_messages([HumanMessage("介绍一下LangChain"), AIMessage("LangChain是LLM应用框架")])    U->>M: save_context({"input": "它有什么特性"}, {"output": "它提供了组件化、链式调用等功能"})    M->>H: add_messages([HumanMessage("它有什么特性"), AIMessage("它提供了组件化、链式调用等功能")])    U->>M: load_memory_variables({})    M->>H: messages[-4:]  # 只取最近2轮（4条消息）    H-->>M: [HumanMessage("介绍一下LangChain"), AIMessage("LangChain是LLM应用框架"), HumanMessage("它有什么特性"), AIMessage("它提供了组件化、链式调用等功能")]    M-->>U: {"history": "Human: 介绍一下LangChain\nAI: LangChain是LLM应用框架\nHuman: 它有什么特性\nAI: 它提供了组件化、链式调用等功能"}</pre><h2 id="3-5-ConversationSummaryMemory-对话摘要内存">3.5 ConversationSummaryMemory (对话摘要内存)</h2><p>文件路径: <a href="https://github.com/langchain-ai/langchain/blob/master/libs/langchain/langchain/memory/summary.py">libs/langchain/langchain/memory/summary.py</a></p><table><thead><tr><th>特性</th><th>说明</th></tr></thead><tbody><tr><td>类型</td><td>具体实现类</td></tr><tr><td>状态</td><td>已废弃 (since 0.3.1)</td></tr><tr><td>继承</td><td>BaseChatMemory, SummarizerMixin</td></tr><tr><td>主要属性</td><td>buffer, memory_key, llm, prompt</td></tr><tr><td>缓冲区</td><td>存储对话摘要而非完整历史</td></tr></tbody></table><p>核心特性:</p><ul><li>使用 LLM 生成对话摘要</li><li>每次新增对话时更新摘要</li><li>节省内存和上下文长度</li><li>需要传入 LLM 实例用于生成摘要</li></ul><p>使用示例:</p><pre class="shiki shiki-themes everforest-light everforest-dark" style="background-color:#fdf6e3;--shiki-dark-bg:#2d353b;color:#5c6a72;--shiki-dark:#d3c6aa" tabindex="0"><code><span class="line"><span style="color:#DF69BA;--shiki-dark:#D699B6">from</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> langchain</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">memory </span><span style="color:#DF69BA;--shiki-dark:#D699B6">import</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> ConversationSummaryMemory</span></span><span class="line"><span style="color:#DF69BA;--shiki-dark:#D699B6">from</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> langchain_openai </span><span style="color:#DF69BA;--shiki-dark:#D699B6">import</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> OpenAI</span></span><span class="line"></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">llm </span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#8DA101;--shiki-dark:#A7C080"> OpenAI</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">()</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">memory </span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#8DA101;--shiki-dark:#A7C080"> ConversationSummaryMemory</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(llm</span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">llm)</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">memory</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#8DA101;--shiki-dark:#A7C080">save_context</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(&#123;</span><span style="color:#DFA000;--shiki-dark:#DBBC7F">"input"</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">: </span><span style="color:#DFA000;--shiki-dark:#DBBC7F">"你好"</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">&#125;, &#123;</span><span style="color:#DFA000;--shiki-dark:#DBBC7F">"output"</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">: </span><span style="color:#DFA000;--shiki-dark:#DBBC7F">"你好！"</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">&#125;)</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">memory</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#8DA101;--shiki-dark:#A7C080">save_context</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(&#123;</span><span style="color:#DFA000;--shiki-dark:#DBBC7F">"input"</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">: </span><span style="color:#DFA000;--shiki-dark:#DBBC7F">"介绍一下LangChain"</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">&#125;, &#123;</span><span style="color:#DFA000;--shiki-dark:#DBBC7F">"output"</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">: </span><span style="color:#DFA000;--shiki-dark:#DBBC7F">"LangChain是LLM应用框架"</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">&#125;)</span></span><span class="line"><span style="color:#8DA101;--shiki-dark:#A7C080">print</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(memory</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#8DA101;--shiki-dark:#A7C080">load_memory_variables</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(&#123;&#125;))</span></span><span class="line"><span style="color:#939F91;--shiki-light-font-style:italic;--shiki-dark:#859289;--shiki-dark-font-style:italic"># 输出对话摘要而非完整历史</span></span></code></pre><p>图示说明:</p><pre class="mermaid">sequenceDiagram    participant U as 用户    participant M as ConversationSummaryMemory    participant H as InMemoryChatMessageHistory    participant L as LLM    U->>M: save_context({"input": "你好"}, {"output": "你好！"})    M->>H: add_messages([HumanMessage("你好"), AIMessage("你好！")])    M->>L: predict_new_summary(["Human: 你好", "AI: 你好！"], "")    L-->>M: "用户问候，AI回应问候"    M->>M: buffer = "用户问候，AI回应问候"    U->>M: save_context({"input": "介绍一下LangChain"}, {"output": "LangChain是LLM应用框架"})    M->>H: add_messages([HumanMessage("介绍一下LangChain"), AIMessage("LangChain是LLM应用框架")])    M->>L: predict_new_summary(["Human: 介绍一下LangChain", "AI: LangChain是LLM应用框架"], "用户问候，AI回应问候")    L-->>M: "用户问候，AI回应问候。用户询问LangChain介绍，AI解释LangChain是LLM应用框架"    M->>M: buffer = "用户问候，AI回应问候。用户询问LangChain介绍，AI解释LangChain是LLM应用框架"    U->>M: load_memory_variables({})    M-->>U: {"history": "用户问候，AI回应问候。用户询问LangChain介绍，AI解释LangChain是LLM应用框架"}</pre><h2 id="3-6-ConversationSummaryBufferMemory-摘要缓冲内存">3.6 ConversationSummaryBufferMemory (摘要缓冲内存)</h2><p>文件路径: <a href="https://github.com/langchain-ai/langchain/blob/master/libs/langchain/langchain/memory/summary_buffer.py">libs/langchain/langchain/memory/summary_buffer.py</a></p><table><thead><tr><th>特性</th><th>说明</th></tr></thead><tbody><tr><td>类型</td><td>具体实现类</td></tr><tr><td>状态</td><td>已废弃 (since 0.3.1)</td></tr><tr><td>继承</td><td>BaseChatMemory, SummarizerMixin</td></tr><tr><td>主要属性</td><td>buffer, memory_key, llm, prompt, max_token_limit</td></tr><tr><td>缓冲区</td><td>结合完整历史和摘要</td></tr></tbody></table><p>核心特性:</p><ul><li>结合了缓冲和摘要的优点</li><li>保留最近的完整消息，对旧消息进行摘要</li><li>通过 max_token_limit 控制内存使用</li><li>在内存和信息完整性之间取得平衡</li></ul><p>使用示例:</p><pre class="shiki shiki-themes everforest-light everforest-dark" style="background-color:#fdf6e3;--shiki-dark-bg:#2d353b;color:#5c6a72;--shiki-dark:#d3c6aa" tabindex="0"><code><span class="line"><span style="color:#DF69BA;--shiki-dark:#D699B6">from</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> langchain</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">memory </span><span style="color:#DF69BA;--shiki-dark:#D699B6">import</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> ConversationSummaryBufferMemory</span></span><span class="line"><span style="color:#DF69BA;--shiki-dark:#D699B6">from</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> langchain_openai </span><span style="color:#DF69BA;--shiki-dark:#D699B6">import</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> OpenAI</span></span><span class="line"></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">llm </span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#8DA101;--shiki-dark:#A7C080"> OpenAI</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">()</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">memory </span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#8DA101;--shiki-dark:#A7C080"> ConversationSummaryBufferMemory</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(llm</span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">llm, max_token_limit</span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#DF69BA;--shiki-dark:#D699B6">100</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">)</span></span><span class="line"><span style="color:#939F91;--shiki-light-font-style:italic;--shiki-dark:#859289;--shiki-dark-font-style:italic"># 使用方式与其它Memory类型类似</span></span></code></pre><p>图示说明:</p><pre class="mermaid">sequenceDiagram    participant U as 用户    participant M as ConversationSummaryBufferMemory    participant H as InMemoryChatMessageHistory    participant L as LLM    Note over M,H: 初始状态：buffer="", messages=[]    U->>M: save_context({"input": "你好"}, {"output": "你好！"})    M->>H: add_messages([HumanMessage("你好"), AIMessage("你好！")])    Note over M,H: buffer="", messages=[HumanMessage("你好"), AIMessage("你好！")]    U->>M: save_context({"input": "介绍一下LangChain"}, {"output": "LangChain是LLM应用框架"})    M->>H: add_messages([HumanMessage("介绍一下LangChain"), AIMessage("LangChain是LLM应用框架")])    Note over M,H: buffer="", messages=[HumanMessage("你好"), AIMessage("你好！"), HumanMessage("介绍一下LangChain"), AIMessage("LangChain是LLM应用框架")]    U->>M: save_context({"input": "它有什么特性"}, {"output": "它提供了组件化、链式调用等功能"})    M->>H: add_messages([HumanMessage("它有什么特性"), AIMessage("它提供了组件化、链式调用等功能")])    Note over M,L: 检查token数量，如果超过max_token_limit    alt 如果超过token限制        M->>L: predict_new_summary(较旧消息, buffer)        L-->>M: 更新buffer摘要        M->>M: 移除已摘要的消息    end    U->>M: load_memory_variables({})    M-->>U: {"history": "摘要内容 + 最近完整消息"}</pre><h2 id="3-7-VectorStoreRetrieverMemory-向量存储检索内存">3.7 VectorStoreRetrieverMemory (向量存储检索内存)</h2><p>文件路径: <a href="https://github.com/langchain-ai/langchain/blob/master/libs/langchain/langchain/memory/vectorstore.py">libs/langchain/langchain/memory/vectorstore.py</a></p><table><thead><tr><th>特性</th><th>说明</th></tr></thead><tbody><tr><td>类型</td><td>具体实现类</td></tr><tr><td>状态</td><td>已废弃 (since 0.3.1)</td></tr><tr><td>继承</td><td>BaseMemory</td></tr><tr><td>主要属性</td><td>retriever, memory_key, input_key, return_docs</td></tr><tr><td>缓冲区</td><td>使用向量存储和检索机制</td></tr></tbody></table><p>核心特性:</p><ul><li>使用向量存储保存对话历史</li><li>根据输入内容检索相关历史</li><li>适用于大规模对话历史场景</li><li>需要传入 VectorStoreRetriever 实例</li></ul><p>使用示例:</p><pre class="shiki shiki-themes everforest-light everforest-dark" style="background-color:#fdf6e3;--shiki-dark-bg:#2d353b;color:#5c6a72;--shiki-dark:#d3c6aa" tabindex="0"><code><span class="line"><span style="color:#DF69BA;--shiki-dark:#D699B6">from</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> langchain</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">memory </span><span style="color:#DF69BA;--shiki-dark:#D699B6">import</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> VectorStoreRetrieverMemory</span></span><span class="line"><span style="color:#DF69BA;--shiki-dark:#D699B6">from</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> langchain</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">vectorstores </span><span style="color:#DF69BA;--shiki-dark:#D699B6">import</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> Chroma</span></span><span class="line"><span style="color:#DF69BA;--shiki-dark:#D699B6">from</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> langchain_openai </span><span style="color:#DF69BA;--shiki-dark:#D699B6">import</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> OpenAIEmbeddings</span></span><span class="line"></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">embedding </span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#8DA101;--shiki-dark:#A7C080"> OpenAIEmbeddings</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">()</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">vectorstore </span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#8DA101;--shiki-dark:#A7C080"> Chroma</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(</span><span style="color:#DFA000;--shiki-dark:#DBBC7F">"langchain_store"</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">, embedding)</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">retriever </span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> vectorstore</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#8DA101;--shiki-dark:#A7C080">as_retriever</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">()</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">memory </span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#8DA101;--shiki-dark:#A7C080"> VectorStoreRetrieverMemory</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(retriever</span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">retriever)</span></span></code></pre><p>图示说明:</p><pre class="mermaid">sequenceDiagram    participant U as 用户    participant M as VectorStoreRetrieverMemory    participant R as VectorStoreRetriever    participant V as VectorStore    U->>M: save_context({"input": "你好"}, {"output": "你好！"})    M->>M: _form_documents()    M->>R: add_documents([Document("input: 你好\noutput: 你好！")])    R->>V: 存储文档向量化表示    U->>M: save_context({"input": "介绍一下LangChain"}, {"output": "LangChain是LLM应用框架"})    M->>M: _form_documents()    M->>R: add_documents([Document("input: 介绍一下LangChain\noutput: LangChain是LLM应用框架")])    R->>V: 存储文档向量化表示    U->>M: load_memory_variables({"input": "什么是LangChain"})    M->>R: invoke("什么是LangChain")    R->>V: 相似度检索相关历史    V-->>R: 相关文档    R-->>M: [Document("input: 介绍一下LangChain\noutput: LangChain是LLM应用框架")]    M-->>U: {"history": "input: 介绍一下LangChain\noutput: LangChain是LLM应用框架"}</pre><h1>4. Memory 类型对比表</h1><table><thead><tr><th>特性</th><th>ConversationBufferMemory</th><th>ConversationBufferWindowMemory</th><th>ConversationSummaryMemory</th><th>ConversationSummaryBufferMemory</th><th>VectorStoreRetrieverMemory</th></tr></thead><tbody><tr><td>存储方式</td><td>完整历史</td><td>固定窗口</td><td>摘要</td><td>混合(近期完整+历史摘要)</td><td>向量存储</td></tr><tr><td>内存使用</td><td>高</td><td>中等</td><td>低</td><td>中等</td><td>取决于向量存储</td></tr><tr><td>上下文相关性</td><td>全部</td><td>最近 K 轮</td><td>摘要</td><td>混合</td><td>基于相似度检索</td></tr><tr><td>实现复杂度</td><td>简单</td><td>简单</td><td>复杂(需要 LLM)</td><td>复杂(需要 LLM)</td><td>复杂(需要向量存储)</td></tr><tr><td>适用场景</td><td>短对话</td><td>中等长度对话</td><td>长对话</td><td>长对话</td><td>大规模对话历史</td></tr><tr><td>需要 LLM</td><td>否</td><td>否</td><td>是</td><td>是</td><td>否</td></tr><tr><td>需要向量存储</td><td>否</td><td>否</td><td>否</td><td>否</td><td>是</td></tr></tbody></table><h1>5. Memory 使用流程对比</h1><h2 id="5-1-ConversationBufferMemory-流程">5.1 ConversationBufferMemory 流程</h2><pre class="mermaid">graph LR    A[保存上下文] --> B[添加到消息历史]    C[加载内存变量] --> D[返回完整历史]</pre><h2 id="5-2-ConversationBufferWindowMemory-流程">5.2 ConversationBufferWindowMemory 流程</h2><pre class="mermaid">graph LR    A[保存上下文] --> B[添加到消息历史]    C[加载内存变量] --> D[截取最近K轮消息]    D --> E[返回截取的历史]</pre><h2 id="5-3-ConversationSummaryMemory-流程">5.3 ConversationSummaryMemory 流程</h2><pre class="mermaid">graph LR    A[保存上下文] --> B[添加到消息历史]    B --> C[使用LLM生成新摘要]    C --> D[更新摘要缓冲区]    E[加载内存变量] --> F[返回摘要]</pre><h2 id="5-4-ConversationSummaryBufferMemory-流程">5.4 ConversationSummaryBufferMemory 流程</h2><pre class="mermaid">graph LR    A[保存上下文] --> B[添加到消息历史]    B --> C{消息长度是否超过限制}    C -->|是| D[使用LLM摘要旧消息]    D --> E[更新摘要缓冲区]    E --> F[移除已摘要消息]    C -->|否| G[保持原状]    H[加载内存变量] --> I[返回摘要+近期完整消息]</pre><h2 id="5-5-VectorStoreRetrieverMemory-流程">5.5 VectorStoreRetrieverMemory 流程</h2><pre class="mermaid">graph LR    A[保存上下文] --> B[格式化为文档]    B --> C[存储到向量数据库]    D[加载内存变量] --> E[根据输入检索相关历史]    E --> F[返回相关历史]</pre><h1>6. 使用建议</h1><h2 id="6-1-根据对话长度选择">6.1 根据对话长度选择</h2><ol><li><p><strong>短对话</strong> (&lt; 10 轮) - 使用 ConversationBufferMemory</p><ul><li>简单直接</li><li>保持完整的上下文信息</li></ul></li><li><p><strong>中等长度对话</strong> (10-50 轮) - 使用 ConversationBufferWindowMemory</p><ul><li>限制历史长度，节省内存</li><li>保持近期上下文的完整性</li></ul></li><li><p><strong>长对话</strong> (&gt; 50 轮) - 使用 ConversationSummaryBufferMemory</p><ul><li>平衡内存使用和上下文完整性</li><li>保持近期完整信息和历史摘要</li></ul></li></ol><h2 id="6-2-根据应用场景选择">6.2 根据应用场景选择</h2><ol><li><p><strong>精确上下文要求</strong> - 使用 ConversationBufferMemory 或 ConversationBufferWindowMemory</p><ul><li>适用于需要精确引用历史对话的场景</li></ul></li><li><p><strong>大规模历史存储</strong> - 使用 VectorStoreRetrieverMemory</p><ul><li>适用于需要存储大量历史且基于相关性检索的场景</li></ul></li><li><p><strong>内存受限环境</strong> - 使用 ConversationSummaryMemory</p><ul><li>适用于内存有限但需要保持长期记忆的场景</li></ul></li></ol><h1>7. 迁移建议</h1><p>由于所有 Memory 类型都已被标记为废弃，建议按照官方迁移指南进行迁移:</p><ul><li>查看迁移指南: <a href="https://python.langchain.com/docs/versions/migrating_memory/">https://python.langchain.com/docs/versions/migrating_memory/</a></li><li>考虑使用 LangGraph 进行状态管理</li><li>使用新的聊天历史接口</li></ul><p>新的推荐方式:</p><pre class="shiki shiki-themes everforest-light everforest-dark" style="background-color:#fdf6e3;--shiki-dark-bg:#2d353b;color:#5c6a72;--shiki-dark:#d3c6aa" tabindex="0"><code><span class="line"><span style="color:#939F91;--shiki-light-font-style:italic;--shiki-dark:#859289;--shiki-dark-font-style:italic"># 使用新的聊天历史接口</span></span><span class="line"><span style="color:#DF69BA;--shiki-dark:#D699B6">from</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> langchain_core</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">messages </span><span style="color:#DF69BA;--shiki-dark:#D699B6">import</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> HumanMessage, AIMessage</span></span><span class="line"><span style="color:#DF69BA;--shiki-dark:#D699B6">from</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> langchain_core</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">chat_history </span><span style="color:#DF69BA;--shiki-dark:#D699B6">import</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> InMemoryChatMessageHistory</span></span><span class="line"></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">chat_history </span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#8DA101;--shiki-dark:#A7C080"> InMemoryChatMessageHistory</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">()</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">chat_history</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#8DA101;--shiki-dark:#A7C080">add_message</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(</span><span style="color:#8DA101;--shiki-dark:#A7C080">HumanMessage</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(content</span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#DFA000;--shiki-dark:#DBBC7F">"你好"</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">))</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">chat_history</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#8DA101;--shiki-dark:#A7C080">add_message</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(</span><span style="color:#8DA101;--shiki-dark:#A7C080">AIMessage</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(content</span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#DFA000;--shiki-dark:#DBBC7F">"你好！有什么我可以帮你的吗？"</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">))</span></span></code></pre><h1>8. 总结</h1><p>LangChain 的 Memory 系统提供了多种管理对话历史的方式，每种方式都有其适用场景。虽然这些功能已被标记为废弃，但在当前版本中仍然可以使用。在新项目中，建议直接使用官方推荐的新方式来管理对话状态。</p><p>通过以上图示对比，可以更直观地理解各种 Memory 类型的工作原理和适用场景，有助于在实际项目中做出合适的选择。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;1. 概述&lt;/h1&gt;
&lt;p&gt;LangChain 中的 Memory 系统用于在对话和链式调用中维护状态。Memory 可以存储关于过去执行的信息，并将这些信息注入到未来执行的输入中。这对于构建连贯的对话系统尤其重要。&lt;/p&gt;
&lt;p&gt;需要注意的是，当前版本的 Memory </summary>
      
    
    
    
    <category term="LLM Agent" scheme="https://loveychen.github.io/categories/LLM-Agent/"/>
    
    
    <category term="LangChain" scheme="https://loveychen.github.io/tags/LangChain/"/>
    
    <category term="LLM Agent" scheme="https://loveychen.github.io/tags/LLM-Agent/"/>
    
    <category term="LLM Memory" scheme="https://loveychen.github.io/tags/LLM-Memory/"/>
    
  </entry>
  
  <entry>
    <title>VLLM 学习之路(一) - 模型服务</title>
    <link href="https://loveychen.github.io/2025/06/12/Learning-VLLM-serve-model/"/>
    <id>https://loveychen.github.io/2025/06/12/Learning-VLLM-serve-model/</id>
    <published>2025-06-12T06:21:19.000Z</published>
    <updated>2025-08-05T17:48:18.788Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://github.com/vllm-project/vllm">VLLM</a> 是当前非常流行的一个 LLM 服务和推理框架，我们将开启一个系列，详细学习 VLLM 框架。<br>这是该系列的第一篇文章，我们先介绍 VLLM 是如何启动一个模型，并提供 HTTP 接口服务的。</p><h1>VLLM 模型服务</h1><p>根据 <a href="https://docs.vllm.ai/en/latest/getting_started/quickstart.html#openai-compatible-server">VLLM 官方文档</a> 介绍，我们可以使用如下命令启动一个兼容 OpenAI 接口的 HTTP 模型服务：</p><pre class="shiki shiki-themes everforest-light everforest-dark" style="background-color:#fdf6e3;--shiki-dark-bg:#2d353b;color:#5c6a72;--shiki-dark:#d3c6aa" tabindex="0"><code><span class="line"><span style="color:#8DA101;--shiki-dark:#A7C080">vllm</span><span style="color:#DFA000;--shiki-dark:#DBBC7F"> serve</span><span style="color:#DFA000;--shiki-dark:#DBBC7F"> Qwen/Qwen2.5-0.5B-Instruct</span></span></code></pre><p>我们可以这样来理解这条命令：</p><ul><li>首先，我们使用了 vllm 这个命令，这是我们在安装 vllm 包的时候，由 vllm 的安装脚本添加到我们 Python 虚拟环境中的命令。这一般在安装包的 <a href="http://setup.py">setup.py</a> 或 pyproject.toml 文件中指定。</li></ul><p>VLLM 是在 pyproject.toml 中指定的，如下：</p><pre class="shiki shiki-themes everforest-light everforest-dark" style="background-color:#fdf6e3;--shiki-dark-bg:#2d353b;color:#5c6a72;--shiki-dark:#d3c6aa" tabindex="0"><code><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">[project.scripts]</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">vllm = </span><span style="color:#DFA000;--shiki-dark:#DBBC7F">"vllm.entrypoints.cli.main:main"</span></span></code></pre><ul><li>serve 是一个子命令，用于启动一个模型服务。 vllm 提供了多个不同功能的子命令，如 serve、chat、complete、bench 等。这可以通过 <code>vllm --help</code> 命令查看，也可以通过阅读分析 <code>vllm.entrypoints.cli.main</code> 代码找到。</li></ul><details><summary>`vllm --help` 输出的帮助信息如下：</summary><pre class="shiki shiki-themes everforest-light everforest-dark" style="background-color:#fdf6e3;--shiki-dark-bg:#2d353b;color:#5c6a72;--shiki-dark:#d3c6aa" tabindex="0"><code><span class="line"><span style="color:#8DA101;--shiki-dark:#A7C080">usage:</span><span style="color:#DFA000;--shiki-dark:#DBBC7F"> vllm</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> [-h] [-v] &#123;</span><span style="color:#8DA101;--shiki-dark:#A7C080">chat,complete,serve,bench&#125;</span><span style="color:#DFA000;--shiki-dark:#DBBC7F"> ...</span></span><span class="line"></span><span class="line"><span style="color:#8DA101;--shiki-dark:#A7C080">vLLM</span><span style="color:#DFA000;--shiki-dark:#DBBC7F"> CLI</span></span><span class="line"></span><span class="line"><span style="color:#8DA101;--shiki-dark:#A7C080">positional</span><span style="color:#DFA000;--shiki-dark:#DBBC7F"> arguments:</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">&#123;chat,complete,serve,bench&#125;</span></span><span class="line"><span style="color:#8DA101;--shiki-dark:#A7C080">chat</span><span style="color:#DFA000;--shiki-dark:#DBBC7F"> Generate</span><span style="color:#DFA000;--shiki-dark:#DBBC7F"> chat</span><span style="color:#DFA000;--shiki-dark:#DBBC7F"> completions</span><span style="color:#DFA000;--shiki-dark:#DBBC7F"> via</span><span style="color:#DFA000;--shiki-dark:#DBBC7F"> the</span><span style="color:#DFA000;--shiki-dark:#DBBC7F"> running</span><span style="color:#DFA000;--shiki-dark:#DBBC7F"> API</span><span style="color:#DFA000;--shiki-dark:#DBBC7F"> server</span></span><span class="line"><span style="color:#8DA101;--shiki-dark:#A7C080">complete</span><span style="color:#DFA000;--shiki-dark:#DBBC7F"> Generate</span><span style="color:#DFA000;--shiki-dark:#DBBC7F"> text</span><span style="color:#DFA000;--shiki-dark:#DBBC7F"> completions</span><span style="color:#DFA000;--shiki-dark:#DBBC7F"> based</span><span style="color:#DFA000;--shiki-dark:#DBBC7F"> on</span><span style="color:#DFA000;--shiki-dark:#DBBC7F"> the</span><span style="color:#DFA000;--shiki-dark:#DBBC7F"> given</span><span style="color:#DFA000;--shiki-dark:#DBBC7F"> prompt</span><span style="color:#DFA000;--shiki-dark:#DBBC7F"> via</span><span style="color:#DFA000;--shiki-dark:#DBBC7F"> the</span><span style="color:#DFA000;--shiki-dark:#DBBC7F"> running</span><span style="color:#DFA000;--shiki-dark:#DBBC7F"> API</span><span style="color:#DFA000;--shiki-dark:#DBBC7F"> server</span></span><span class="line"><span style="color:#8DA101;--shiki-dark:#A7C080">serve</span><span style="color:#DFA000;--shiki-dark:#DBBC7F"> Start</span><span style="color:#DFA000;--shiki-dark:#DBBC7F"> the</span><span style="color:#DFA000;--shiki-dark:#DBBC7F"> vLLM</span><span style="color:#DFA000;--shiki-dark:#DBBC7F"> OpenAI</span><span style="color:#DFA000;--shiki-dark:#DBBC7F"> Compatible</span><span style="color:#DFA000;--shiki-dark:#DBBC7F"> API</span><span style="color:#DFA000;--shiki-dark:#DBBC7F"> server</span></span><span class="line"><span style="color:#8DA101;--shiki-dark:#A7C080">bench</span><span style="color:#DFA000;--shiki-dark:#DBBC7F"> vLLM</span><span style="color:#DFA000;--shiki-dark:#DBBC7F"> bench</span><span style="color:#DFA000;--shiki-dark:#DBBC7F"> subcommand.</span></span><span class="line"></span><span class="line"><span style="color:#8DA101;--shiki-dark:#A7C080">options:</span></span><span class="line"><span style="color:#8DA101;--shiki-dark:#A7C080">-h,</span><span style="color:#DFA000;--shiki-dark:#DBBC7F"> --help</span><span style="color:#DFA000;--shiki-dark:#DBBC7F"> show</span><span style="color:#DFA000;--shiki-dark:#DBBC7F"> this</span><span style="color:#DFA000;--shiki-dark:#DBBC7F"> help</span><span style="color:#DFA000;--shiki-dark:#DBBC7F"> message</span><span style="color:#DFA000;--shiki-dark:#DBBC7F"> and</span><span style="color:#DFA000;--shiki-dark:#DBBC7F"> exit</span></span><span class="line"><span style="color:#8DA101;--shiki-dark:#A7C080">-v,</span><span style="color:#DFA000;--shiki-dark:#DBBC7F"> --version</span><span style="color:#DFA000;--shiki-dark:#DBBC7F"> show</span><span style="color:#DFA000;--shiki-dark:#DBBC7F"> program</span><span style="color:#8DA101;--shiki-dark:#A7C080">'s version number and exit</span></span><span class="line"></span></code></pre></details><ul><li><code>Qwen/Qwen2.5-0.5B-Instruct</code> 是本次服务的模型，这是一个 0.5B 的小尺寸模型，大家的普通电脑设备都可以跑这个模型。这里给的是一个模型名称（而不是模型路径），因此它会去 huggingface 上下载这个模型，这个过程比较耗时。如果已经下载过模型，则可以直接使用模型的完整路径启动服务。</li></ul><p>当我们看到类似如下的信息后，表明模型服务启动完成，我们可以访问 <code>localhost:8000/docs</code> 端口查看模型提供的接口及其相关文档。</p><details><summary>模型服务启动成功日志如下：</summary><p><img src="vllm-serve.png" alt="vllm-serve-startup-logs" srcset="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20300%20300'%3E%3C/svg%3E" data-src="vllm-serve.png" class="lozad post-image"></p></details><p>我们在启动模型时没有特殊设置模型名称，因此 chat 等模型服务接口的 model 参数与模型名称保持一致即可（上述示例中为 <code>Qwen/Qwen2.5-0.5B-Instruct</code>）；我们也可以调用 models 接口查看当前提供服务的模型信息，如下：~</p><pre class="shiki shiki-themes everforest-light everforest-dark" style="background-color:#fdf6e3;--shiki-dark-bg:#2d353b;color:#5c6a72;--shiki-dark:#d3c6aa" tabindex="0"><code><span class="line"><span style="color:#8DA101;--shiki-dark:#A7C080">curl</span><span style="color:#DFA000;--shiki-dark:#DBBC7F"> http://localhost:8000/v1/models</span></span></code></pre><details><summary>`curl http://localhost:8000/v1/models` 输出结果如下：</summary><pre class="shiki shiki-themes everforest-light everforest-dark" style="background-color:#fdf6e3;--shiki-dark-bg:#2d353b;color:#5c6a72;--shiki-dark:#d3c6aa" tabindex="0"><code><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">&#123;</span></span><span class="line"><span style="color:#939F91;--shiki-dark:#859289">  "</span><span style="color:#F57D26;--shiki-dark:#E69875">object</span><span style="color:#939F91;--shiki-dark:#859289">"</span><span style="color:#939F91;--shiki-dark:#859289">:</span><span style="color:#939F91;--shiki-dark:#859289"> "</span><span style="color:#8DA101;--shiki-dark:#A7C080">list</span><span style="color:#939F91;--shiki-dark:#859289">"</span><span style="color:#939F91;--shiki-dark:#859289">,</span></span><span class="line"><span style="color:#939F91;--shiki-dark:#859289">  "</span><span style="color:#F57D26;--shiki-dark:#E69875">data</span><span style="color:#939F91;--shiki-dark:#859289">"</span><span style="color:#939F91;--shiki-dark:#859289">:</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> [</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">    &#123;</span></span><span class="line"><span style="color:#939F91;--shiki-dark:#859289">      "</span><span style="color:#F57D26;--shiki-dark:#E69875">id</span><span style="color:#939F91;--shiki-dark:#859289">"</span><span style="color:#939F91;--shiki-dark:#859289">:</span><span style="color:#939F91;--shiki-dark:#859289"> "</span><span style="color:#8DA101;--shiki-dark:#A7C080">Qwen/Qwen2.5-0.5B-Instruct</span><span style="color:#939F91;--shiki-dark:#859289">"</span><span style="color:#939F91;--shiki-dark:#859289">,</span></span><span class="line"><span style="color:#939F91;--shiki-dark:#859289">      "</span><span style="color:#F57D26;--shiki-dark:#E69875">object</span><span style="color:#939F91;--shiki-dark:#859289">"</span><span style="color:#939F91;--shiki-dark:#859289">:</span><span style="color:#939F91;--shiki-dark:#859289"> "</span><span style="color:#8DA101;--shiki-dark:#A7C080">model</span><span style="color:#939F91;--shiki-dark:#859289">"</span><span style="color:#939F91;--shiki-dark:#859289">,</span></span><span class="line"><span style="color:#939F91;--shiki-dark:#859289">      "</span><span style="color:#F57D26;--shiki-dark:#E69875">created</span><span style="color:#939F91;--shiki-dark:#859289">"</span><span style="color:#939F91;--shiki-dark:#859289">:</span><span style="color:#DF69BA;--shiki-dark:#D699B6"> 1749717234</span><span style="color:#939F91;--shiki-dark:#859289">,</span></span><span class="line"><span style="color:#939F91;--shiki-dark:#859289">      "</span><span style="color:#F57D26;--shiki-dark:#E69875">owned_by</span><span style="color:#939F91;--shiki-dark:#859289">"</span><span style="color:#939F91;--shiki-dark:#859289">:</span><span style="color:#939F91;--shiki-dark:#859289"> "</span><span style="color:#8DA101;--shiki-dark:#A7C080">vllm</span><span style="color:#939F91;--shiki-dark:#859289">"</span><span style="color:#939F91;--shiki-dark:#859289">,</span></span><span class="line"><span style="color:#939F91;--shiki-dark:#859289">      "</span><span style="color:#F57D26;--shiki-dark:#E69875">root</span><span style="color:#939F91;--shiki-dark:#859289">"</span><span style="color:#939F91;--shiki-dark:#859289">:</span><span style="color:#939F91;--shiki-dark:#859289"> "</span><span style="color:#8DA101;--shiki-dark:#A7C080">Qwen/Qwen2.5-0.5B-Instruct</span><span style="color:#939F91;--shiki-dark:#859289">"</span><span style="color:#939F91;--shiki-dark:#859289">,</span></span><span class="line"><span style="color:#939F91;--shiki-dark:#859289">      "</span><span style="color:#F57D26;--shiki-dark:#E69875">parent</span><span style="color:#939F91;--shiki-dark:#859289">"</span><span style="color:#939F91;--shiki-dark:#859289">:</span><span style="color:#DF69BA;--shiki-dark:#D699B6"> null</span><span style="color:#939F91;--shiki-dark:#859289">,</span></span><span class="line"><span style="color:#939F91;--shiki-dark:#859289">      "</span><span style="color:#F57D26;--shiki-dark:#E69875">max_model_len</span><span style="color:#939F91;--shiki-dark:#859289">"</span><span style="color:#939F91;--shiki-dark:#859289">:</span><span style="color:#DF69BA;--shiki-dark:#D699B6"> 32768</span><span style="color:#939F91;--shiki-dark:#859289">,</span></span><span class="line"><span style="color:#939F91;--shiki-dark:#859289">      "</span><span style="color:#F57D26;--shiki-dark:#E69875">permission</span><span style="color:#939F91;--shiki-dark:#859289">"</span><span style="color:#939F91;--shiki-dark:#859289">:</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> [</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">        &#123;</span></span><span class="line"><span style="color:#939F91;--shiki-dark:#859289">          "</span><span style="color:#F57D26;--shiki-dark:#E69875">id</span><span style="color:#939F91;--shiki-dark:#859289">"</span><span style="color:#939F91;--shiki-dark:#859289">:</span><span style="color:#939F91;--shiki-dark:#859289"> "</span><span style="color:#8DA101;--shiki-dark:#A7C080">modelperm-b2c923266dea46239192c5ab91652978</span><span style="color:#939F91;--shiki-dark:#859289">"</span><span style="color:#939F91;--shiki-dark:#859289">,</span></span><span class="line"><span style="color:#939F91;--shiki-dark:#859289">          "</span><span style="color:#F57D26;--shiki-dark:#E69875">object</span><span style="color:#939F91;--shiki-dark:#859289">"</span><span style="color:#939F91;--shiki-dark:#859289">:</span><span style="color:#939F91;--shiki-dark:#859289"> "</span><span style="color:#8DA101;--shiki-dark:#A7C080">model_permission</span><span style="color:#939F91;--shiki-dark:#859289">"</span><span style="color:#939F91;--shiki-dark:#859289">,</span></span><span class="line"><span style="color:#939F91;--shiki-dark:#859289">          "</span><span style="color:#F57D26;--shiki-dark:#E69875">created</span><span style="color:#939F91;--shiki-dark:#859289">"</span><span style="color:#939F91;--shiki-dark:#859289">:</span><span style="color:#DF69BA;--shiki-dark:#D699B6"> 1749717234</span><span style="color:#939F91;--shiki-dark:#859289">,</span></span><span class="line"><span style="color:#939F91;--shiki-dark:#859289">          "</span><span style="color:#F57D26;--shiki-dark:#E69875">allow_create_engine</span><span style="color:#939F91;--shiki-dark:#859289">"</span><span style="color:#939F91;--shiki-dark:#859289">:</span><span style="color:#DF69BA;--shiki-dark:#D699B6"> false</span><span style="color:#939F91;--shiki-dark:#859289">,</span></span><span class="line"><span style="color:#939F91;--shiki-dark:#859289">          "</span><span style="color:#F57D26;--shiki-dark:#E69875">allow_sampling</span><span style="color:#939F91;--shiki-dark:#859289">"</span><span style="color:#939F91;--shiki-dark:#859289">:</span><span style="color:#DF69BA;--shiki-dark:#D699B6"> true</span><span style="color:#939F91;--shiki-dark:#859289">,</span></span><span class="line"><span style="color:#939F91;--shiki-dark:#859289">          "</span><span style="color:#F57D26;--shiki-dark:#E69875">allow_logprobs</span><span style="color:#939F91;--shiki-dark:#859289">"</span><span style="color:#939F91;--shiki-dark:#859289">:</span><span style="color:#DF69BA;--shiki-dark:#D699B6"> true</span><span style="color:#939F91;--shiki-dark:#859289">,</span></span><span class="line"><span style="color:#939F91;--shiki-dark:#859289">          "</span><span style="color:#F57D26;--shiki-dark:#E69875">allow_search_indices</span><span style="color:#939F91;--shiki-dark:#859289">"</span><span style="color:#939F91;--shiki-dark:#859289">:</span><span style="color:#DF69BA;--shiki-dark:#D699B6"> false</span><span style="color:#939F91;--shiki-dark:#859289">,</span></span><span class="line"><span style="color:#939F91;--shiki-dark:#859289">          "</span><span style="color:#F57D26;--shiki-dark:#E69875">allow_view</span><span style="color:#939F91;--shiki-dark:#859289">"</span><span style="color:#939F91;--shiki-dark:#859289">:</span><span style="color:#DF69BA;--shiki-dark:#D699B6"> true</span><span style="color:#939F91;--shiki-dark:#859289">,</span></span><span class="line"><span style="color:#939F91;--shiki-dark:#859289">          "</span><span style="color:#F57D26;--shiki-dark:#E69875">allow_fine_tuning</span><span style="color:#939F91;--shiki-dark:#859289">"</span><span style="color:#939F91;--shiki-dark:#859289">:</span><span style="color:#DF69BA;--shiki-dark:#D699B6"> false</span><span style="color:#939F91;--shiki-dark:#859289">,</span></span><span class="line"><span style="color:#939F91;--shiki-dark:#859289">          "</span><span style="color:#F57D26;--shiki-dark:#E69875">organization</span><span style="color:#939F91;--shiki-dark:#859289">"</span><span style="color:#939F91;--shiki-dark:#859289">:</span><span style="color:#939F91;--shiki-dark:#859289"> "</span><span style="color:#8DA101;--shiki-dark:#A7C080">*</span><span style="color:#939F91;--shiki-dark:#859289">"</span><span style="color:#939F91;--shiki-dark:#859289">,</span></span><span class="line"><span style="color:#939F91;--shiki-dark:#859289">          "</span><span style="color:#F57D26;--shiki-dark:#E69875">group</span><span style="color:#939F91;--shiki-dark:#859289">"</span><span style="color:#939F91;--shiki-dark:#859289">:</span><span style="color:#DF69BA;--shiki-dark:#D699B6"> null</span><span style="color:#939F91;--shiki-dark:#859289">,</span></span><span class="line"><span style="color:#939F91;--shiki-dark:#859289">          "</span><span style="color:#F57D26;--shiki-dark:#E69875">is_blocking</span><span style="color:#939F91;--shiki-dark:#859289">"</span><span style="color:#939F91;--shiki-dark:#859289">:</span><span style="color:#DF69BA;--shiki-dark:#D699B6"> false</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">        &#125;</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">      ]</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">    &#125;</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">  ]</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">&#125;</span></span></code></pre></details>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;&lt;a href=&quot;https://github.com/vllm-project/vllm&quot;&gt;VLLM&lt;/a&gt; 是当前非常流行的一个 LLM 服务和推理框架，我们将开启一个系列，详细学习 VLLM 框架。&lt;br&gt;
这是该系列的第一篇文章，我们先介绍 VLLM 是如何启动一个</summary>
      
    
    
    
    
    <category term="VLLM" scheme="https://loveychen.github.io/tags/VLLM/"/>
    
    <category term="LLM Inference" scheme="https://loveychen.github.io/tags/LLM-Inference/"/>
    
  </entry>
  
  <entry>
    <title>从 Logistic Regression 谈起: logit、logic、logistic 傻傻分不清楚</title>
    <link href="https://loveychen.github.io/2022/11/24/brief-intro-to-logit/"/>
    <id>https://loveychen.github.io/2022/11/24/brief-intro-to-logit/</id>
    <published>2022-11-24T12:44:14.000Z</published>
    <updated>2025-08-05T17:48:18.793Z</updated>
    
    <content type="html"><![CDATA[<p>逻辑回归 (Logistic Regression, LR) 是一种经典的机器学习模型, 在很多机器学习任务(比如广告推荐, 推荐排序等)中, 都可以作为 baseline 模型使用.</p><p>从名字上看, LR 包含 Logistic 和 Regression 两个单词, 其中</p><ul><li>Logistic 源自 Logistic Distribution, LR 中使用 Logistic 分布建模分类概率</li><li>Regression 源自 Linear Regression, LR 中的采用了回归的思路来建模分类问题</li></ul><p>因此, LR 的两个单词完全概括了它的两个组成部分: 使用线性回归模型将特征转换成一个实数, 然后实用逻辑分布将该实数转换为分类概率.</p><p>看到这里, 你是不是会想: 又有人要来水逻辑回归的博文了 …</p><p>先别忙下结论, 逻辑回归只是我们这篇文章的引子, 我们在这篇文章中主要聊一聊 “逻辑” 这个词的前世今生.</p><h1>逻辑回归中的“逻辑”</h1><p>逻辑回归中有两个地方跟“逻辑“挂钩， 前面已经提到了逻辑分布（the Logistic Distribution）。</p><p>另一个地方是 logit。逻辑回归中的线性模型部分就是在建模事件发生的 logit.</p><p>logit 一般翻译为 ”对数比， 对数几率“。1944年 Joseph Berkson 在创造这个术语时，恐怕同时受到了 logarithm (对数) 和 logistic function (逻辑函数) 的双重影响。<br>不管怎样，logit、logistic、logarith 应该都跟 logic 是同根词，大家都源自词根 <a href="https://membean.com/roots/log-word">log-</a>。</p><p>从数学上讲，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span> 被预测为正类 的 logit 是其 odds 的对数。 odds 一般翻译为 ”几率&quot;, 它的英文解释是 “the probability (= how likely it is) that a particular thing will or will not happen”,即 一个事件发生和不发生的比率。<br>不过英文解释中的 probability 并不满足 probability 在数学上的定义，因为 odds 值域是非负实数域 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle scriptlevel="0" displaystyle="true"><msup><mi mathvariant="bold">R</mi><mo lspace="0em" rspace="0em">∗</mo></msup></mstyle></mrow><annotation encoding="application/x-tex">\displaystyle \mathbf{R}^{*}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7387em;"></span><span class="mord"><span class="mord mathbf">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7387em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">∗</span></span></span></span></span></span></span></span></span></span></span></span>, 而不是 <code>[0, 1]</code> 这个闭区间.</p><p>我们用数学语言重新描述一下上面的解释。对于二分类任务，LR 将样本 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold-italic">x</mi></mrow><annotation encoding="application/x-tex">\boldsymbol{x}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4444em;"></span><span class="mord"><span class="mord"><span class="mord boldsymbol">x</span></span></span></span></span></span> 被划分为正类的概率建模如下：</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><mi>Y</mi><mo>=</mo><mn>1</mn><mi mathvariant="normal">∣</mi><mi mathvariant="bold-italic">x</mi><mo stretchy="false">)</mo><mo>=</mo><mfrac><mn>1</mn><mrow><mn>1</mn><mo>+</mo><msup><mi>e</mi><mrow><mo>−</mo><mi><mrow><mi mathvariant="bold-italic">W</mi><mi mathvariant="bold-italic">x</mi></mrow></mi></mrow></msup></mrow></mfrac></mrow><annotation encoding="application/x-tex">P(Y=1|\boldsymbol{x}) = \frac{1}{1 + e^{-\boldsymbol{Wx}}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1∣</span><span class="mord"><span class="mord"><span class="mord boldsymbol">x</span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.0908em;vertical-align:-0.7693em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7693em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight"><span class="mord mtight"><span class="mord boldsymbol mtight">Wx</span></span></span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.7693em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p><p>其中 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold-italic">W</mi></mrow><annotation encoding="application/x-tex">\boldsymbol{W}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6861em;"></span><span class="mord"><span class="mord"><span class="mord boldsymbol" style="margin-right:0.15972em;">W</span></span></span></span></span></span> 是需要学习的参数. 这里用到了 Logistic Function，是 LR 中 Logistic 一词的由来。</p><p>该样本被划分为正类的 odds 则可以表示如下:</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mtext>odds</mtext><mi>P</mi><mo stretchy="false">(</mo><mi>Y</mi><mo>=</mo><mn>1</mn><mi mathvariant="normal">∣</mi><mi mathvariant="bold-italic">x</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mfrac><mrow><mi>P</mi><mo stretchy="false">(</mo><mi>Y</mi><mo>=</mo><mn>1</mn><mi mathvariant="normal">∣</mi><mi mathvariant="bold-italic">x</mi><mo stretchy="false">)</mo></mrow><mrow><mi>P</mi><mo stretchy="false">(</mo><mi>Y</mi><mo>=</mo><mn>0</mn><mi mathvariant="normal">∣</mi><mi mathvariant="bold-italic">x</mi><mo stretchy="false">)</mo></mrow></mfrac></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><msup><mi>e</mi><mi><mrow><mi mathvariant="bold-italic">W</mi><mi mathvariant="bold-italic">x</mi></mrow></mi></msup></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned}\text{odds} P(Y=1|\boldsymbol{x}) &amp;= \frac{P(Y=1| \boldsymbol{x})}{P(Y=0|\boldsymbol{x})} \\               &amp;= e^{\boldsymbol{Wx}}\end{aligned}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:4.2163em;vertical-align:-1.8581em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.3581em;"><span style="top:-4.3581em;"><span class="pstrut" style="height:3.427em;"></span><span class="mord"><span class="mord text"><span class="mord">odds</span></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord">1∣</span><span class="mord"><span class="mord"><span class="mord boldsymbol">x</span></span></span><span class="mclose">)</span></span></span><span style="top:-2.2289em;"><span class="pstrut" style="height:3.427em;"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.8581em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.3581em;"><span style="top:-4.3581em;"><span class="pstrut" style="height:3.427em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord">0∣</span><span class="mord"><span class="mord"><span class="mord boldsymbol">x</span></span></span><span class="mclose">)</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord">1∣</span><span class="mord"><span class="mord"><span class="mord boldsymbol">x</span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span style="top:-2.2289em;"><span class="pstrut" style="height:3.427em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8933em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord boldsymbol mtight">Wx</span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.8581em;"><span></span></span></span></span></span></span></span></span></span></span></span></p><p>因此其 logit 为:</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mtext>logit</mtext><mi>P</mi><mo stretchy="false">(</mo><mi>Y</mi><mo>=</mo><mn>1</mn><mi mathvariant="normal">∣</mi><mi mathvariant="bold-italic">x</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mi>log</mi><mo>⁡</mo><mtext>odds</mtext><mi>P</mi><mo stretchy="false">(</mo><mi>Y</mi><mo>=</mo><mn>1</mn><mi mathvariant="normal">∣</mi><mi mathvariant="bold-italic">x</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mi><mrow><mi mathvariant="bold-italic">W</mi><mi mathvariant="bold-italic">x</mi></mrow></mi></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned}\text{logit} P(Y=1|\boldsymbol{x}) &amp;= \log \text{odds}  P(Y=1|\boldsymbol{x}) \\                             &amp;= \boldsymbol{Wx}\end{aligned}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:3em;vertical-align:-1.25em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.75em;"><span style="top:-3.91em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord text"><span class="mord">logit</span></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord">1∣</span><span class="mord"><span class="mord"><span class="mord boldsymbol">x</span></span></span><span class="mclose">)</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.25em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.75em;"><span style="top:-3.91em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord text"><span class="mord">odds</span></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord">1∣</span><span class="mord"><span class="mord"><span class="mord boldsymbol">x</span></span></span><span class="mclose">)</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord"><span class="mord"><span class="mord boldsymbol">Wx</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.25em;"><span></span></span></span></span></span></span></span></span></span></span></span></p><p>logit 最终可以表示成样本特征 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold-italic">x</mi></mrow><annotation encoding="application/x-tex">\boldsymbol{x}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4444em;"></span><span class="mord"><span class="mord"><span class="mord boldsymbol">x</span></span></span></span></span></span> 的线性回归（Linear Regression）模型，这是 LR 中 Regression 一词的由来。</p><p>在后面的章节中，我将详细介绍 LR 中各种 ”逻辑“ 的详细的来龙去脉。</p><h1>“逻辑” 词源</h1><p>首先看一下 “逻辑” 这个中文词的来源。</p><p>中文词 “逻辑” 是一个外来词, 由中国清末翻译家严复先生所创, 它是对英文词 <strong>logic</strong> 的音译.</p><p>&quot;逻辑&quot;一词后由中国传入日本, 读作 ロジック。 但在日语中则注明只是对Logic的注音，Logic在日语中的正式汉语翻译词为“论理”（ろんり）。</p><p>logic 还有一个很好的意译：“理则”，这是由孙中山先生所译。孙中山先生<a href="http://www.sunyat-sen.org/index.php?m=content&amp;c=index&amp;a=show&amp;catid=46&amp;id=6662">《建国方略.以作文为证》</a>中：“然则逻辑究为何物？当译以何名而后妥……吾以为当译之为‘理则’者也……学者之对于理则之学，则大都如陶渊明之读书，不求甚解而已。”</p><p>现代汉语中，“逻辑” 有四种常见含义:</p><ol><li>指客观事物的规律。例如：“历史的逻辑决定了人类社会将一直向前发展”</li><li>指某种特殊的理论、观点或看问题的方法。例如：“侵略者奉行的是强盗逻辑”</li><li>指思维的规律、规则。例如：“写文章要讲逻辑”</li><li>指逻辑学这门科学。例如：“大学生要学点逻辑”</li></ol><h1>logic 的含义</h1><p>前面讲到，中文词 ”逻辑“ 是英文单词 ”logic“ 的音译。 我们再详细探究一下英文词 ”logic“ 的含义和来源。</p><p>柯林斯词典对 logic 给出了三个解释:</p><ul><li><strong>Logic</strong> is a method of reasoning that involves <strong>a series of statements</strong>, each of which must be true if the statement before it is true. 逻辑 (学)</li><li>The <strong>logic</strong> of a conclusion or an argument is <strong>its quality of being correct and reasonable</strong>. (结论或观点的) 逻辑<ul><li>eg. I don’t follow the logic of your argument.</li></ul></li><li>A particular kind of <strong>logic</strong> is the way of thinking and reasoning about things that is characteristic of a particular type of person or particular field of activity. (某种人或某行为领域的) 逻辑<ul><li>eg. The plan was based on sound commercial logic.  (商业逻辑)</li></ul></li></ul><p>logic 从词源上看,</p><blockquote><ul><li>mid-14c., <strong>logike</strong>, “branch of philosophy that treats of forms of thinking; the science of distinction of true from false reasoning,”</li><li>from Old French <strong>logique</strong> (13c.),</li><li>from Latin <strong>(ars)logica</strong> “logic,”</li><li>from Greek <strong>(he)logike (techne)</strong>  “(the) reasoning (art),”</li><li>from fem. of <strong>logikos</strong> “pertaining to speaking or reasoning” (also “of or pertaining to speech”),</li><li>from <strong>logos</strong> “reason, idea, word” (see Logos).</li><li>Formerly also <strong>logick</strong>.</li></ul><p>Sometimes formerly plural, as in ethics, but this is not usual.</p><ul><li>Meaning “logical argumentation” is from c. 1600. Contemptuous logic-chopper “sophist, person who uses subtle distinctions in argument” is from 1846.</li></ul></blockquote><h1>Logistic 函数</h1><p>此处主要参考 <a href="https://en.wikipedia.org/wiki/Logistic_function">Wikipedia: Logistic function</a>.</p><p>Logistic Function 是比利时数学家 <a href="https://en.wikipedia.org/wiki/Pierre_Fran%C3%A7ois_Verhulst">Pierre François Verhulst</a>在 1838 ~ 1847 的三篇论文中提出的, 其目的是通过调整指数增长模型, 对人口增长函数进行建模. Logistic 很好的解释了人口增长模型的三个阶段:</p><ul><li>指数增长阶段: 在初始阶段, 人口呈现几何增长趋势</li><li>线性增长阶段: 随着逐渐饱和, 增长曲线放缓至线性增长</li><li>滞胀阶段: 在成熟阶段, 人口停止增长</li></ul><p>你可以从 Logistic 函数的函数图像上获得更直观的感受.</p><p>Verhulst 在 30 年代设计了该函数, 并于 1838 年发表了一个简短说明; 1844年进一步分析了该函数, 并给出正式命名 (对应论文则是 1845 年发表的).</p><blockquote><p><strong>Logistic 函数名字由来</strong><br>Verhulst 在1845年发表的论文中将该曲线命名为 <strong>logistic</strong>, 但是并没有解释原因. 从这一点上看,Verhulst 实在不讲逻辑了 (a pun) !<br>参考 <a href="https://www.quora.com/How-did-a-%E2%80%9Clogistic-equation%E2%80%9D-get-its-name-Does-logistic-mean-logical-or-logistic-work">Quora: How did “logistic equation” get its name?</a></p></blockquote><p>Logistic 函数的数学表达式如下</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mfrac><mi>L</mi><mrow><mn>1</mn><mo>+</mo><msup><mi>e</mi><mrow><mo>−</mo><mi>k</mi><mo stretchy="false">(</mo><mi>x</mi><mo>−</mo><msub><mi>x</mi><mn>0</mn></msub><mo stretchy="false">)</mo></mrow></msup></mrow></mfrac></mrow><annotation encoding="application/x-tex">f(x) = \frac{L}{1 + e ^ {-k (x - x_0)}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.1477em;vertical-align:-0.7873em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3603em;"><span style="top:-2.296em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.814em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mopen mtight">(</span><span class="mord mathnormal mtight">x</span><span class="mbin mtight">−</span><span class="mord mtight"><span class="mord mathnormal mtight">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3173em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">L</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.7873em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p><p>其中,</p><ul><li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">x_0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 是 S 曲线的中点 (mid-point)</li><li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi></mrow><annotation encoding="application/x-tex">L</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">L</span></span></span></span> 是曲线的最大值</li><li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> 为曲线的增长率 (或称为陡度)</li></ul><p>当 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mn>0</mn></msub><mo>=</mo><mn>0</mn><mo separator="true">,</mo><mi>L</mi><mo>=</mo><mn>1</mn><mo separator="true">,</mo><mi>k</mi><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">x_0 = 0, L = 1, k = 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">L</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span> 时, 称之为 <strong>标准逻辑函数</strong> (Standard Logistic Function), 其表达式及函数图像如下:</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mfrac><mn>1</mn><mrow><mn>1</mn><mo>+</mo><msup><mi>e</mi><mrow><mo>−</mo><mi>x</mi></mrow></msup></mrow></mfrac></mrow><annotation encoding="application/x-tex">f(x) = \frac{1}{1 + e^{-x}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.0908em;vertical-align:-0.7693em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6973em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mathnormal mtight">x</span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.7693em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p><p><img src="/2022/11/24/brief-intro-to-logit/Logistic-curve.svg.png" alt="标准逻辑回归函数" srcset="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20300%20300'%3E%3C/svg%3E" data-src="/2022/11/24/brief-intro-to-logit/Logistic-curve.svg.png" class="lozad post-image"></p><h1>logistic 词源探秘: 一些有趣的小知识</h1><p>前面提到, logistic function 中 logistic 是 Verhulst 命名的, 并且并没有给出使用 “logistic” 一词的理由.</p><p>logistic 函数到底跟 logistic 的本义有什么联系呢? 能不能从 logistic 的本义上引申出 logistic 函数的某些性质呢?</p><p>我们带着疑问, 查一下 logistic 的本义。以下是柯林斯大词典给出的解释:</p><blockquote><p>ADJ. <strong>Logistic</strong> or <strong>logistical</strong> means relating to the organization of something complicated. “物流的, 后勤的”<br>eg.</p><ol><li>Logistical problems may be causing the delay. 物流问题可能会造成延期</li><li>She described the distribution of food and medical supplies as a logistical nightmare. 她将食品和医疗用品的分发描述为后勤噩梦。</li></ol></blockquote><p>咦? 怎么跟 “物流, 后勤” 扯上关系了? 再查!</p><p>下面是剑桥英汉词典给出的解释:</p><blockquote><p>ADJ. relating to the careful organization of a complicated activity. “后勤的”<br>egs.</p><ol><li>logistical support / problems, 后勤支持 / 问题</li><li>Assigning an armed federal officer to every commercial flight would be a logistical nightmare. 为每一次民用航班配备一名武装联邦军人将是一场后勤噩梦。</li></ol></blockquote><p>等等, 我们不是在搞 “逻辑” 吗? 咋跟 后勤和物流杠上了？”逻辑&quot; 哪去了?</p><p>柯林斯词典还给出了一些其它解释:</p><blockquote><ol><li>N. an uninterpreted calculus or system of symbolic logic Compare formal language</li><li>ADJ, mathematics. (of a curve) having an equation of the form <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi><mo>=</mo><mi>k</mi><mi mathvariant="normal">/</mi><mo stretchy="false">(</mo><mn>1</mn><mo>+</mo><msup><mi>e</mi><mrow><mi>a</mi><mo>+</mo><mi>b</mi><mi>x</mi></mrow></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">y = k / (1 + e^{a + bx})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord">/</span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.0991em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="mbin mtight">+</span><span class="mord mathnormal mtight">b</span><span class="mord mathnormal mtight">x</span></span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>, where <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi></mrow><annotation encoding="application/x-tex">b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">b</span></span></span></span> is less than zero</li><li>ADJ, rare. of, relating to, or skilled in arithmetical calculations.</li></ol><p><strong>Word origin</strong><br>C17: via French, from Late Latin logisticus of calculation, from Greek logistikos rational, from logos word, reason</p></blockquote><p>对于这些解释, 我的个人观点是: 这恐怕是 Verhulst 的 logistic function 这只鸡下的蛋呀!</p><p>既然都查了这么多了, 我们还是有始有终, 完整的查一下 logistic 这个词的词源关系和构词结构吧.</p><h2 id="logistic-词源">logistic 词源</h2><p>logistic, 也可以写作 logistical, 是一个形容词, 其含义是 “relating to the <strong>careful</strong> organization of a <strong>complicated</strong> activity”, 中文解释为 “后勤的”.</p><p>logistic 从词源上看,</p><blockquote><ul><li>“pertaining to logic,” 1620s, from Medieval Latin <strong>logisticus</strong>,</li><li>from Greek <strong>logistikos</strong> “skilled in calculating; endued with reason,” from logistes “a calculator,”</li><li>from <strong>logos</strong> “calculation, proportion” (see Logos).</li></ul><p>Related: Logistical (1560s); logistically.</p><p><strong>Logistics</strong>, from this word, in the sense “art of arithmetical calculation” is from 1650s.</p></blockquote><p>logistic 从构词上看, <code>log- + -istic</code>, 由词根 <code>log-</code> (表示 “说话”, 引申为 “学说”) 和 形容词后缀 <code>-istic</code> (表示 “…的”).  <code>-istic</code> 是一个符合后缀, 由 <code>-ist + -ic</code> 构成.</p><h2 id="log-词根"><code>log-</code> 词根</h2><p><code>log-</code> 词根表示 “说话, 推理, 计算”, 源自希腊词汇 log (means “word”), 引申为 “学说” (常用词根 <code>-logy</code> 表示 (means “study of”), 如 biology, mythology).</p><p>源于该词根的单词示例如下:</p><ul><li>log: book of “words”, 日记, 日志</li><li>catalog: listing of “words”, 目录</li><li>dialogue: “words” between people, 对话</li><li>monologue: “words” of one person, 独白</li><li>prologue: “words” beforehand, 前言, 开场白, 引子, 序</li><li>epilogue: after “words”, 收场白, 后记, 跋</li><li>logophile: “words” lover, 爱好词语的人</li><li>logprrhea: “word” diarrhea, 多言症, 速语癖</li><li>biology: “study” of life, 生物学</li><li>zoology: “study” of animals, 动物学</li><li>etymology: “study” of the origin of words, 词源学</li><li>genealogy: “study” of one’s family history, 家谱(学), 宗谱(学)</li></ul><p>logic 虽然与 logistic 属于同根词, 但是其相对于词根 <code>log-</code> 的本意已经相去甚远了.</p><h2 id="Logistics-物流-后勤">Logistics, 物流 / 后勤</h2><p>我们回过头来看 logistic 的本义吧.</p><p>前面提到, logistic 的本义是 “relating to the organization of something complicated”, 中文一般翻译为 “物流的, 后勤的”.</p><p>Logistic 有个复数名词形式: logistics, 其英文含义是 “the careful organization of a complicated activity so that it happens in a successful and effective way”, 中文翻译为 “后勤, 物流; 物流学, 后勤学”.</p><p>中文词 “后勤” 还是从日语借过来的.</p><p>鉴于中国和日本的一千多年的文化交流和恩怨纠葛, 现代汉语中有大量的日语借词, 比如 xx主义 / 萝莉 / 便当 / 经济 / 世界, 等等.</p><blockquote><p><strong>日语借词</strong><br>汉语中的日语借词指汉语由日语引入的借词。是华语圈与日语圈之间语言交流的一部分。汉语从日本借用辞汇发生在近代，主要以汉字为媒介。日语借词对现代汉语的形成有重要的作用。<br>具体来讲, 现代汉语中的日语借词有如下几类:</p><ol><li><strong>和制汉语,</strong> 又称“日源汉词”、“和来语”，是指现代汉语中从日语借用的新词。它又分为如下三种类型:<ul><li>日本自制汉语词, 如: 电话, 干部, 艺术, 肯定, 否定, 假设, 直接, 海拔, 航空母舰 等</li><li>源自汉语,但被日本人赋予新意的汉语词, 如: 社会, 经济 等. (一些学者称之为 “回归词”)</li><li>汉语古已有之, 且在日语中意义变化不大, 这一类可以认为不属于日语借词, 但常被人误以为来自日语。如：革命、政府、封建、科学、纪律 等</li></ul></li><li><strong>来源于 “宛字” 的词</strong>，“宛字”，日语“当て字／宛て字”。日语传统上多用汉字，有时非汉语词也利用汉字的读音（音读与训读皆可能用到）以汉字纪录，如“滅茶苦茶（めちゃくちゃ）”。这种做法类似于六书的假借，但为区别于中国的假借，本文称之为“宛字”。分为两类：<ul><li>来源于和语宛字的词，较少，例如：寿司（すし）</li><li>来源于外来语宛字的词，如：クラブ“倶乐部”、ロマン“浪漫”、ガス“瓦斯”、コンクリート“混凝土”、リンパ“淋巴”等</li></ul></li><li><strong>和语词以汉字写法引入</strong>，绝大部分的和语的人名、地名等专有名词是以汉字写法而非读音直接引入汉语。部分一般辞汇亦以汉字写法直接引入汉语，如：取消(取り消し)、场合(ばあい)、立场(たちば)、手续(てつづき)、出口(でぐち)、入口(いりぐち)、取缔(とりしまり)、见习(みならい)等</li><li><strong>日语自身读法的音译</strong>，此类词汇多是日语本身非以汉字表达的词汇，但华人习惯于以汉字引入日本辞汇（包括专有名词），所以以音译方式输入了若干日本词。如“卡拉OK”（カラオケ），“榻榻米”（畳）等。商标的例子较多，如“马自达”（マツダ，松田）、“日产”的俗名“尼桑”、“立邦漆”（Nippon Paint）等。</li><li><strong>流通于台湾的日语借词</strong>，如“便当（弁当）”、“欧巴桑（おばさん）”、“秀逗（ショート）”。不少在战后已被国语词汇取代并以台语读之。但现今尚有“水道水 tsuí-tō-tsuí（自来水）”、“注射 tsù-siā（打针）”、“注文 tsù-bûn（订购）”、“案内 àn-nāi（带路）”、“看板 khang-pang（招牌）”，甚至外来语如“oo-tó-bái（オートバイ，摩托车）”、“bì-lù（ビール，啤酒）”、“jiàn-bà（ジャンパー，夹克）”、和语如“a-sá-lih（あっさり，果断）”“oo-bá-sáng（おばさん，阿姨）”“sa-sí-mih（刺身，生鱼片）”</li><li><strong>日本流行文化引进的和制汉语</strong>，如 声优、女优、攻略、暴走、援交、人气等</li></ol><p>更多信息可以参考 <a href="https://zh.wikipedia.org/zh-sg/%E6%BC%A2%E8%AA%9E%E4%B8%AD%E7%9A%84%E6%97%A5%E8%AA%9E%E5%80%9F%E8%A9%9E">汉语中的日语借词</a> 以及 <a href="https://zhuanlan.zhihu.com/p/419407308">知乎: 日语借词为何在现代汉语中大行其道</a>.</p></blockquote><h3 id="“物流”-中的-“逻辑”">“物流” 中的 “逻辑”</h3><p>以下内容来自 <a href="https://en.wikipedia.org/wiki/Logistics">英文维基百科: Logistics</a> 和 <a href="https://zh.wikipedia.org/wiki/%E7%89%A9%E6%B5%81">中文维基百科: 物流</a>.</p><p><strong>物流（英语：Logistics）</strong>，是军事领域后勤概念的民间用语。</p><p>在西方该词语源于希腊语：λογιστικός, Logistikos，意为“计数科学”或“精于算计”。</p><p>“物流”是一套通过计算、策划来控制原材料、制成品、产成品或信息在供、需、仓储不同部之间转运的管理系统。“物流”或也可详称为其最终目的之“策略性物流运输”或“策运”。物质资料从供给者到需求者的物理运动，是创造时间价值、场所价值和一定的加工价值的活动。物流是指物质实体从供应者向需求者的物理移动，它由一系列创造时间价值和空间价值的经济活动组成，包括运输、保管、配送、包装、装卸、流通加工及处理等多项基本活动，是这些活动的统一。</p><p>相关概念最早出现于军事行政组织，在中国古代一直被称为辎重，后来在近代被逐渐改为后勤。</p><p>现代的“物流”概念最早可能是以在二战中，围绕战争物资供应，美军创建的后勤理论为原型的。当时的「后勤」是指将战时物资生产、采购、运输、配给等活动作为一个整体进行统一布置，以求战略物资补给的费用更低、速度更快、服务更好。后来，将“后勤”体系移植到现代经济生活中，才逐步演变为今天的物流。物流系统也可像互联网般，促进全球化。在贸易上，若要更进一步与世界连系，就得靠良好的物流管理系统。</p><p>市场上的商品很多是「游历」各国后才来到的。原料可能来自马来西亚和泰国，加工可能在新加坡，生产却在中国，最后才入口到美国。产品的「游历」路线就是由物流师计划、组织、指挥、协调、控制和监督，使各项物流活动实现最佳的协调与配合，以实现产品物流的目标，目标可能是：降低物流成本（cost），提高物流效率及质量（efficiency &amp; quality），或提高物流的供应满足性（availability）。目标可能会有取舍和侧重。</p><h3 id="logistics-词源">logistics 词源</h3><p>Logistics 是 logistic 的复数名词，从词源关系上看，两者也略有不同。</p><blockquote><ul><li>“art of moving, quartering, and supplying troops,” 1846,</li><li>from French <strong>(l’art)logistique</strong> “(art) of quartering troops,”, which apparently(据说) is<ul><li>from <strong>logis</strong> “lodging”<ul><li>from Old French <strong>logeiz</strong> “shelter for an army, encampment,” from loge</li></ul></li><li>Greek-derived suffix <strong>-istique</strong> (see -istic).</li></ul></li><li>The form in French was influenced by <strong>logistique</strong>, from the Latin source of English logistic.</li></ul></blockquote><h1>Logistic 分布</h1><p>当我们限定 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">L = 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">L</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span> 时, Logistic 函数是一条值域为 <code>(0, 1)</code> 的单调递增 S 曲线. 它实际上是 Logistic 分布的 累积分布函数 (Cumulative Distribution Function, CDF).</p><p>Logistic 分布的 累积分布函数 及 概率密度函数 的数学表达式 和 函数图像吐下:</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi>F</mi><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">;</mo><mi>μ</mi><mo separator="true">,</mo><mi>s</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mfrac><mn>1</mn><mrow><mn>1</mn><mo>+</mo><msup><mi>e</mi><mrow><mo>−</mo><mo stretchy="false">(</mo><mi>x</mi><mo>−</mo><mi>μ</mi><mo stretchy="false">)</mo><mi mathvariant="normal">/</mi><mi>s</mi></mrow></msup></mrow></mfrac></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">;</mo><mn>0</mn><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mfrac><msup><mi>e</mi><mrow><mo>−</mo><mi>x</mi></mrow></msup><mrow><mo stretchy="false">(</mo><mn>1</mn><mo>+</mo><msup><mi>e</mi><mrow><mo>−</mo><mi>x</mi></mrow></msup><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow></mfrac></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mi>F</mi><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">;</mo><mn>0</mn><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">)</mo><mo stretchy="false">[</mo><mn>1</mn><mo>−</mo><mi>F</mi><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">;</mo><mn>0</mn><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">)</mo><mo stretchy="false">]</mo></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned}F(x; \mu, s) &amp;= \frac{1}{1 + e^{-(x - \mu) / s}} \\f(x; 0, 1) &amp;= \frac{e^{-x}}{(1 + e^{-x})^2} \\           &amp;= F(x; 0, 1) [1 - F(x; 0, 1)]\end{aligned}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:6.5931em;vertical-align:-3.0466em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.5466em;"><span style="top:-5.6734em;"><span class="pstrut" style="height:3.4483em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">F</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mpunct">;</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">μ</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">s</span><span class="mclose">)</span></span></span><span style="top:-3.1378em;"><span class="pstrut" style="height:3.4483em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mpunct">;</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span><span style="top:-1.0618em;"><span class="pstrut" style="height:3.4483em;"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.0466em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.5466em;"><span style="top:-5.6734em;"><span class="pstrut" style="height:3.4483em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.296em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.814em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mopen mtight">(</span><span class="mord mathnormal mtight">x</span><span class="mbin mtight">−</span><span class="mord mathnormal mtight">μ</span><span class="mclose mtight">)</span><span class="mord mtight">/</span><span class="mord mathnormal mtight">s</span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.7873em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span style="top:-3.1378em;"><span class="pstrut" style="height:3.4483em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.4483em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6973em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mathnormal mtight">x</span></span></span></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7401em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7713em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mathnormal mtight">x</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span style="top:-1.0618em;"><span class="pstrut" style="height:3.4483em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">F</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mpunct">;</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">1</span><span class="mclose">)</span><span class="mopen">[</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">F</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mpunct">;</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">1</span><span class="mclose">)]</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.0466em;"><span></span></span></span></span></span></span></span></span></span></span></span></p><p><img src="/2022/11/24/brief-intro-to-logit/Logistic_cdf.svg.png" alt="累积分布函数" srcset="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20300%20300'%3E%3C/svg%3E" data-src="/2022/11/24/brief-intro-to-logit/Logistic_cdf.svg.png" class="lozad post-image"></p><p><img src="/2022/11/24/brief-intro-to-logit/Logistic_pdf.svg.png" alt="概率密度函数" srcset="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20300%20300'%3E%3C/svg%3E" data-src="/2022/11/24/brief-intro-to-logit/Logistic_pdf.svg.png" class="lozad post-image"></p><p>Logistic 分布的概率密度函数图像与正态分布相似, 但长尾分布更明显.</p><h1>logit</h1><p>从语义上讲, logit 是本文讨论的词语中离 “逻辑” 最远的词；但从字形上看，logit 与 logic 最相似。 我们把它放到最后来讲。</p><p>logit 是 Joseph Berkson 在 1944 年创造的一个词, 它是由 logistic + unit 构成的一个.</p><p>关于定义该术语的理由，作者的原话如下:</p><blockquote><p>“I use this term <strong>logit</strong> for <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle scriptlevel="0" displaystyle="true"><mi>ln</mi><mo>⁡</mo><mi>p</mi><mi mathvariant="normal">/</mi><mi>q</mi></mstyle></mrow><annotation encoding="application/x-tex">\displaystyle \ln p/q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mop">ln</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">p</span><span class="mord">/</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span></span></span></span> following Bliss, who called the analogous function which is linear on <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle scriptlevel="0" displaystyle="true"><mi>x</mi></mstyle></mrow><annotation encoding="application/x-tex">\displaystyle x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span> for the normal curve ‘probit.’”</p></blockquote><p>简单而言，logit 是类比 probit 创造出的一个词语. 如果非要给 logit 一个定义</p><ul><li>(mathematics) the logit function is the inverse of the sigmoid (logistic) function.</li></ul><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>logit</mtext><mo stretchy="false">(</mo><mi>p</mi><mo stretchy="false">)</mo><mo>=</mo><mi>log</mi><mo>⁡</mo><mo stretchy="false">(</mo><mfrac><mi>p</mi><mrow><mn>1</mn><mo>−</mo><mi>p</mi></mrow></mfrac><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\text{logit} (p) = \log (\frac{p}{1-p})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">logit</span></span><span class="mopen">(</span><span class="mord mathnormal">p</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.988em;vertical-align:-0.8804em;"></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mopen">(</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1076em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal">p</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.8804em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose">)</span></span></span></span></span></p><p>在统计学上, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mi>p</mi><mrow><mn>1</mn><mo>−</mo><mi>p</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">\frac{p}{1-p}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2286em;vertical-align:-0.4811em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7475em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mbin mtight">−</span><span class="mord mathnormal mtight">p</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.4461em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4811em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span> 也有专门的术语表示, 称之为 <strong>odds</strong>, 一般翻译为 “发生比, 胜算, 几率”, 所以 logit 有时也翻译成 <strong>对数比</strong> 或 <strong>对数几率</strong>.</p><blockquote><p><strong>probit</strong><br>probit 是 Bliss 在 1934 年的论文 “The method if probits” 中创造的词语, 它有两个含义:</p><ul><li>(statistics) A unit, derived from a standard distribution, used in measuring the response to doses</li><li>The probit function is the inverse of the cumulative distribution function</li></ul><p>probit 有时会翻译成 “概率单位”。在概率与统计学中，概率单位是与标准正态分布相关联的分位函数；在数学上，概率单位是标准正态分布的累积分布函数的反函数。</p></blockquote><h1>总结</h1><p>本文并不讨论 逻辑回归、逻辑函数、逻辑分布 的数学定义、证明、推导等，也不导论 LR 在风控、排序、CTR预估等任务上的应用。我们主要关注这些 ”逻辑“ 概念的来源。</p><p>从本文中你可以了解到：</p><ul><li>”逻辑“ 是一个外来词，是严复先生对英文词 ”logic“ 的音译</li><li>logistic function 是比利时数学家 Verhulst 对一类数学上的S曲线的命名。但是 Verhulst 并没有给出命名的理由，这是我们在 ”逻辑回归“、”逻辑函数“ 中难寻 ”逻辑“ 影踪的重要原因</li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;逻辑回归 (Logistic Regression, LR) 是一种经典的机器学习模型, 在很多机器学习任务(比如广告推荐, 推荐排序等)中, 都可以作为 baseline 模型使用.&lt;/p&gt;
&lt;p&gt;从名字上看, LR 包含 Logistic 和 Regression 两个</summary>
      
    
    
    
    <category term="Mathematics" scheme="https://loveychen.github.io/categories/Mathematics/"/>
    
    <category term="Probability" scheme="https://loveychen.github.io/categories/Mathematics/Probability/"/>
    
    
    <category term="Probability" scheme="https://loveychen.github.io/tags/Probability/"/>
    
    <category term="Mathematics" scheme="https://loveychen.github.io/tags/Mathematics/"/>
    
    <category term="logit" scheme="https://loveychen.github.io/tags/logit/"/>
    
    <category term="概率论" scheme="https://loveychen.github.io/tags/%E6%A6%82%E7%8E%87%E8%AE%BA/"/>
    
  </entry>
  
  <entry>
    <title>Memory Network 在对话系统中的应用</title>
    <link href="https://loveychen.github.io/2021/06/11/20210611-memory-network-for-ds/"/>
    <id>https://loveychen.github.io/2021/06/11/20210611-memory-network-for-ds/</id>
    <published>2021-06-11T06:58:16.000Z</published>
    <updated>2025-08-05T17:48:18.788Z</updated>
    
    <content type="html"><![CDATA[<p>本文是南洋理工大学2021年5月份的对话系统综述文章 <a href="http://arxiv.org/abs/2105.04387">Recent Advances in Deep Learning Based Dialogue Systems: A Systematic Survey</a> 2.4 节 <strong>Memory Network</strong> 的理解和展开.</p><h1>Memory Network 概述</h1><p>Memory Network 是 FAIR 的 Jason Weston 等人于 2014 年在论文 <a href="http://arxiv.org/abs/1410.3916">Memory Networks</a> 提出的一种神经网络框架, 它在通用的神经网络模型中增加了一个 Memory 模块, 用来记忆神经网络中需要经常使用(但又经常被遗忘)的信息. 对照起来看, Memory 之于神经网络, 类似于 海马体(hippocampus) 之于 大脑, 内存和硬盘 之于 计算机.</p><p>在此之前的神经网络中, 不管是 MLP, 还是 CNN 和 RNN, 都没有显式的定义记忆体. 尽管模型的隐层参数(如 RNN 的 hidden state, CNN 的卷积核) 能够记忆一些长期记忆, 但通常来说其记忆能力有限.</p><p>Memory Network 通过显式引入大小不限(当然受限于硬件环境)的记忆体, 显式定义记忆体中存储的内容, 并在模型训练和预测过程中(选择性)动态更新记忆, 增强了模型对重要信息的记忆和利用能力. 从作者在 QA (Question Answer) 任务上的实验结果来看, 记忆体可以较大地提升模型效果.</p><h2 id="MemNN">MemNN</h2><p>正式地, Memory Network 包括如下五个部分:</p><ul><li>Memory <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi></mrow><annotation encoding="application/x-tex">M</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span></span></span></span>: 记忆体. 可以认为是一个包含多个记忆单元的数组, 记忆单元的具体内容和形式, 则取决于具体的任务和设计. 为了行文方便, 下文中记忆体用符号 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi></mrow><annotation encoding="application/x-tex">M</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span></span></span></span> 表示, 其记忆单元用符号 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>m</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">m_{i}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 表示, 即 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mo>=</mo><mo stretchy="false">[</mo><msub><mi>m</mi><mn>0</mn></msub><mo separator="true">,</mo><msub><mi>m</mi><mn>1</mn></msub><mo separator="true">,</mo><mo>⋯</mo><mtext> </mtext><mo separator="true">,</mo><msub><mi>m</mi><mi>i</mi></msub><mo separator="true">,</mo><mo>⋯</mo><mtext> </mtext><mo separator="true">,</mo><msub><mi>m</mi><mrow><mi>N</mi><mo>−</mo><mn>1</mn></mrow></msub><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">M = [m_0, m_1, \cdots, m_i, \cdots, m_{N-1}]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner">⋯</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner">⋯</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mclose">]</span></span></span></span>.</li><li>Input Map <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>I</mi></mrow><annotation encoding="application/x-tex">I</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">I</span></span></span></span>: 输入特征提取器. 设原始输入为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span>, 则输入 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo>=</mo><mi>I</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f = I(x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span> 可以提取对应的输入数据特征 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi></mrow><annotation encoding="application/x-tex">f</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span></span></span></span></li><li>Generalization <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>G</mi></mrow><annotation encoding="application/x-tex">G</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">G</span></span></span></span>: 记忆生成器. 基于新的输入特征, 获取新的记忆表示, 插入记忆体或更新相关的记忆单元. 数学表示为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mo>=</mo><mi>G</mi><mo stretchy="false">(</mo><mi>f</mi><mo separator="true">,</mo><mi>M</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">M = G(f, M)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">G</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mclose">)</span></span></span></span>, 或</li></ul><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>m</mi><mi>i</mi></msub><mo>=</mo><mi>G</mi><mo stretchy="false">(</mo><msub><mi>m</mi><mi>i</mi></msub><mo separator="true">,</mo><mi>f</mi><mo separator="true">,</mo><mi>M</mi><mo stretchy="false">)</mo><mo separator="true">,</mo><mi mathvariant="normal">∀</mi><mi>i</mi><mo>∈</mo><mo stretchy="false">{</mo><mn>0</mn><mo separator="true">,</mo><mn>1</mn><mo separator="true">,</mo><mo>⋯</mo><mtext> </mtext><mo stretchy="false">}</mo></mrow><annotation encoding="application/x-tex">m_i = G(m_i, f, M), \forall i \in \{0, 1, \cdots\}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">G</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">∀</span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">{</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner">⋯</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mclose">}</span></span></span></span></span></p><ul><li>Output Map <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi></mrow><annotation encoding="application/x-tex">O</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span></span></span></span>: 输出特征提取器. 数学表示为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>o</mi><mo>=</mo><mi>O</mi><mo stretchy="false">(</mo><mi>f</mi><mo separator="true">,</mo><mi>M</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">o = O(f, M)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">o</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mclose">)</span></span></span></span>. 注意, 这里的记忆体 M 已经被更新过.</li><li>Response <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi></mrow><annotation encoding="application/x-tex">R</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span></span></span></span>: 响应器. 数学表示为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi><mo>=</mo><mi>R</mi><mo stretchy="false">(</mo><mi>o</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">r = R(o)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mopen">(</span><span class="mord mathnormal">o</span><span class="mclose">)</span></span></span></span>. 这个与具体的任务有关.</li></ul><p>Memory Network 是一种模型框架, 其各个部分均可以自由设计. 在 Jason Weston 2014 年的原始论文中, 作者设计了一个 MemNN 模型, 用来解决 QA 问题.</p><ul><li>MemNN 的使用了只插入不更新的记忆体, 记忆单元保存原始输入 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span>, 可以是一个描述事实的句子 (如 <em>“Joe travelled to the office.”</em>), 也可以是对应的问题 (如 <em>“Where was Joe before the office?”</em>). 记忆生成器 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>G</mi></mrow><annotation encoding="application/x-tex">G</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">G</span></span></span></span> 的工作模式为</li></ul><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>m</mi><mrow><mi>k</mi><mo>+</mo><mn>1</mn></mrow></msub><mo>=</mo><mi>x</mi></mrow><annotation encoding="application/x-tex">m_{k+1} = x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6389em;vertical-align:-0.2083em;"></span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span></span></p><p>其中 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> 为当前已经使用的记忆单元个数.</p><ul><li>MemNN 的特征提取器 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>I</mi></mrow><annotation encoding="application/x-tex">I</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">I</span></span></span></span> 使用了 BoW 特征.</li><li>MemNN 的输出特征提取器 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi></mrow><annotation encoding="application/x-tex">O</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span></span></span></span> 和 响应器 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi></mrow><annotation encoding="application/x-tex">R</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span></span></span></span> 均使用了相似度排序模型.</li></ul><p>其输出特征提取器 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi></mrow><annotation encoding="application/x-tex">O</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span></span></span></span> 会从记忆体中提取两个最相关的记忆单元:</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><msub><mi>o</mi><mn>1</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><munder><mrow><mi mathvariant="normal">arg max</mi><mo>⁡</mo></mrow><mrow><msub><mi>m</mi><mi>i</mi></msub><mo>∈</mo><mi>M</mi></mrow></munder><msub><mi>S</mi><mi>O</mi></msub><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">,</mo><msub><mi>m</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><msub><mi>o</mi><mn>2</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><munder><mrow><mi mathvariant="normal">arg max</mi><mo>⁡</mo></mrow><mrow><msub><mi>m</mi><mi>i</mi></msub><mo>∈</mo><mi>M</mi></mrow></munder><msub><mi>S</mi><mi>O</mi></msub><mo stretchy="false">(</mo><mo stretchy="false">[</mo><mi>x</mi><mo separator="true">,</mo><msub><mi>o</mi><mn>1</mn></msub><mo stretchy="false">]</mo><mo separator="true">,</mo><msub><mi>m</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned}o_1 &amp;= \argmax_{m_i \in M} S_{O} (x, m_i) \\o_2 &amp;= \argmax_{m_i \in M} S_{O} ([x, o_1], m_i)\end{aligned}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:4.3577em;vertical-align:-1.9289em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.4289em;"><span style="top:-4.5889em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">o</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">o</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.9289em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.4289em;"><span style="top:-4.5889em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.4306em;"><span style="top:-2.1612em;margin-left:0em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mrel mtight">∈</span><span class="mord mathnormal mtight" style="margin-right:0.10903em;">M</span></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span><span class="mop"><span class="mord mathrm" style="margin-right:0.01389em;">arg</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathrm">max</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.0389em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">O</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.4306em;"><span style="top:-2.1612em;margin-left:0em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mrel mtight">∈</span><span class="mord mathnormal mtight" style="margin-right:0.10903em;">M</span></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span><span class="mop"><span class="mord mathrm" style="margin-right:0.01389em;">arg</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathrm">max</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.0389em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">O</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">([</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">o</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">]</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.9289em;"><span></span></span></span></span></span></span></span></span></span></span></span></p><p>响应器采用了类似的方式.</p><p>MemNN 最主要的问题是, 模型使用的 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">arg max</mi><mo>⁡</mo></mrow><annotation encoding="application/x-tex">\argmax</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mop"><span class="mord mathrm" style="margin-right:0.01389em;">arg</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathrm">max</span></span></span></span></span> 是不可导的, 因此不能采用端到端的训练方法.</p><h2 id="MemN2N">MemN2N</h2><p>FAIR 在 2015 年的论文 <a href="http://arxiv.org/abs/1503.08895">End-To-End Memory Networks</a> 提出了 MemN2N 模型, 将 MemNN 改造为 End2End 方式.</p><p>相对于 MemNN, MemN2N 的主要改动在输出特征提取器 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi></mrow><annotation encoding="application/x-tex">O</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span></span></span></span> 的设计上. 与 MemNN 使用 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">arg max</mi><mo>⁡</mo></mrow><annotation encoding="application/x-tex">\argmax</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mop"><span class="mord mathrm" style="margin-right:0.01389em;">arg</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathrm">max</span></span></span></span></span> 不同, MemN2N 使用了可导的 Softmax 函数, 其输出计算如下:</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><msub><mi>p</mi><mi>i</mi></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mtext>Softmax</mtext><mo stretchy="false">(</mo><msup><mi>μ</mi><mi>T</mi></msup><msub><mi>m</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mi>o</mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><munder><mo>∑</mo><mi>i</mi></munder><msub><mi>p</mi><mi>i</mi></msub><msub><mi>c</mi><mi>i</mi></msub></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned}p_i &amp;= \text{Softmax}(\mu^{T} m_i) \\o &amp;= \sum_{i} p_i c_i\end{aligned}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:4.179em;vertical-align:-1.8395em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.3395em;"><span style="top:-4.4982em;"><span class="pstrut" style="height:3.05em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.7882em;"><span class="pstrut" style="height:3.05em;"></span><span class="mord"><span class="mord mathnormal">o</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.8395em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.3395em;"><span style="top:-4.4982em;"><span class="pstrut" style="height:3.05em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord text"><span class="mord">Softmax</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">μ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-2.7882em;"><span class="pstrut" style="height:3.05em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.05em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.8395em;"><span></span></span></span></span></span></span></span></span></span></span></span></p><p>其中记忆单元 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>m</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">m_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 是对应输入 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">x_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> (一个描述事实的句子) 的稠密向量表示, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>μ</mi></mrow><annotation encoding="application/x-tex">\mu</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">μ</span></span></span></span> 对应当前输入的问题 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>q</mi></mrow><annotation encoding="application/x-tex">q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span></span></span></span> 的向量表示 (与 x 的编码矩阵可能不同), <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>c</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">c_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 又是 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">x_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 对应的另一个稠密向量表示. 这里使用了三个不同的嵌入矩阵, 讲起来有点绕. 事实上, 作者也有尝试过上面三个向量表示方法使用同一个嵌入矩阵的情形.</p><p>对应的响应器 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi></mrow><annotation encoding="application/x-tex">R</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span></span></span></span> 也不再使用排序的方法, 而改成了分类器的方式 (作者简化了 QA 问题, 假设答案只包括一个单词), 数学表示如下:</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>r</mi><mo>=</mo><mtext>Softmax</mtext><mo stretchy="false">(</mo><mi>W</mi><mo stretchy="false">(</mo><mi>o</mi><mo>+</mo><mi>u</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">r = \text{Softmax}(W (o + u))</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">Softmax</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mopen">(</span><span class="mord mathnormal">o</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">u</span><span class="mclose">))</span></span></span></span></span></p><h2 id="MemN2N-与-Attention-的关系">MemN2N 与 Attention 的关系</h2><p>我们从上面的输出特征提取过程可以很容易联想到 Attention, 因为两者的计算过程实在太相似了.</p><p>以 Dzmitry Bahdanau 等人 2014 年在论文 <a href="http://arxiv.org/abs/1409.0473">Neural machine translation by jointly learning to align and translate</a> 给出的 Attention 计算过程作为对比:</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><msub><mi>e</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mi>a</mi><mo stretchy="false">(</mo><msub><mi>s</mi><mrow><mi>i</mi><mo>−</mo><mn>1</mn></mrow></msub><mo separator="true">,</mo><msub><mi>h</mi><mi>j</mi></msub><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><msub><mi>α</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mtext>Softmax</mtext><mo stretchy="false">(</mo><msub><mi>e</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><msub><mi>c</mi><mi>i</mi></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><munderover><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>1</mn></mrow><msub><mi>T</mi><mi>x</mi></msub></munderover><msub><mi>α</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><msub><mi>h</mi><mi>j</mi></msub></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned}e_{ij} &amp;= a(s_{i-1}, h_j) \\\alpha_{ij} &amp;= \text{Softmax}(e_{ij}) \\c_i &amp;= \sum_{j=1}^{T_x} \alpha_{ij} h_j\end{aligned}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:6.5532em;vertical-align:-3.0266em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.5266em;"><span style="top:-6.526em;"><span class="pstrut" style="height:3.8394em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span><span style="top:-5.026em;"><span class="pstrut" style="height:3.8394em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.5266em;"><span class="pstrut" style="height:3.8394em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.0266em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.5266em;"><span style="top:-6.526em;"><span class="pstrut" style="height:3.8394em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord mathnormal">a</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-5.026em;"><span class="pstrut" style="height:3.8394em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord text"><span class="mord">Softmax</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-2.5266em;"><span class="pstrut" style="height:3.8394em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8394em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3111em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1645em;"><span style="top:-2.357em;margin-left:-0.1389em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.4138em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.0266em;"><span></span></span></span></span></span></span></span></span></span></span></span></p><p>无论是 MemN2N 还是 Attention, 都是通过概率分布的方式找到与当前关注点最相关的信息. MemN2N 的当前关注点是 Query, 相关信息是 Query 之前的事实描述. Attention 中的当前关注点是隐状态 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>s</mi><mrow><mi>i</mi><mo>−</mo><mn>1</mn></mrow></msub></mrow><annotation encoding="application/x-tex">s_{i-1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6389em;vertical-align:-0.2083em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span></span></span></span>, 而相关信息是编码器输出的序列矩阵表示.</p><p>事实上, 还有一些 Transformer 的后续研究 (应该是之前在知乎上看到的介绍, 但是现在找不到具体的知乎帖子及对应的原始论文了, 后续补上) 称, 将 Transformer 中 Self-Attention 对应的 Q 和 K, 或者其计算结果替换成一个随机初始化的矩阵变量 (还是直接将系数 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>α</mi></mrow><annotation encoding="application/x-tex">\alpha</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">α</span></span></span></span> 作为变量学习, 记不清楚了), 也能够达到 Self-Attention 类似的效果. 这里想表达的是, 不管是显式定义的 Memory, 还是通过 Q 和 K 计算得到的 Score, 甚至是随机初始化的 Score 向量, 都为模型提供了额外的记忆信息, 都能给模型带来效果提升, Memory 和 Attention 没有本质的区别.</p><h1>Memory Network 在对话系统中的应用</h1><p>这里先把 <a href="http://arxiv.org/abs/2105.04387">Recent Advances in Deep Learning Based Dialogue Systems: A Systematic Survey</a> 罗列的一些研究工作简单梳理一下, 后续再逐一展开.</p><ul><li><p><a href="https://arxiv.org/abs/1911.09969">Chen et al. (2019c): The JDDC corpus: A large-scale multi-turn chinese dialogue dataset for e-commerce customer service</a><br>作者认为, 将对话历史和知识库混合在同一个 Memory 中可能影响答复的质量, 因此作者设计了包含三个记忆体的 TOD 系统: 两个长期记忆体, 分别存储对话历史 和 知识库; 一个工作记忆体记忆两个概率分布并控制 Response 生成.</p></li><li><p><a href="https://www.aclweb.org/anthology/2020.emnlp-main.281/">He et al. (2020a): Amalgamating knowledge from two teachers for task-oriented dialogue system with adversarial training</a><br>作者提出了一种 “Two-Teacher-One-Student” TOD 系统, 该框架的学生模型使用了 Memory Network. 作者首先使用强化学习方法训练两个 Teacher 模型, 然后使用 GAN 训练方法来训练学生模型.</p></li><li><p><a href="https://arxiv.org/abs/1911.03906">Kim et al. (2019): Efficient dialogue state tracking by selectively overwriting memory</a><br>论文作者主要关注 DST (Dialog State Tracking) 问题. 作者使用 Memory 来记忆对话状态, 在更新记忆时, 作者会(通过模型)主动选择需要被更新的记忆单元(对话状态).</p></li><li><p><a href="https://www.aclweb.org/anthology/2020.acl-main.57/">Dai et al. (2020): Learning low-resource end-to-end goal-oriented dialog for fast and reliable system deployment</a><br>作者使用了 MemN2N 模型作为 Utterance 编码器, 其记忆体主要用于记录对话历史和已经存在的响应, 然后使用 <strong>MAML(Model-Agnostic Meta-Learning, 模型无关的元学习)</strong> 方法训练模型在 Few-shot 情形下找到正确的响应.</p></li><li><p><a href="https://www.aclweb.org/anthology/P19-1371/">Tian et al. (2019): Learning to abstract for memory-augmented conversational response generation</a><br>作者使用 Memory Network 记忆 Query-Response 对, 在生成答复时同时参考输入 Query 和 Memory.</p></li><li><p><a href="https://arxiv.org/abs/1906.06050">Xu et al. (2019): Neural response generation with metawords</a><br>作者在 Memory 中记录 Meta-Words (用于描述响应的短语), 生成答复时同时考虑 User Utterance 和 Meta-Words.</p></li><li><p><a href="https://arxiv.org/abs/1902.00579">Gan et al. (2019): Multi-step reasoning via recurrent dual attention for visual dialog</a><br>论文使用了 对话历史记忆体 和 视觉记忆体, 可以执行多步推理 (Multi-Step Reasoning).</p></li><li><p><a href="https://arxiv.org/abs/1903.06164">Han et al. (2019): Episodic memory reader: Learning what to remember for question answering from streaming data</a><br>当 Memory 被占满时, 论文提出了一种强化学习方法来选择需要被替换的记忆单元, 这解决了 Memory Network 的扩展性问题.</p></li><li><p><a href="https://arxiv.org/abs/2005.12484">Gao et al. (2020c): Explicit memory tracker with coarse-to-fine reasoning for conversational machine reading</a><br>作者是为了解决 Memory Network 的扩展性问题, 他们使用了 EMT (Explicit Memory Tracker) 来判断记忆是否足够(不再扩张), 并使用了 coarse-to-fine 策略提出澄清问题(clarification questions) 以获得更多的信息来完善推理过程.</p></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;本文是南洋理工大学2021年5月份的对话系统综述文章 &lt;a href=&quot;http://arxiv.org/abs/2105.04387&quot;&gt;Recent Advances in Deep Learning Based Dialogue Systems: A Systemati</summary>
      
    
    
    
    <category term="对话系统" scheme="https://loveychen.github.io/categories/%E5%AF%B9%E8%AF%9D%E7%B3%BB%E7%BB%9F/"/>
    
    
    <category term="对话系统" scheme="https://loveychen.github.io/tags/%E5%AF%B9%E8%AF%9D%E7%B3%BB%E7%BB%9F/"/>
    
    <category term="Memory Network" scheme="https://loveychen.github.io/tags/Memory-Network/"/>
    
  </entry>
  
  <entry>
    <title>ConvLab2 03. TRADE - Transferable Dialogue State Generator</title>
    <link href="https://loveychen.github.io/2021/04/23/intro-convlab2-dst-trade/"/>
    <id>https://loveychen.github.io/2021/04/23/intro-convlab2-dst-trade/</id>
    <published>2021-04-23T02:28:40.000Z</published>
    <updated>2025-08-05T17:48:18.794Z</updated>
    
    <content type="html"><![CDATA[<p>对话状态追踪 (Dialogue State Tracking, DST) 是任务型对话系统 (Task-Oriented Dialogue System, TOD) 的核心模块.</p><p>DST 的目标是 提取用户目标 (User Goal) 和 意图, 并将其编码为 对话状态 (Dialogue State). 所谓 Dialogue State, 是一组 <strong>意图-槽位-槽位值</strong> 组合.</p><blockquote><p>在单领域对话系统 (Single-Domain TOD) 中, Dialogue State 可以表示为 <code>&lt;Intent, Slot, Value&gt;</code> 组成的集合;<br>在多领域对话系统 (Multi-Domain TOD) 中, 需要将 Domain 加入对话状态中, 即对话状态为 <code>&lt;Domain, Intent, Slot, Value&gt;</code> 四元组组成的集合.<br>为了表述上的方便, 可以认为对话状态由 <code>&lt;Domain-Intent, Slot, Value&gt;</code> 三元组组成.</p></blockquote><p>下面是一个对话状态的示例:</p><pre class="shiki shiki-themes everforest-light everforest-dark" style="background-color:#fdf6e3;--shiki-dark-bg:#2d353b;color:#5c6a72;--shiki-dark:#d3c6aa" tabindex="0"><code><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">[</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">    (</span><span style="color:#DFA000;--shiki-dark:#DBBC7F">"restaurant-inform"</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">, </span><span style="color:#DFA000;--shiki-dark:#DBBC7F">"price"</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">, </span><span style="color:#DFA000;--shiki-dark:#DBBC7F">"cheap"</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">),</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">    (</span><span style="color:#DFA000;--shiki-dark:#DBBC7F">"restaurant-inform"</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">, </span><span style="color:#DFA000;--shiki-dark:#DBBC7F">"people"</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">, </span><span style="color:#DFA000;--shiki-dark:#DBBC7F">"8"</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">),</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">    (</span><span style="color:#DFA000;--shiki-dark:#DBBC7F">"attraction-inform"</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">, </span><span style="color:#DFA000;--shiki-dark:#DBBC7F">"type"</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">, </span><span style="color:#DFA000;--shiki-dark:#DBBC7F">"architecture"</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">),</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">    ...</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">]</span></span></code></pre><p>一些传统的 DST 方法, 将 DST 建模为 <strong>(多标签)分类问题</strong> (Multi-Label Classification Problem). 分类问题需要提前枚举所有的类别标签, 因此需要提前建立较为完备的槽位值本体库 (Ontology).</p><blockquote><p>ontology, “本体; 本体论”</p><ol><li>[UN, philosophy] Ontology is the branch of philosophy that deals with the nature of existence. “本体论”</li><li>[UN, logic] the set of entities presupposed by a theory</li></ol><p>ontology 由 onto- + -logy 构成,<br>其中词根 onto- 来源于希腊词汇 on (所有格 ontos), 含义是 “a being, individual; being, existence”.<br>后缀 -logy 是 “学说” 的意思.</p></blockquote><p>使用分类问题建模 DST 的主要问题如下:</p><ul><li>常常无法得到完备的本体库</li><li>本体库过于庞大</li></ul><p>同时在对话系统中, 特别是多领域对话系统中, 槽位的具体值可能并非来自本轮对话, 甚至来自于其它 Domain 的某个其它类型的槽位. 这就涉及到 <strong>多轮映射</strong> (Multi-Turn Mapping) 及 <strong>领域迁移</strong> (Domain Transfering) 问题.</p><p>比如, Hotel 领域中的酒店位置信息 (假设 Hotel 域有 addr 类型槽位) 很可能在后续的 Taxi 领域对话中成为 Departure 的槽位值.</p><p>总结上述 DST 相关问题如下:</p><ul><li>如何在本体库不完备情况下实现 DST?</li><li>如何解决 DST 中的 多轮映射 和 领域迁移问题?</li></ul><p>由 香港科技大学 提出的 TRADE (<strong>TRA</strong>nsferable <strong>D</strong>ialogue Stat<strong>E</strong> Generator) 方法较好地解决了上述问题.</p><h1>TRADE: Transferable Dialogue State Generator</h1><p>TRADE 由 香港科技大学 的 Chien-Sheng Wu et al. 于 2019 年提出, 论文 <a href="https://arxiv.org/abs/1905.08743">Transferable multi-domain state generator for task-oriented dialogue systems</a>.</p><p>为了解决 本体库不完备 下的 DST 问题, TRADE 将 DST 使用了 State Generator 的方法, 将 DST 建模为序列生成问题 (而非传统的分类问题), 无须构建本体库, 即可完成 槽位值生成.</p><p>为了解决 多轮映射问题, TRADE 使用了最近的 L 轮对话作为输入.</p><p>为了解决 领域迁移 问题, TRADE 使用 Copy Mechanism 技术, 该技术对 Zero-shot DST 和 Few-shot DST 也有较为明显的效果.</p><p>从模型构成上, TRADE 主要由三个部分组成:</p><ul><li>Utterance Encoder</li><li>Slot Gate</li><li>Slot Generator</li></ul><!-- 关于在 Hexo 中使用图片, 请参考 https://hexo.io/docs/asset-folders.html --><p><img src="/2021/04/23/intro-convlab2-dst-trade/trade.png" alt="TRADE 架构图" srcset="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20300%20300'%3E%3C/svg%3E" data-src="/2021/04/23/intro-convlab2-dst-trade/trade.png" class="lozad post-image"></p><!-- <img src="/2021/04/23/intro-convlab2-dst-trade/trade.png"  lozad post-imageclass="" title="TRADE 模型结构图" srcset="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20300%20300'%3E%3C/svg%3E" data-src="/2021/04/23/intro-convlab2-dst-trade/trade.png"> --><p>整体上, 使用了经典的 Encoder-Decoder 架构来实现序列生成模型. 其中 Utterance Encoder 用来编码对话文本信息; Slot Generator 作为 Decoder, 负责槽位值生成. Slot Gate 是一个三分类器, 用于判断是否需要使用生成的值填充该槽位.</p><h2 id="Utterance-Encoder">Utterance Encoder</h2><p>TRADE 的 Utterance Encoder 没有特殊的设计, 使用常规的 LSTM 或GRU 即可.</p><p>为了解决 多轮映射 问题, TRADE 将最近的 l 轮对话内容拼接在一起编码, 数学表示如下:</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><msub><mi>X</mi><mi>t</mi></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mtext>concat</mtext><mo stretchy="false">(</mo><msub><mi>U</mi><mrow><mi>t</mi><mo>−</mo><mi>l</mi></mrow></msub><mo separator="true">,</mo><msub><mi>R</mi><mrow><mi>t</mi><mo>−</mo><mi>l</mi></mrow></msub><mo separator="true">,</mo><mo>⋯</mo><mtext> </mtext><mo separator="true">,</mo><msub><mi>U</mi><mi>t</mi></msub><mo separator="true">,</mo><msub><mi>R</mi><mi>t</mi></msub><mo stretchy="false">)</mo><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mi>M</mi></msup></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><msub><mi>E</mi><mi>t</mi></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mtext>Embed</mtext><mo stretchy="false">(</mo><msub><mi>X</mi><mi>t</mi></msub><mo stretchy="false">)</mo><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>M</mi><mo>×</mo><msub><mi>D</mi><mrow><mi>e</mi><mi>m</mi><mi>b</mi></mrow></msub></mrow></msup></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><msub><mi>H</mi><mi>t</mi></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mtext>Encode</mtext><mo stretchy="false">(</mo><msub><mi>E</mi><mi>t</mi></msub><mo stretchy="false">)</mo><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>M</mi><mo>×</mo><msub><mi>D</mi><mrow><mi>h</mi><mi>d</mi><mi>d</mi></mrow></msub></mrow></msup></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned}X_t &amp;= \text{concat} (U_{t-l}, R_{t-l}, \cdots, U_{t}, R_{t}) \in \mathbb{R}^{M} \\E_t &amp;= \text{Embed} (X_t) \in \mathbb{R}^{M \times D_{emb}} \\H_t &amp;= \text{Encode} (E_t) \in \mathbb{R}^{M \times D_{hdd}}\end{aligned}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:4.654em;vertical-align:-2.077em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.577em;"><span style="top:-4.6857em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.1343em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-1.583em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0813em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.077em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.577em;"><span style="top:-4.6857em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord text"><span class="mord">concat</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.109em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">−</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">−</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner">⋯</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.109em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">M</span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.1343em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord text"><span class="mord">Embed</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">M</span><span class="mbin mtight">×</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:-0.0278em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">mb</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span style="top:-1.583em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord text"><span class="mord">Encode</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">M</span><span class="mbin mtight">×</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:-0.0278em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">h</span><span class="mord mathnormal mtight">dd</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.077em;"><span></span></span></span></span></span></span></span></span></span></span></span></p><p>其中 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mo separator="true">,</mo><msub><mi>D</mi><mrow><mi>e</mi><mi>m</mi><mi>b</mi></mrow></msub><mo separator="true">,</mo><msub><mi>D</mi><mrow><mi>h</mi><mi>d</mi><mi>d</mi></mrow></msub></mrow><annotation encoding="application/x-tex">M, D_{emb}, D_{hdd}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">mb</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">h</span><span class="mord mathnormal mtight">dd</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 分别表示拼接后的文本长度, Embedding Size 和 Hidden Size.</p><h2 id="Slot-Generator">Slot Generator</h2><p>Slot Generator 是 TRADE 的解码器, 也使用了 RNN 来生成对应的槽位值序列.</p><p>TRADE 对每一个槽位 <code>Domain-Slot</code> 都需要执行一遍解码过程. 我们以 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>d</mi><mo separator="true">,</mo><mi>s</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(d, s)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">d</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">s</span><span class="mclose">)</span></span></span></span> 来代表一个 Domain-Slot 槽位, 来看一看 TRADE 的槽位值生成过程.</p><p>对于解码器, 我们已知的输入信息有:</p><ul><li>编码器输出序列编码 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>M</mi><mo>×</mo><msub><mi>D</mi><mrow><mi>h</mi><mi>d</mi><mi>d</mi></mrow></msub></mrow></msup></mrow><annotation encoding="application/x-tex">S \in \mathbb{R}^{M \times D_{hdd}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7224em;vertical-align:-0.0391em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8413em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">M</span><span class="mbin mtight">×</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:-0.0278em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">h</span><span class="mord mathnormal mtight">dd</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> 及 隐状态 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>H</mi><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><msub><mi>D</mi><mrow><mi>h</mi><mi>d</mi><mi>d</mi></mrow></msub></msup></mrow><annotation encoding="application/x-tex">H \in \mathbb{R}^{D_{hdd}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7224em;vertical-align:-0.0391em;"></span><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8413em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:-0.0278em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">h</span><span class="mord mathnormal mtight">dd</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>. (<em>这里省去了表示轮次的下标 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow></mrow><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;vertical-align:-0.15em;"></span><span class="mord"><span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></em>)</li><li>当前正在处理的槽位 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>d</mi><mo separator="true">,</mo><mi>s</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(d, s)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">d</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">s</span><span class="mclose">)</span></span></span></span></li><li>槽位词表 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>V</mi><mrow><mi>d</mi><mi>s</mi></mrow></msub></mrow><annotation encoding="application/x-tex">V_{ds}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">s</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 及 对应的 嵌入矩阵 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>E</mi><mrow><mi>d</mi><mi>s</mi></mrow></msub><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi mathvariant="normal">∣</mi><msub><mi>V</mi><mrow><mi>d</mi><mi>s</mi></mrow></msub><mi mathvariant="normal">∣</mi><mo>×</mo><msub><mi>D</mi><mrow><mi>h</mi><mi>d</mi><mi>d</mi></mrow></msub></mrow></msup></mrow><annotation encoding="application/x-tex">E_{ds} \in \mathbb{R}^{|V_{ds}| \times D_{hdd}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">s</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.888em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">∣</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:-0.2222em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">s</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span><span class="mord mtight">∣</span><span class="mbin mtight">×</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:-0.0278em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">h</span><span class="mord mathnormal mtight">dd</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></li><li>所有 Token 对应的总词表 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi></mrow><annotation encoding="application/x-tex">V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span> 及 嵌入矩阵 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>E</mi><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi mathvariant="normal">∣</mi><mi>V</mi><mi mathvariant="normal">∣</mi><mo>×</mo><msub><mi>D</mi><mrow><mi>h</mi><mi>d</mi><mi>d</mi></mrow></msub></mrow></msup></mrow><annotation encoding="application/x-tex">E \in \mathbb{R}^{|V| \times D_{hdd}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7224em;vertical-align:-0.0391em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.888em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">∣</span><span class="mord mathnormal mtight" style="margin-right:0.22222em;">V</span><span class="mord mtight">∣</span><span class="mbin mtight">×</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:-0.0278em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">h</span><span class="mord mathnormal mtight">dd</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></li><li>仅限训练时: 槽位值目标序列 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>T</mi><mo>=</mo><mo stretchy="false">[</mo><msub><mi>v</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>v</mi><mn>2</mn></msub><mo separator="true">,</mo><mo>⋯</mo><mtext> </mtext><mo separator="true">,</mo><msub><mi>v</mi><mi>N</mi></msub><mo stretchy="false">]</mo><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mi>N</mi></msup><mtext> </mtext></mrow><annotation encoding="application/x-tex">T = [v_1, v_2, \cdots, v_N] \in \mathbb{R}^{N} \,</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner">⋯</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8413em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span></span></span></span></li></ul><blockquote><p><strong>提示</strong></p><ul><li>槽位词表在构建时, 可以将 d 和 s 分别作为 Token 加入词表中 相对于将 <code>d-s</code> 整体作为 Token 可以减小词表体积, 同时方便 d 和 s 的多样组合;</li><li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>d</mi><mo separator="true">,</mo><mi>s</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(d, s)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">d</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">s</span><span class="mclose">)</span></span></span></span> 在具体嵌入时, 可以将 d 和 s 的嵌入向量叠加</li></ul></blockquote><!-- > * 槽位词表 可以包含在 总词表 中 --><p>对于槽位 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>d</mi><mo separator="true">,</mo><mi>s</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(d, s)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">d</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">s</span><span class="mclose">)</span></span></span></span>, 其槽位值生成过程如下</p><ol><li><p>获得 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>d</mi><mo separator="true">,</mo><mi>s</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(d, s)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">d</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">s</span><span class="mclose">)</span></span></span></span> 的嵌入向量 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>e</mi><mrow><mi>d</mi><mi>s</mi></mrow></msub><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mn>1</mn><mo>×</mo><msub><mi>D</mi><mrow><mi>h</mi><mi>d</mi><mi>d</mi></mrow></msub></mrow></msup></mrow><annotation encoding="application/x-tex">e_{ds} \in \mathbb{R}^{1 \times D_{hdd}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6891em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">s</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8413em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mbin mtight">×</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:-0.0278em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">h</span><span class="mord mathnormal mtight">dd</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></p></li><li><p>GRU 初始状态设置为编码器的输出状态 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>h</mi><mn>0</mn></msub><mo>=</mo><mi>H</mi></mrow><annotation encoding="application/x-tex">h_0 = H</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.08125em;">H</span></span></span></span></p></li><li><p>解码 Token <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>v</mi><mi>k</mi></msub></mrow><annotation encoding="application/x-tex">v_k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></p><ol><li><p>使用 Token <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>v</mi><mrow><mi>k</mi><mo>−</mo><mn>1</mn></mrow></msub></mrow><annotation encoding="application/x-tex">v_{k-1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6389em;vertical-align:-0.2083em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span></span></span></span> 对应的嵌入向量 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>e</mi><mrow><mi>k</mi><mo>−</mo><mn>1</mn></mrow></msub><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mn>1</mn><mo>×</mo><msub><mi>D</mi><mrow><mi>h</mi><mi>d</mi><mi>d</mi></mrow></msub></mrow></msup></mrow><annotation encoding="application/x-tex">e_{k-1} \in \mathbb{R}^{1 \times D_{hdd}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7474em;vertical-align:-0.2083em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8413em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mbin mtight">×</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:-0.0278em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">h</span><span class="mord mathnormal mtight">dd</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> 作为 GRU 的输入. 特别地, 当 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">k=0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span> 时, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>e</mi><mrow><mi>k</mi><mo>−</mo><mn>1</mn></mrow></msub><mo>=</mo><msub><mi>e</mi><mrow><mi>d</mi><mi>s</mi></mrow></msub><mtext> </mtext></mrow><annotation encoding="application/x-tex">e_{k-1} = e_{ds} \,</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6389em;vertical-align:-0.2083em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">s</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span></span></span></span></p></li><li><p>使用 GRU 解码, 得到隐状态</p></li></ol><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>s</mi><mi>k</mi></msub><mo separator="true">,</mo><msub><mi>h</mi><mi>k</mi></msub><mo>=</mo><mtext>GRU</mtext><mo stretchy="false">(</mo><msub><mi>e</mi><mrow><mi>k</mi><mo>−</mo><mn>1</mn></mrow></msub><mo separator="true">,</mo><msub><mi>h</mi><mrow><mi>t</mi><mo>−</mo><mn>1</mn></mrow></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">s_k, h_k = \text{GRU}(e_{k-1}, h_{t-1})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">GRU</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p><p>其中 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>s</mi><mi>k</mi></msub><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mn>1</mn><mo>×</mo><msub><mi>D</mi><mrow><mi>h</mi><mi>d</mi><mi>d</mi></mrow></msub></mrow></msup></mrow><annotation encoding="application/x-tex">s_k \in \mathbb{R}^{1 \times D_{hdd}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6891em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8413em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mbin mtight">×</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:-0.0278em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">h</span><span class="mord mathnormal mtight">dd</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>h</mi><mi>k</mi></msub><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mn>1</mn><mo>×</mo><msub><mi>D</mi><mrow><mi>h</mi><mi>d</mi><mi>d</mi></mrow></msub></mrow></msup></mrow><annotation encoding="application/x-tex">h_k \in \mathbb{R}^{1 \times D_{hdd}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8413em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mbin mtight">×</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:-0.0278em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">h</span><span class="mord mathnormal mtight">dd</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></p><ol start="3"><li>解码器隐状态 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>h</mi><mi>k</mi></msub><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mn>1</mn><mo>×</mo><msub><mi>D</mi><mrow><mi>h</mi><mi>d</mi><mi>d</mi></mrow></msub></mrow></msup></mrow><annotation encoding="application/x-tex">h_k \in \mathbb{R}^{1 \times D_{hdd}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8413em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mbin mtight">×</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:-0.0278em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">h</span><span class="mord mathnormal mtight">dd</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> 与 编码器序列编码 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>M</mi><mo>×</mo><msub><mi>D</mi><mrow><mi>h</mi><mi>d</mi><mi>d</mi></mrow></msub></mrow></msup></mrow><annotation encoding="application/x-tex">S \in \mathbb{R}^{M \times D_{hdd}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7224em;vertical-align:-0.0391em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8413em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">M</span><span class="mbin mtight">×</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:-0.0278em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">h</span><span class="mord mathnormal mtight">dd</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> 计算 Attention</li></ol><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>c</mi><mi>k</mi></msub><mo separator="true">,</mo><msub><mi>α</mi><mi>k</mi></msub><mo>=</mo><mtext>Attention</mtext><mo stretchy="false">(</mo><mi>S</mi><mo separator="true">,</mo><msub><mi>h</mi><mi>k</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">c_k, \alpha_k = \text{Attention} (S, h_k)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">Attention</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p><p>其中 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>c</mi><mi>k</mi></msub><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mn>1</mn><mo>×</mo><msub><mi>D</mi><mrow><mi>h</mi><mi>d</mi><mi>d</mi></mrow></msub></mrow></msup></mrow><annotation encoding="application/x-tex">c_k \in \mathbb{R}^{1 \times D_{hdd}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6891em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8413em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mbin mtight">×</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:-0.0278em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">h</span><span class="mord mathnormal mtight">dd</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> 是 上下文编码, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>α</mi><mi>k</mi></msub><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mi>M</mi></msup></mrow><annotation encoding="application/x-tex">\alpha_k \in \mathbb{R}^{M}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6891em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8413em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">M</span></span></span></span></span></span></span></span></span></span></span></span> 是每个序列编码向量 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>s</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">s_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 对应的权重</p><ol start="4"><li><p>将 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>c</mi><mi>k</mi></msub></mrow><annotation encoding="application/x-tex">c_k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 映射到 上下文向量 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mrow><mi>c</mi><mi>k</mi></mrow></msub><mo>=</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi mathvariant="normal">∣</mi><mi>V</mi><mi mathvariant="normal">∣</mi></mrow></msup></mrow><annotation encoding="application/x-tex">p_{ck} = \mathbb{R}^{|V|}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.888em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">∣</span><span class="mord mathnormal mtight" style="margin-right:0.22222em;">V</span><span class="mord mtight">∣</span></span></span></span></span></span></span></span></span></span></span></span> 空间.<br>(<em>这里可以使用 FC + Softmax, 也可以使用其它方式. 比如 ConvLab2 就使用了 <code>torch.scatter_add()</code> 方式, 将 Utterance 中每个单词对应的 Attention 权重 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>α</mi><mi>k</mi></msub></mrow><annotation encoding="application/x-tex">\alpha_k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 叠加, 作为对应词汇的概率, 这样只有输入序列中出现的词才会的概率大于 0</em>)</p></li><li><p>解码器隐状态 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>h</mi><mi>k</mi></msub></mrow><annotation encoding="application/x-tex">h_k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 与 嵌入矩阵 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>E</mi></mrow><annotation encoding="application/x-tex">E</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span></span></span></span> 计算 Attention, 得到 Pointer 向量</p></li></ol><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>p</mi><mrow><mi>v</mi><mi>k</mi></mrow></msub><mo>=</mo><mtext>Attention</mtext><mo stretchy="false">(</mo><mi>E</mi><mo separator="true">,</mo><msub><mi>h</mi><mi>k</mi></msub><mo stretchy="false">)</mo><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi mathvariant="normal">∣</mi><mi>V</mi><mi mathvariant="normal">∣</mi></mrow></msup></mrow><annotation encoding="application/x-tex">p_{vk} = \text{Attention} (E, h_k) \in \mathbb{R}^{|V|}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">Attention</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.938em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">∣</span><span class="mord mathnormal mtight" style="margin-right:0.22222em;">V</span><span class="mord mtight">∣</span></span></span></span></span></span></span></span></span></span></span></span></span></p><ol start="6"><li>计算权重因子 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>γ</mi><mi>k</mi></msub><mo>∈</mo><mi mathvariant="double-struck">R</mi><mtext> </mtext></mrow><annotation encoding="application/x-tex">\gamma_{k} \in \mathbb{R} \,</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7335em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05556em;">γ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0556em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6889em;"></span><span class="mord mathbb">R</span><span class="mspace" style="margin-right:0.1667em;"></span></span></span></span></li></ol><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>γ</mi><mi>k</mi></msub><mo>=</mo><mtext>FC</mtext><mo stretchy="false">(</mo><mo stretchy="false">[</mo><msub><mi>s</mi><mi>k</mi></msub><mo separator="true">;</mo><msub><mi>c</mi><mi>k</mi></msub><mo separator="true">;</mo><msub><mi>e</mi><mrow><mi>k</mi><mo>−</mo><mn>1</mn></mrow></msub><mo stretchy="false">]</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\gamma_{k} = \text{FC} ([s_k; c_k; e_{k-1}])</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05556em;">γ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0556em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">FC</span></span><span class="mopen">([</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">;</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">;</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mclose">])</span></span></span></span></span></p><ol start="7"><li>加权 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mrow><mi>c</mi><mi>k</mi></mrow></msub></mrow><annotation encoding="application/x-tex">p_{ck}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 和 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mrow><mi>v</mi><mi>k</mi></mrow></msub></mrow><annotation encoding="application/x-tex">p_{vk}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>, 得到 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>v</mi><mi>k</mi></msub></mrow><annotation encoding="application/x-tex">v_k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 的概率分布 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mi>k</mi></msub><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi mathvariant="normal">∣</mi><mi>V</mi><mi mathvariant="normal">∣</mi></mrow></msup></mrow><annotation encoding="application/x-tex">{p_{k} \in \mathbb{R}^{|V|}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0824em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">∣</span><span class="mord mathnormal mtight" style="margin-right:0.22222em;">V</span><span class="mord mtight">∣</span></span></span></span></span></span></span></span></span></span></span></span></span></li></ol><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>p</mi><mi>k</mi></msub><mo>=</mo><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><msub><mi>γ</mi><mi>k</mi></msub><mo stretchy="false">)</mo><mo>∗</mo><msub><mi>p</mi><mrow><mi>c</mi><mi>k</mi></mrow></msub><mo>+</mo><msub><mi>γ</mi><mi>k</mi></msub><mo>∗</mo><msub><mi>p</mi><mrow><mi>v</mi><mi>k</mi></mrow></msub></mrow><annotation encoding="application/x-tex">p_{k} = (1 - \gamma_{k} ) * p_{ck} + \gamma_{k} * p_{vk}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05556em;">γ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0556em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6597em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05556em;">γ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0556em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></p><ol start="8"><li>解码 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>v</mi><mi>k</mi></msub></mrow><annotation encoding="application/x-tex">v_k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></li></ol><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>v</mi><mi>k</mi></msub><mo>=</mo><munder><mrow><mi mathvariant="normal">arg max</mi><mo>⁡</mo></mrow><mrow><mi>v</mi><mo>∈</mo><mi>V</mi></mrow></munder><mo stretchy="false">(</mo><msub><mi>p</mi><mi>k</mi></msub><mo stretchy="false">[</mo><mi>v</mi><mo stretchy="false">]</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">v_k = \argmax_{v \in V} (p_k [v])</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.7161em;vertical-align:-0.9661em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.4306em;"><span style="top:-2.1612em;margin-left:0em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span><span class="mrel mtight">∈</span><span class="mord mathnormal mtight" style="margin-right:0.22222em;">V</span></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span><span class="mop"><span class="mord mathrm" style="margin-right:0.01389em;">arg</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathrm">max</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.9661em;"><span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mclose">])</span></span></span></span></span></p></li><li><p>槽位 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>d</mi><mo separator="true">,</mo><mi>s</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(d, s)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">d</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">s</span><span class="mclose">)</span></span></span></span> 的槽位值 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>v</mi><mo>=</mo><mo stretchy="false">[</mo><msub><mi>v</mi><mn>0</mn></msub><mo separator="true">,</mo><msub><mi>v</mi><mn>1</mn></msub><mo separator="true">,</mo><mo>⋯</mo><mtext> </mtext><mo separator="true">,</mo><msub><mi>v</mi><mi>N</mi></msub><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">v = [v_0, v_1, \cdots, v_N]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner">⋯</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">]</span></span></span></span></p></li></ol><h2 id="Slot-Gate">Slot Gate</h2><p>Slot Gate 是一个三分类器, 目标类别有:</p><ul><li><code>ptr</code></li><li><code>none</code></li><li><code>dontcare</code></li></ul><p>Slot Gate 只需要在解码槽位 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>d</mi><mo separator="true">,</mo><mi>s</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(d, s)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">d</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">s</span><span class="mclose">)</span></span></span></span> 的槽位值的第一个 Token <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>v</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">v_0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 时判断即可.</p><p>Slot Gate 使用最基础的 FC + Softmax 网络即可. 输入 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>v</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">v_0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 的上下文编码向量 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>c</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">c_0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>, Slot Gate 的工作流程为:</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>g</mi><mrow><mi>d</mi><mi>s</mi></mrow></msub><mo>=</mo><mtext>Softmax</mtext><mo stretchy="false">(</mo><mtext>FC</mtext><mo stretchy="false">(</mo><msub><mi>c</mi><mn>0</mn></msub><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mn>3</mn></msup></mrow><annotation encoding="application/x-tex">g_{ds} = \text{Softmax} (\text{FC} (c_0)) \in \mathbb{R}^{3}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">s</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">Softmax</span></span><span class="mopen">(</span><span class="mord text"><span class="mord">FC</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">))</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8641em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span></span></span></span></span></span></span></span></span></span></span></span></span></p><h2 id="Zero-shot-Few-shot-DST">Zero-shot / Few-shot DST</h2><p>先回忆一下 TRADE 解码器的输入数据:</p><ul><li>编码器输出序列编码 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>M</mi><mo>×</mo><msub><mi>D</mi><mrow><mi>h</mi><mi>d</mi><mi>d</mi></mrow></msub></mrow></msup></mrow><annotation encoding="application/x-tex">S \in \mathbb{R}^{M \times D_{hdd}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7224em;vertical-align:-0.0391em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8413em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">M</span><span class="mbin mtight">×</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:-0.0278em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">h</span><span class="mord mathnormal mtight">dd</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> 及 隐状态 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>H</mi><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><msub><mi>D</mi><mrow><mi>h</mi><mi>d</mi><mi>d</mi></mrow></msub></msup></mrow><annotation encoding="application/x-tex">H \in \mathbb{R}^{D_{hdd}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7224em;vertical-align:-0.0391em;"></span><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8413em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:-0.0278em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">h</span><span class="mord mathnormal mtight">dd</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></li><li>当前正在处理的槽位 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>d</mi><mo separator="true">,</mo><mi>s</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(d, s)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">d</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">s</span><span class="mclose">)</span></span></span></span></li><li>槽位词表 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>V</mi><mrow><mi>d</mi><mi>s</mi></mrow></msub></mrow><annotation encoding="application/x-tex">V_{ds}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">s</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 及 对应的 嵌入矩阵 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>E</mi><mrow><mi>d</mi><mi>s</mi></mrow></msub><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi mathvariant="normal">∣</mi><msub><mi>V</mi><mrow><mi>d</mi><mi>s</mi></mrow></msub><mi mathvariant="normal">∣</mi><mo>×</mo><msub><mi>D</mi><mrow><mi>h</mi><mi>d</mi><mi>d</mi></mrow></msub></mrow></msup></mrow><annotation encoding="application/x-tex">E_{ds} \in \mathbb{R}^{|V_{ds}| \times D_{hdd}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">s</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.888em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">∣</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:-0.2222em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">s</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span><span class="mord mtight">∣</span><span class="mbin mtight">×</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:-0.0278em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">h</span><span class="mord mathnormal mtight">dd</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></li><li>所有 Token 对应的总词表 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi></mrow><annotation encoding="application/x-tex">V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span> 及 嵌入矩阵 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>E</mi><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi mathvariant="normal">∣</mi><mi>V</mi><mi mathvariant="normal">∣</mi><mo>×</mo><msub><mi>D</mi><mrow><mi>h</mi><mi>d</mi><mi>d</mi></mrow></msub></mrow></msup></mrow><annotation encoding="application/x-tex">E \in \mathbb{R}^{|V| \times D_{hdd}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7224em;vertical-align:-0.0391em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.888em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">∣</span><span class="mord mathnormal mtight" style="margin-right:0.22222em;">V</span><span class="mord mtight">∣</span><span class="mbin mtight">×</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:-0.0278em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">h</span><span class="mord mathnormal mtight">dd</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></li><li>仅限训练时: 槽位值目标序列: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>T</mi><mo>=</mo><mo stretchy="false">[</mo><msub><mi>v</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>v</mi><mn>2</mn></msub><mo separator="true">,</mo><mo>⋯</mo><mtext> </mtext><mo separator="true">,</mo><msub><mi>v</mi><mi>N</mi></msub><mo stretchy="false">]</mo><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mi>N</mi></msup><mtext> </mtext></mrow><annotation encoding="application/x-tex">T = [v_1, v_2, \cdots, v_N] \in \mathbb{R}^{N} \,</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner">⋯</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8413em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span></span></span></span></li></ul><p>在 Zero-shot 场景下, 目标 Domain 和/或 Slot 在训练数据未曾出现过, 因此无法获得 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>d</mi><mo separator="true">,</mo><mi>s</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(d, s)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">d</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">s</span><span class="mclose">)</span></span></span></span> 对应的嵌入向量. 这种情况下的 DST 是非常困难的.</p><p>在 Few-shot 场景下, 可以认为槽位词表 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>V</mi><mrow><mi>d</mi><mi>s</mi></mrow></msub></mrow><annotation encoding="application/x-tex">V_{ds}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">s</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 是完备的, 只不过对于新的 Domain 和 Slot, 其嵌入向量是欠学习的.</p><p>Few-shot 场景常用的学习方法是 <strong>持续学习 (Continual Learning)</strong>.</p><p>论文采用了两种持续学习方法来 Fine-tune 模型:</p><ul><li>EWC (Elastic Weight Consolidation): <a href="http://arxiv.org/abs/1612.00796">Overcoming catastrophic forgetting in neural networks</a>, Kirkpatrick et al, 2017</li><li>GEM (Gradient Episodic Memory): <a href="http://arxiv.org/abs/1712.01169">Episodic memory for continual model learning</a>, Nagy et al, 2017</li></ul><p>关于持续学习, 我们将在后续的博客中再进行介绍.</p><h1>ConvLab2 实现</h1><p>在 ConvLab2 中, TRADE 的模型代码在 <a href="https://github.com/thu-coai/ConvLab-2/blob/master/convlab2/dst/trade/multiwoz/models/TRADE.py">convlab2/dst/trade/multiwoz/models/TRADE.py</a> 中实现.</p><h1>TRADE 论文中的相关技术简介</h1><h2 id="Copy-Mechanism">Copy Mechanism</h2><p>Copy Mechanism 分为三大类:</p><ul><li>Index-based Copy<ul><li><a href="http://arxiv.org/abs/1506.03134">Pointer networks</a>, Vinyals et al, 2015</li></ul></li><li>Hard-gated Copy<ul><li><a href="http://arxiv.org/abs/1603.08148">Pointing the Unknown Words</a>, Gulcehre et al, 2016</li><li><a href="http://arxiv.org/abs/1804.08217">Mem2Seq: Effectively Incorporating Knowledge Bases into End-to-End Task-Oriented Dialog Systems</a>, Madotto et al, 2018</li><li><a href="http://arxiv.org/abs/1901.04713">Global-to-local memory pointer networks for task-oriented dialogue</a>, Wu et al, 2019</li></ul></li><li>Soft-gated Copy<ul><li><a href="http://arxiv.org/abs/1704.04368">Get To The Point: Summarization with Pointer-Generator Networks</a>, See et al, 2017</li><li><a href="http://arxiv.org/abs/1806.08730">The natural language decathlon: Multitask learning as question answering</a>, McCann, 2018</li></ul></li></ul><h2 id="Continual-Learning">Continual Learning</h2><ul><li>EWC: <a href="http://arxiv.org/abs/1612.00796">Overcoming catastrophic forgetting in neural networks</a>, Kirkpatrick et al, 2017</li><li>GEM: <a href="http://arxiv.org/abs/1712.01169">Episodic memory for continual model learning</a>, Nagy et al, 2017</li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;对话状态追踪 (Dialogue State Tracking, DST) 是任务型对话系统 (Task-Oriented Dialogue System, TOD) 的核心模块.&lt;/p&gt;
&lt;p&gt;DST 的目标是 提取用户目标 (User Goal) 和 意图, 并将其编码</summary>
      
    
    
    
    <category term="对话系统" scheme="https://loveychen.github.io/categories/%E5%AF%B9%E8%AF%9D%E7%B3%BB%E7%BB%9F/"/>
    
    <category term="ConvLab2" scheme="https://loveychen.github.io/categories/%E5%AF%B9%E8%AF%9D%E7%B3%BB%E7%BB%9F/ConvLab2/"/>
    
    
    <category term="TOD" scheme="https://loveychen.github.io/tags/TOD/"/>
    
    <category term="ConvLab2" scheme="https://loveychen.github.io/tags/ConvLab2/"/>
    
    <category term="DST" scheme="https://loveychen.github.io/tags/DST/"/>
    
    <category term="TRADE" scheme="https://loveychen.github.io/tags/TRADE/"/>
    
  </entry>
  
  <entry>
    <title>ConvLab2 02. NN-based User Simulator - HUS</title>
    <link href="https://loveychen.github.io/2021/04/16/intro-convlab2-user-simulator-hus/"/>
    <id>https://loveychen.github.io/2021/04/16/intro-convlab2-user-simulator-hus/</id>
    <published>2021-04-16T03:45:17.000Z</published>
    <updated>2025-08-05T17:48:18.794Z</updated>
    
    <content type="html"><![CDATA[<p>在 <a href="https://loveychen.github.io/2021/04/14/intro-convlab2-user-simulator-agenda/">ConvLab2 01. Agenda-based User Simulator</a> 中, 我们介绍了基于 Agenda 的用户模拟器.</p><p>今天我们来介绍一个基于神经网络的端到端的用户模拟器: HUS.</p><p>HUS, 全称 <strong>H</strong>ierarchical <strong>U</strong>ser <strong>S</strong>imulator, 是 2018 年 Izzeddin Gur, Dilek Hakkani-Tur, Gokhan Tur, Pararth Shah 等人在论文 <a href="https://arxiv.org/abs/1811.04369">User Modeling for Task Oriented Dialogues</a> 提出的用户模拟器. 当时4位作者都在 Google AI 工作.</p><h1>User Modeling for Task Oriented Dialogues</h1><p>任务型对话系统(Task Oriented Dialogue System, 简称 TOD) 是以人机交互的形式帮助用户完成目标 (accomplish their goal).</p><p>从TOD 架构上看, 可以将 TOD 的研究划分为两大类:</p><ul><li>Pipeline architecture</li><li>end-to-end architecture</li></ul><p>在 TOD 中, User Simulator 主要用于对话系统(或其各个模块) 的评估和训练. 整体而言, User Simulator 主要作用有:</p><ul><li>辅助训练 TOD. 如 Asri et al [^1], Baolin Peng et al [^2] 及 Paul Crook et al [^3] 等实验了使用 seq2seq 模型构建的用户模拟器来训练 Dialogue Policy 模型</li><li>辅助评估 TOD. 使用 Simulator 模拟用户与 TOD 交互, 可以得到 User Goal 的 EM (Exact Matching) 和 PM (Partial Matching) 指标等.</li></ul><p>HUS 是 User Simulator 的一种, 它借鉴了端到端 TOD 的设计思想, 也提供了一种端到端的 User Simulator. 具体地, HUS 利用了如下这些技术:</p><ul><li>seq2seq</li><li>hierarchical model</li><li>variational method</li><li>goal regularization approach</li></ul><h2 id="seq2seq">seq2seq</h2><p>seq2seq 是 2014 年 Google 的 Ilya Sutskever, Oriol Vinyals 及 Quoc Viet Le 等人在论文 <a href="http://arxiv.org/abs/1409.3215">Sequence to Sequence Learning with Neural Network</a> 中提出的一种序列生成模型, 可以用在 NMT, NLG, QA 等多个 NLP 领域.</p><p>几乎在同一时期 (事实上比 Seq2seq 更早一些), Kyunghyun Cho, Dzmitry Bahdanau, Fethi Bougares, Holger Schwenk, Yoshua Bengio 等人在论文 <a href="http://arxiv.org/abs/1406.1078">Learning Phrase Representations using RNN Encoder-Decoder for Statistical Machine Translation</a> 中提出了 Encoder-Decoder 框架.</p><p>两篇论文采用了相似的系统架构, 不同点在于 Encoder-Decoder 论文使用了 GRU (当时论文中还没有称之为 GRU), 而 Seq2seq 则使用了 LSTM.</p><p>一般地, 除了特别声明, 我们认为 seq2seq 与 Encoder-Decoder 架构是同义词.</p><h2 id="hierarchical-model">hierarchical model</h2><p>Hierarchical model 指的是, 相关研究有:</p><ul><li><a href="http://aclweb.org/anthology/P15-1107">A Hierarchical Neural Autoencoder for Paragraphs and Documents</a>, Jiwei Li, Minh-Thang Luong, and Dan Jurafsky, CoRR, vol. abs/1506.01057, 2015.</li><li><a href="https://arxiv.org/abs/1507.02221">A Hierarchical Recurrent Encoder-Decoder For Generative Context-Aware Query Suggestion</a>, Alessandro Sordoni, Yoshua Bengio, Hossein Vahabi, Christina Lioma, Jakob Grue Simonsen, and Jian-Yun Nie, CoRR, vol. abs/1507.02221, 2015.</li><li><a href="http://arxiv.org/abs/1605.06069">A hierarchical latent variable encoder-decoder model for generating dialogues</a>, Iulian Vlad Serban, Alessandro Sordoni, Ryan Lowe, Laurent Charlin, Joelle Pineau, Aaron C. Courville, and Yoshua Ben- gio, CoRR, vol. abs/1605.06069, 2016.</li></ul><blockquote><p><a href="https://www.collinsdictionary.com/dictionary/english/hierarchical">hierarchical</a>, “按等级划分的; 等级制度的; 分层的; 分等级的”</p><ol><li>[adj] A hierarchical system or organization is one in which people have different ranks or positions,depending on how important they are.</li></ol><p><code>hierarchical</code> 由 <code>hierarch</code> + 形容词后缀 <code>-ical</code> 构成.<br><code>hierarch</code> 来源于希腊词汇 <code>hierarkhia</code>, 含义是 “one who rules in holy things” (“大主教; 祭司长; 统治集团首领”).</p></blockquote><p>Hierarchical Model 也称为 <a href="https://en.wikipedia.org/wiki/Multilevel_model">Multi-Level model</a>, 最常用的有:</p><ul><li>Hierarchical Linear Model, 层次线性模型 (HLM)</li><li><a href="https://en.wikipedia.org/wiki/Bayesian_network">Hierarchical Bayesian Model</a>, 层次贝叶斯模型, 也称为贝叶斯网络</li><li>Hierarchical Neural Network, 层次神经网络</li></ul><p>层级模型使用了多个模型, 数据会先由底层模型处理, 其处理结果作为高层模型的输入特征进一步处理, 多级模型协作并联合训练.</p><p>HUS 中使用了</p><h2 id="variational-method">variational method</h2><p>Variational Method / Variational Approach, 一般翻译为 “差分法; 变分法”, 在机器学习/深度学习模型中的典型使用是 Variational Auto-Encoder, 如:</p><ul><li><a href="https://arxiv.org/abs/1312.6114">Auto-Encoding Variational Bayes</a>, Diederik P Kingma, Max Welling, 2013</li><li><a href="https://arxiv.org/abs/1412.6581">Variational Recurrent Auto-Encoders</a>, Otto Fabius, Joost R. van Amersfoort, 2014</li></ul><h2 id="HUS">HUS</h2><p>在开始正式介绍 HUS 之前, 再次介绍一下 User Simulator 中的一些基本概念.</p><p>User Simulator 建模可以认为是 Dialogue System 的逆问题 (inverse problem), 其目标是根据 User Goal 和 系统响应 System Turn (<em>可以是 System Action (Pipeline 架构), 也可以是 System Utterance (E2E 架构)</em>) 来生成合适的 User Turn.</p><p>这里 User Goal <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>C</mi></mrow><annotation encoding="application/x-tex">C</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span></span></span></span> 是一个 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>&lt;</mo><mi>s</mi><mi>l</mi><mi>o</mi><mi>t</mi><mo separator="true">,</mo><mi>v</mi><mi>a</mi><mi>l</mi><mi>u</mi><mi>e</mi><mo>&gt;</mo></mrow><annotation encoding="application/x-tex">&lt;slot, value&gt;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">s</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">o</span><span class="mord mathnormal">t</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">u</span><span class="mord mathnormal">e</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&gt;</span></span></span></span> 集合 及 一组预定义的用户个性 (User Personality, <em>可以是 <code>aggressive</code> / <code>cooperative</code> 等描述性词语, 也可以是自然语言描述的段落</em> ).</p><p>System Turn / User Turn 一般使用 Dialogue Action 来描述. Dialogue Action 可以表示为一组 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>&lt;</mo><mi>d</mi><mi>o</mi><mi>m</mi><mi>a</mi><mi>i</mi><mi>n</mi><mo separator="true">,</mo><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>n</mi><mi>t</mi><mo separator="true">,</mo><mi>s</mi><mi>l</mi><mi>o</mi><mi>t</mi><mo separator="true">,</mo><mi>v</mi><mi>a</mi><mi>l</mi><mi>u</mi><mi>e</mi><mo>&gt;</mo></mrow><annotation encoding="application/x-tex">&lt;domain, intent, slot, value&gt;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">d</span><span class="mord mathnormal">o</span><span class="mord mathnormal">main</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">s</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">o</span><span class="mord mathnormal">t</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">u</span><span class="mord mathnormal">e</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&gt;</span></span></span></span> 构成的集合 (<em>当处理 single domain 对话时, 可以省略 <code>domain</code> 元素</em>).</p><blockquote><p><strong>问题简化</strong><br>HUS 将 Slot Value 简化为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">{</mo><mi>R</mi><mi>e</mi><mi>q</mi><mi>u</mi><mi>e</mi><mi>s</mi><mi>t</mi><mi>e</mi><mi>d</mi><mo separator="true">,</mo><mi>D</mi><mi>o</mi><mi>n</mi><mi>t</mi><mi>C</mi><mi>a</mi><mi>r</mi><mi>e</mi><mo separator="true">,</mo><mi>V</mi><mi>a</mi><mi>l</mi><mi>u</mi><mi>e</mi><mi>I</mi><mi>n</mi><mi>G</mi><mi>o</mi><mi>a</mi><mi>l</mi><mo separator="true">,</mo><mi>V</mi><mi>a</mi><mi>l</mi><mi>u</mi><mi>e</mi><mi>C</mi><mi>o</mi><mi>n</mi><mi>t</mi><mi>r</mi><mi>a</mi><mi>d</mi><mi>i</mi><mi>c</mi><mi>t</mi><mi>s</mi><mi>G</mi><mi>o</mi><mi>a</mi><mi>l</mi><mo separator="true">,</mo><mi>O</mi><mi>t</mi><mi>h</mi><mi>e</mi><mi>r</mi><mo stretchy="false">}</mo></mrow><annotation encoding="application/x-tex">\{Requested, DontCare, ValueInGoal, ValueContradictsGoal, Other\}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">{</span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mord mathnormal">u</span><span class="mord mathnormal">es</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal">d</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">Do</span><span class="mord mathnormal">n</span><span class="mord mathnormal" style="margin-right:0.07153em;">tC</span><span class="mord mathnormal">a</span><span class="mord mathnormal">re</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">Va</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">u</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="mord mathnormal">n</span><span class="mord mathnormal">G</span><span class="mord mathnormal">o</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">Va</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">u</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">a</span><span class="mord mathnormal">d</span><span class="mord mathnormal">i</span><span class="mord mathnormal">c</span><span class="mord mathnormal">t</span><span class="mord mathnormal">s</span><span class="mord mathnormal">G</span><span class="mord mathnormal">o</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">Ot</span><span class="mord mathnormal">h</span><span class="mord mathnormal" style="margin-right:0.02778em;">er</span><span class="mclose">}</span></span></span></span> 五个值.</p></blockquote><blockquote><p><strong>数据序列化问题</strong><br>User Simulator 的部分输入数据是结构化数据, 如 User Goal / System Action 等, 需要使用一定的方法将这些结构化数据编码为序列. 论文使用了 <a href="https://arxiv.org/abs/1412.7449">Grammar as a foreign language, 2014</a> 给出的序列化方法, System Action <code>confirm(movie=ValueInGoal, time=ValueInGoal)</code> 会被序列化为 <code>&quot;confirm&quot;, &quot;(&quot;, &quot;movie=ValueInGoal&quot;, &quot;time=ValueInGoal&quot;, &quot;)&quot;</code> 序列.</p></blockquote><p>基于上述概念, User Simulator 的形式化建模如下:</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>U</mi><mi>t</mi></msub><mo>=</mo><mtext>Simulator</mtext><mo stretchy="false">(</mo><mi>C</mi><mo separator="true">,</mo><msub><mi>S</mi><mrow><mn>1</mn><mo>:</mo><mi>t</mi></mrow></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">U_t = \text{Simulator}(C, S_{1:t})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.109em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">Simulator</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mrel mtight">:</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p><p>即在给定 User Goal <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>C</mi></mrow><annotation encoding="application/x-tex">C</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span></span></span></span> 和 System Turn 序列 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>S</mi><mrow><mn>1</mn><mo>:</mo><mi>t</mi></mrow></msub></mrow><annotation encoding="application/x-tex">S_{1:t}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mrel mtight">:</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 的条件下, 生成合适的 User Turn <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>U</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">U_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.109em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>.</p><h3 id="HUS-基础模型">HUS 基础模型</h3><p>HUS 基础模型主要由四部分构成</p><ul><li>User Goal Encoding</li><li>System Turn Encoding</li><li>Dialogue History Encoding</li><li>User Turn Decoding</li></ul><p>其结构如下图所示</p><p><img src="/2021/04/16/intro-convlab2-user-simulator-hus/HUS.png" alt="HUS-base 结构图" srcset="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20300%20300'%3E%3C/svg%3E" data-src="/2021/04/16/intro-convlab2-user-simulator-hus/HUS.png" class="lozad post-image"></p><!-- <img src="/2021/04/16/intro-convlab2-user-simulator-hus/HUS.png"  lozad post-imageclass="" title="HUS-base 结构图" srcset="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20300%20300'%3E%3C/svg%3E" data-src="/2021/04/16/intro-convlab2-user-simulator-hus/HUS.png"> --><h4 id="层级编码器">层级编码器</h4><p>对于序列化后的 User Goal <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>G</mi></mrow><annotation encoding="application/x-tex">G</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">G</span></span></span></span>, 首先会经过一个 Embedding 层得到序列向量 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>e</mi><mi>G</mi></msup></mrow><annotation encoding="application/x-tex">e^{G}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8413em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">G</span></span></span></span></span></span></span></span></span></span></span></span>, 然后经过 User Goal Encoder, 得到 User Goal 的隐层表示 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>h</mi><mi>C</mi></msup></mrow><annotation encoding="application/x-tex">h^C</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8413em;"></span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">C</span></span></span></span></span></span></span></span></span></span></span>, 即:</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msup><mi>h</mi><mi>C</mi></msup><mo>=</mo><mtext>Goal-Encoder</mtext><mo stretchy="false">(</mo><msup><mi>e</mi><mi>C</mi></msup><mo separator="true">;</mo><msup><mi>θ</mi><mi>C</mi></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">h^C = \text{Goal-Encoder}(e^C; \theta^{C})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8913em;"></span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">C</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.1413em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">Goal-Encoder</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">C</span></span></span></span></span></span></span></span><span class="mpunct">;</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">C</span></span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p><p>同理, 第 t 轮的 System Turn 可以得到隐层表示 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>h</mi><mi>S</mi></msup></mrow><annotation encoding="application/x-tex">h^S</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8413em;"></span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05764em;">S</span></span></span></span></span></span></span></span></span></span></span>, 即:</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msubsup><mi>h</mi><mi>t</mi><mi>S</mi></msubsup><mo>=</mo><mtext>System-Encoder</mtext><mo stretchy="false">(</mo><msubsup><mi>e</mi><mi>t</mi><mi>S</mi></msubsup><mo separator="true">;</mo><msup><mi>θ</mi><mi>S</mi></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">h_t^S = \text{System-Encoder}(e_t^S; \theta^{S})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1383em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05764em;">S</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.1413em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">System-Encoder</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05764em;">S</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mpunct">;</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05764em;">S</span></span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p><p>结合 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>h</mi><mi>C</mi></msup></mrow><annotation encoding="application/x-tex">h^C</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8413em;"></span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">C</span></span></span></span></span></span></span></span></span></span></span> 及 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>h</mi><mi>t</mi><mi>S</mi></msubsup></mrow><annotation encoding="application/x-tex">h_t^S</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0883em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05764em;">S</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span></span></span></span>, 使用 Dialogue History Encoder 可以得到 Dialogue History 的隐层表示, 即:</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><msubsup><mi>h</mi><mn>0</mn><mi>D</mi></msubsup></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><msup><mi>h</mi><mi>C</mi></msup></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><msubsup><mi>h</mi><mi>t</mi><mi>D</mi></msubsup></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mtext>History-Encoder</mtext><mo stretchy="false">(</mo><msubsup><mi>h</mi><mrow><mn>1</mn><mo>:</mo><mi>t</mi></mrow><mi>S</mi></msubsup><mo separator="true">;</mo><msup><mi>θ</mi><mi>D</mi></msup><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned}h_0^D &amp;= h^C \\h_t^D &amp;= \text{History-Encoder}(h_{1:t}^S; \theta^{D})\end{aligned}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:3.1027em;vertical-align:-1.3013em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8013em;"><span style="top:-3.91em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">D</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.3587em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">D</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.3013em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8013em;"><span style="top:-3.91em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">C</span></span></span></span></span></span></span></span></span></span><span style="top:-2.3587em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord text"><span class="mord">History-Encoder</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mrel mtight">:</span><span class="mord mathnormal mtight">t</span></span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05764em;">S</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mpunct">;</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">D</span></span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.3013em;"><span></span></span></span></span></span></span></span></span></span></span></span></p><h4 id="User-Turn-解码器">User Turn 解码器</h4><p>HUS 使用了一个 RNN 来解码 User Turn, 第 t 轮的 User Turn 解码过程如下:</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><msubsup><mi>h</mi><mn>0</mn><mi>U</mi></msubsup></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><msubsup><mi>h</mi><mi>t</mi><mi>D</mi></msubsup></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><msubsup><mi>h</mi><mrow><mi>t</mi><mo separator="true">,</mo><mi>i</mi></mrow><mi>U</mi></msubsup></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mtext>Decoder</mtext><mo stretchy="false">(</mo><msubsup><mi>h</mi><mrow><mi>t</mi><mo>−</mo><mn>1</mn><mo separator="true">,</mo><mi>i</mi></mrow><mi>U</mi></msubsup><mo separator="true">;</mo><msup><mi>θ</mi><mi>U</mi></msup><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi>P</mi><mo stretchy="false">(</mo><msubsup><mi>U</mi><mrow><mi>t</mi><mo separator="true">,</mo><mi>i</mi></mrow><mo lspace="0em" rspace="0em">∗</mo></msubsup><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>≈</mo><mtext>softmax</mtext><mo stretchy="false">(</mo><msup><mi>W</mi><mi>u</mi></msup><mo>∗</mo><msubsup><mi>h</mi><mrow><mi>t</mi><mo separator="true">,</mo><mi>i</mi></mrow><mi>U</mi></msubsup><mo>+</mo><msup><mi>b</mi><mi>U</mi></msup><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><msub><mi>U</mi><mrow><mi>t</mi><mo separator="true">,</mo><mi>i</mi></mrow></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><msub><mtext>argmax</mtext><mrow><msub><mi>w</mi><mi>j</mi></msub><mo>∈</mo><mi>V</mi></mrow></msub><mi>P</mi><mo stretchy="false">(</mo><msubsup><mi>U</mi><mrow><mi>t</mi><mo separator="true">,</mo><mi>i</mi></mrow><mo lspace="0em" rspace="0em">∗</mo></msubsup><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned}h_0^U &amp;= h_t^D \\h_{t, i} ^ U &amp;= \text{Decoder} (h_{t-1, i}^U; \theta^{U}) \\P(U_{t, i}^{*})  &amp; \approx \text{softmax} (W^u * h_{t, i}^U + b^U) \\U_{t, i} &amp;= \text{argmax}_{w_j \in V} P(U_{t, i}^{*})\end{aligned}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:6.2817em;vertical-align:-2.8908em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.3908em;"><span style="top:-5.4995em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">U</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.9482em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">i</span></span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">U</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3831em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.3737em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7387em;"><span style="top:-2.453em;margin-left:-0.109em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">i</span></span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">∗</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3831em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-0.8506em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.109em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.8908em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.3908em;"><span style="top:-5.4995em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">D</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.9482em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord text"><span class="mord">Decoder</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">−</span><span class="mord mtight">1</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">i</span></span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">U</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3831em;"><span></span></span></span></span></span></span><span class="mpunct">;</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">U</span></span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-2.3737em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord text"><span class="mord">softmax</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7144em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">u</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">i</span></span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">U</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3831em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">U</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-0.8506em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord"><span class="mord text"><span class="mord">argmax</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2342em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:-0.0269em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2819em;"><span></span></span></span></span></span></span><span class="mrel mtight">∈</span><span class="mord mathnormal mtight" style="margin-right:0.22222em;">V</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4415em;"><span></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7387em;"><span style="top:-2.453em;margin-left:-0.109em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">i</span></span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">∗</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3831em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.8908em;"><span></span></span></span></span></span></span></span></span></span></span></span></p><h3 id="HUS-优化模型">HUS 优化模型</h3><h4 id="VHUS">VHUS</h4><h4 id="UHUSReg">UHUSReg</h4><h1>ConvLab2 实现</h1><h1>参考文献</h1><p>[^1]: Layla El Asri, Jing He, and Kaheer Suleman, <a href="https://arxiv.org/abs/1607.00070">“A sequence-to-sequence model for user simulation in spoken dialogue system”</a>, CoRR, vol. abs/1607.00070, 2016<br>[^2]: Baolin Peng, Xiujun Li, Lihong Li, Jianfeng Gao, Asli Celiky- ilmaz, Sungjin Lee, and Kam-Fai Wong, <a href="https://arxiv.org/abs/1704.03084">“Composite task-completion dialogue system via hierarchical deep reinforcement learning”</a>, arxiv:1704.03084v2, 2017.<br>[^3]: Paul Crook and Alex Marin, <a href="">“Sequence to sequence modeling for user simulation in dialog systems”</a>, in Proceedings of the 18th Annual Conference of the International Speech Commu- nication Association (INTERSPEECH 2017), 2017, pp. 1706– 1710.</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;在 &lt;a href=&quot;https://loveychen.github.io/2021/04/14/intro-convlab2-user-simulator-agenda/&quot;&gt;ConvLab2 01. Agenda-based User Simulator&lt;/a&gt; 中, </summary>
      
    
    
    
    <category term="对话系统" scheme="https://loveychen.github.io/categories/%E5%AF%B9%E8%AF%9D%E7%B3%BB%E7%BB%9F/"/>
    
    <category term="ConvLab2" scheme="https://loveychen.github.io/categories/%E5%AF%B9%E8%AF%9D%E7%B3%BB%E7%BB%9F/ConvLab2/"/>
    
    
    <category term="TOD" scheme="https://loveychen.github.io/tags/TOD/"/>
    
    <category term="ConvLab2" scheme="https://loveychen.github.io/tags/ConvLab2/"/>
    
    <category term="User Simulator" scheme="https://loveychen.github.io/tags/User-Simulator/"/>
    
    <category term="HUS" scheme="https://loveychen.github.io/tags/HUS/"/>
    
  </entry>
  
  <entry>
    <title>ConvLab2 01. Agenda-based User Simulator</title>
    <link href="https://loveychen.github.io/2021/04/14/intro-convlab2-user-simulator-agenda/"/>
    <id>https://loveychen.github.io/2021/04/14/intro-convlab2-user-simulator-agenda/</id>
    <published>2021-04-14T07:29:43.000Z</published>
    <updated>2025-08-05T17:48:18.794Z</updated>
    
    <content type="html"><![CDATA[<p>为了自动评估 ConvLab 对话系统的能力, ConvLab 提供了 User Simulator, 用来模拟用户.</p><p>User Simulator 中最重要的是 User Policy. User Policy 以预设的 User Goal 和 当前的系统答复 System Dialogue Acts 为输入, 最终输出 User Dialogue Acts.</p><p>ConvLab2 提供了两种类型的 User Policy:</p><ul><li>Agenda-based model</li><li>Neural Netword based model, 如 HUS 及其变种.</li></ul><h1>Agenda-based User Simulator</h1><p><strong>Agenda-based User Simulator</strong> 最早可以追溯到 2007 年 Jost Schatzmann / Blaise Thomson / Karl Weilhammer / Hui Ye / Steve Young 等人的论文 <a href="https://www.aclweb.org/anthology/N07-2038/">Agenda-based user simulation for bootstrapping a POMDP dialogue system</a>.</p><blockquote><p>Steve Young 是 Conversational AI 的先驱之一.</p></blockquote><p>而使用 Agenda-based 方法来进行对话管理, 则可以追溯到 1999 年 Alexander Rudnicky / Wei Xu 的论文 <a href="http://www.cs.cmu.edu/~xw/asru99-agenda.pdf">An agenda-based dialog management architecture for spoken language systems</a>.</p><blockquote><p><a href="https://www.collinsdictionary.com/dictionary/english/agenda">agenda</a> “议事日程; 议程表; 记事册”</p><ol><li>[Countable Noun] You can refer to the <strong>political issues which are important</strong> at a particular time as an agenda</li><li>[Countable Noun] An agenda is <strong>a list of the items</strong> that have to be discussed at a meeting.</li></ol></blockquote><blockquote><p><strong>User Agenda</strong></p><p>在 Jost Schatzmann 等人的工作中, Agenda 是一个栈式结构, 内部元素为正在处理或还未处理的 User Dialogue Acts (以完成 User Goal).</p><p>&quot; <strong>The user agenda A</strong> is a <strong>stack-like structure</strong> containing the <strong>pending user dialogue acts</strong> that are needed to elicit the information specified in the goal&quot;</p><p><a href="https://www.collinsdictionary.com/dictionary/english/pend">pend</a>, “悬吊, 悬挂; 悬而未决, 待决”</p><ol><li>[verb] to await judgement of settlement</li><li>[verb, dialect] to hang; depend</li><li>[noun, Scottish] an archway or vaulted passage (拱道, 拱廊)</li></ol><p><a href="https://www.collinsdictionary.com/dictionary/english/elicit">elicit</a> “引出, 探出, 诱出”</p><ol><li>[verb] If you elicit a response or a reaction, you do or say something which makes other people respond or react.</li><li>[verb] If you elicit a piece of information, you get it by asking the right questions.</li></ol></blockquote><p>Rudnicky 等人使用 Agenda 方法来进行对话管理, 属于系统层面的研究 (也是当前较为火热的研究方向, 最新技术一般是 <code>DST + POL</code> 来实现 DM 或者 直接使用 E2E 方式建模系统);</p><hr><p>Jost Schatzmann 则将 Agenda 的方法应用到 User Simulator 之上, 用以辅助 Dialogue System 的学习和评估.</p><p>Agenda-based User Simulator 是一个 模拟用户行为 的概率模型, 它主要依赖于两项输入:</p><ul><li>(a compact representation of the) <strong>User Goal</strong>. User Goal 包括两部分内容: Constraints 与 Requests. 其中 Constraints 是用户指定的限制条件, 而 Requests 是在对话过程中, 用户想要获取的信息.</li><li>(a stack-like) <strong>User Agenda</strong>. User Agenda 是一个栈式结构, 其元素是挂起的 User Act, 这些 User Act 用于在后续的对话中获取 (elicit) User Goal 中指定的需要获取的信息.</li></ul><p>举例来讲, 假设用户目标是在指定区域 <code>area=central</code> 搜索提供 <code>drinks=beer</code> 的酒吧 <code>type=bar</code>, 这些都是用户指定的限制条件, 即:</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>C</mi><mn>0</mn></msub><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>t</mi><mi>y</mi><mi>p</mi><mi>e</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">=</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>b</mi><mi>a</mi><mi>r</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>d</mi><mi>r</mi><mi>i</mi><mi>n</mi><mi>k</mi><mi>s</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">=</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>b</mi><mi>e</mi><mi>e</mi><mi>r</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>a</mi><mi>r</mi><mi>e</mi><mi>a</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">=</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>c</mi><mi>e</mi><mi>n</mi><mi>t</mi><mi>r</mi><mi>a</mi><mi>l</mi></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">C_0 = \begin{bmatrix}    type &amp;= &amp; bar \\    drinks &amp;= &amp; beer \\    area &amp;= &amp; central\end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:3.6em;vertical-align:-1.55em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"></span><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewBox="0 0 667 3600"><path d="M403 1759 V84 H666 V0 H319 V1759 v0 v1759 h347 v-84H403z M403 1759 V0 H319 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mord mathnormal">p</span><span class="mord mathnormal">e</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal" style="margin-right:0.03148em;">ink</span><span class="mord mathnormal">s</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="mord mathnormal">re</span><span class="mord mathnormal">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mrel">=</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mrel">=</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mrel">=</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">ba</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="mord mathnormal" style="margin-right:0.02778em;">eer</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">ce</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"></span><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewBox="0 0 667 3600"><path d="M347 1759 V0 H0 V84 H263 V1759 v0 v1759 H0 v84 H347zM347 1759 V0 H263 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span></span></span></span></span></span></span></span></span></span></span></span></p><p>用户需要在对话过程中, 获取酒吧名字 <code>name</code>, 具体地址 <code>addr</code> 及 电话 <code>phone</code>, 这三个则是用户目标中的 Request 部分, 即:</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>R</mi><mn>0</mn></msub><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>n</mi><mi>a</mi><mi>m</mi><mi>e</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">=</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo stretchy="false" lspace="0em" rspace="0em">?</mo></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>a</mi><mi>d</mi><mi>d</mi><mi>r</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">=</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo stretchy="false" lspace="0em" rspace="0em">?</mo></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>p</mi><mi>h</mi><mi>o</mi><mi>n</mi><mi>e</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">=</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo stretchy="false" lspace="0em" rspace="0em">?</mo></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">R_0 = \begin{bmatrix}    name &amp;= &amp; ? \\    addr &amp;= &amp; ? \\    phone &amp;= &amp; ?\end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:3.6em;vertical-align:-1.55em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"></span><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewBox="0 0 667 3600"><path d="M403 1759 V84 H666 V0 H319 V1759 v0 v1759 h347 v-84H403z M403 1759 V0 H319 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">nam</span><span class="mord mathnormal">e</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="mord mathnormal">dd</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="mord mathnormal">h</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord mathnormal">e</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mrel">=</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mrel">=</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mrel">=</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mclose">?</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mclose">?</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mclose">?</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"></span><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewBox="0 0 667 3600"><path d="M347 1759 V0 H0 V84 H263 V1759 v0 v1759 H0 v84 H347zM347 1759 V0 H263 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span></span></span></span></span></span></span></span></span></span></span></span></p><p>User Agenda 是 Pending User Action 组成的栈式结构, 示例如下:</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>A</mi><mn>0</mn></msub><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>i</mi><mi>n</mi><mi>f</mi><mi>o</mi><mi>r</mi><mi>m</mi><mo stretchy="false">(</mo><mi>t</mi><mi>y</mi><mi>p</mi><mi>e</mi><mo>=</mo><mi>b</mi><mi>a</mi><mi>r</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>i</mi><mi>n</mi><mi>f</mi><mi>o</mi><mi>r</mi><mi>m</mi><mo stretchy="false">(</mo><mi>d</mi><mi>r</mi><mi>i</mi><mi>n</mi><mi>k</mi><mi>s</mi><mo>=</mo><mi>b</mi><mi>e</mi><mi>e</mi><mi>r</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>i</mi><mi>n</mi><mi>f</mi><mi>o</mi><mi>r</mi><mi>m</mi><mo stretchy="false">(</mo><mi>a</mi><mi>r</mi><mi>e</mi><mi>a</mi><mo>=</mo><mi>c</mi><mi>e</mi><mi>n</mi><mi>t</mi><mi>r</mi><mi>a</mi><mi>l</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>r</mi><mi>e</mi><mi>q</mi><mi>u</mi><mi>e</mi><mi>s</mi><mi>t</mi><mo stretchy="false">(</mo><mi>n</mi><mi>a</mi><mi>m</mi><mi>e</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>r</mi><mi>e</mi><mi>q</mi><mi>u</mi><mi>e</mi><mi>s</mi><mi>t</mi><mo stretchy="false">(</mo><mi>a</mi><mi>d</mi><mi>d</mi><mi>r</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>r</mi><mi>e</mi><mi>q</mi><mi>u</mi><mi>e</mi><mi>s</mi><mi>t</mi><mo stretchy="false">(</mo><mi>p</mi><mi>h</mi><mi>o</mi><mi>n</mi><mi>e</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>b</mi><mi>y</mi><mi>e</mi><mo stretchy="false">(</mo><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">A_0 = \begin{bmatrix}    inform(type = bar) \\    inform(drinks = beer) \\    inform(area = central) \\    request(name) \\    request(addr) \\    request(phone) \\    bye()\end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:8.4001em;vertical-align:-3.9501em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:4.4499em;"><span style="top:-6.4499em;"><span class="pstrut" style="height:10.4em;"></span><span style="width:0.667em;height:8.400em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="8.400em" viewBox="0 0 667 8400"><path d="M403 1759 V84 H666 V0 H319 V1759 v4800 v1759 h347 v-84H403z M403 1759 V0 H319 V1759 v4800 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.9501em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:4.45em;"><span style="top:-6.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">in</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord mathnormal" style="margin-right:0.02778em;">or</span><span class="mord mathnormal">m</span><span class="mopen">(</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mord mathnormal">p</span><span class="mord mathnormal">e</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord mathnormal">ba</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mclose">)</span></span></span><span style="top:-5.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">in</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord mathnormal" style="margin-right:0.02778em;">or</span><span class="mord mathnormal">m</span><span class="mopen">(</span><span class="mord mathnormal">d</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal" style="margin-right:0.03148em;">ink</span><span class="mord mathnormal">s</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord mathnormal">b</span><span class="mord mathnormal" style="margin-right:0.02778em;">eer</span><span class="mclose">)</span></span></span><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">in</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord mathnormal" style="margin-right:0.02778em;">or</span><span class="mord mathnormal">m</span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mord mathnormal">re</span><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord mathnormal">ce</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mclose">)</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">re</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mord mathnormal">u</span><span class="mord mathnormal">es</span><span class="mord mathnormal">t</span><span class="mopen">(</span><span class="mord mathnormal">nam</span><span class="mord mathnormal">e</span><span class="mclose">)</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">re</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mord mathnormal">u</span><span class="mord mathnormal">es</span><span class="mord mathnormal">t</span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mord mathnormal">dd</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mclose">)</span></span></span><span style="top:-0.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">re</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mord mathnormal">u</span><span class="mord mathnormal">es</span><span class="mord mathnormal">t</span><span class="mopen">(</span><span class="mord mathnormal">p</span><span class="mord mathnormal">h</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord mathnormal">e</span><span class="mclose">)</span></span></span><span style="top:0.59em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="mord mathnormal">ye</span><span class="mopen">(</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.95em;"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:4.4499em;"><span style="top:-6.4499em;"><span class="pstrut" style="height:10.4em;"></span><span style="width:0.667em;height:8.400em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="8.400em" viewBox="0 0 667 8400"><path d="M347 1759 V0 H0 V84 H263 V1759 v4800 v1759 H0 v84 H347zM347 1759 V0 H263 V1759 v4800 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.9501em;"><span></span></span></span></span></span></span></span></span></span></span></span></p><p>User Goal 和 User Agenda 组成了 User Simulator 的 <strong>User Dialogue State</strong>, 即:</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>S</mi><mo>=</mo><mo>&lt;</mo><mi>A</mi><mo separator="true">,</mo><mi>G</mi><mo>&gt;</mo><mspace linebreak="newline"></mspace><mi>G</mi><mo>=</mo><mo>&lt;</mo><mi>C</mi><mo separator="true">,</mo><mi>R</mi><mo>&gt;</mo></mrow><annotation encoding="application/x-tex">S = &lt;A, G&gt; \\G = &lt;C, R&gt;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7224em;vertical-align:-0.0391em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">A</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">G</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&gt;</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:0.7224em;vertical-align:-0.0391em;"></span><span class="mord mathnormal">G</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&gt;</span></span></span></span></span></p><p>其中 S 表示 State, A 表示 Agenda, G 表示 User Goal, C 表示 Constraints, R 表示 Requests.</p><blockquote><p><strong>重点</strong><br>User Dialogue State 由 User Agenda 和 User Goal 组成.<br>User Goal 可以分为 Constraints 和 Requests 两部分, 分别表示用户的限制条件 和 需要在对话中获取的信息.<br>User Agenda 则是由 User Dialogue Act 组成的栈式结构.<br>Dialogue Act 在多领域对话系统中常常表示为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>&lt;</mo><mi>D</mi><mi>o</mi><mi>m</mi><mi>a</mi><mi>i</mi><mi>n</mi><mo separator="true">,</mo><mi>I</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>n</mi><mi>t</mi><mo separator="true">,</mo><mi>S</mi><mi>l</mi><mi>o</mi><mi>t</mi><mo separator="true">,</mo><mi>V</mi><mi>a</mi><mi>l</mi><mi>u</mi><mi>e</mi><mo>&gt;</mo></mrow><annotation encoding="application/x-tex">&lt;Domain, Intent, Slot, Value&gt;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">Do</span><span class="mord mathnormal">main</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">Sl</span><span class="mord mathnormal">o</span><span class="mord mathnormal">t</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">Va</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">u</span><span class="mord mathnormal">e</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&gt;</span></span></span></span> 四元组组成的集合. 在单领域对话系统中, 可以省去 Domain 元素, 简化为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>&lt;</mo><mi>I</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>n</mi><mi>t</mi><mo separator="true">,</mo><mi>S</mi><mi>l</mi><mi>o</mi><mi>t</mi><mo separator="true">,</mo><mi>V</mi><mi>a</mi><mi>l</mi><mi>u</mi><mi>e</mi><mo>&gt;</mo></mrow><annotation encoding="application/x-tex">&lt;Intent, Slot, Value&gt;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">Sl</span><span class="mord mathnormal">o</span><span class="mord mathnormal">t</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">Va</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">u</span><span class="mord mathnormal">e</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&gt;</span></span></span></span> 三元组.</p></blockquote><hr><p>而 Dialogue State 与 Dialogue Act 组成了一个 Dialogue, 即:</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mo>⋯</mo><mo>→</mo><msub><mi>S</mi><mi>t</mi></msub><mover><mo stretchy="true" minsize="3.0em">→</mo><mpadded width="+0.6em" lspace="0.3em"><msub><mi>a</mi><mi>u</mi></msub></mpadded></mover><msubsup><mi>S</mi><mi>t</mi><msup><mrow></mrow><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></msubsup><mover><mo stretchy="true" minsize="3.0em">→</mo><mpadded width="+0.6em" lspace="0.3em"><msub><mi>a</mi><mi>m</mi></msub></mpadded></mover><msub><mi>S</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub><mo>→</mo><mo>⋯</mo></mrow><annotation encoding="application/x-tex">\cdots \rightarrow S_t \xrightarrow{a_u} S_t^{&#x27;} \xrightarrow{a_m} S_{t+1} \rightarrow \cdots</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"></span><span class="minner">⋯</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0734em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel x-arrow"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9234em;"><span style="top:-3.322em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight x-arrow-pad"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1645em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">u</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span><span class="svg-align" style="top:-2.689em;"><span class="pstrut" style="height:2.7em;"></span><span class="hide-tail" style="height:0.522em;min-width:1.469em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="0.522em" viewBox="0 0 400000 522" preserveAspectRatio="xMaxYMin slice"><path d="M0 241v40h399891c-47.3 35.3-84 78-110 128-16.7 32-27.7 63.7-33 95 0 1.3-.2 2.7-.5 4-.3 1.3-.5 2.3-.5 3 0 7.3 6.7 11 20 11 8 0 13.2-.8 15.5-2.5 2.3-1.7 4.2-5.5 5.5-11.5 2-13.3 5.7-27 11-41 14.7-44.7 39-84.5 73-119.5s73.7-60.2 119-75.5c6-2 9-5.7 9-11s-3-9-9-11c-45.3-15.3-85-40.5-119-75.5s-58.3-74.8-73-119.5c-4.7-14-8.3-27.3-11-40-1.3-6.7-3.2-10.8-5.5-12.5-2.3-1.7-7.5-2.5-15.5-2.5-14 0-21 3.7-21 11 0 2 2 10.3 6 25 20.7 83.3 67 151.7 139 205zm0 0v40h399900v-40z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.011em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.2395em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9925em;"><span style="top:-2.453em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8278em;"><span style="top:-2.931em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel x-arrow"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9234em;"><span style="top:-3.322em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight x-arrow-pad"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1645em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span><span class="svg-align" style="top:-2.689em;"><span class="pstrut" style="height:2.7em;"></span><span class="hide-tail" style="height:0.522em;min-width:1.469em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="0.522em" viewBox="0 0 400000 522" preserveAspectRatio="xMaxYMin slice"><path d="M0 241v40h399891c-47.3 35.3-84 78-110 128-16.7 32-27.7 63.7-33 95 0 1.3-.2 2.7-.5 4-.3 1.3-.5 2.3-.5 3 0 7.3 6.7 11 20 11 8 0 13.2-.8 15.5-2.5 2.3-1.7 4.2-5.5 5.5-11.5 2-13.3 5.7-27 11-41 14.7-44.7 39-84.5 73-119.5s73.7-60.2 119-75.5c6-2 9-5.7 9-11s-3-9-9-11c-45.3-15.3-85-40.5-119-75.5s-58.3-74.8-73-119.5c-4.7-14-8.3-27.3-11-40-1.3-6.7-3.2-10.8-5.5-12.5-2.3-1.7-7.5-2.5-15.5-2.5-14 0-21 3.7-21 11 0 2 2 10.3 6 25 20.7 83.3 67 151.7 139 205zm0 0v40h399900v-40z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.011em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8917em;vertical-align:-0.2083em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.313em;"></span><span class="minner">⋯</span></span></span></span></span></p><p>即在时刻 t, 用户处于状态 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>S</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">S_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>, 此时产生 User Action <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mi>u</mi></msub></mrow><annotation encoding="application/x-tex">a_u</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">u</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>, 用户进入临时状态 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>S</mi><mi>t</mi><msup><mrow></mrow><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></msubsup></mrow><annotation encoding="application/x-tex">S_{t}^{&#x27;}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1895em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9425em;"><span style="top:-2.453em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8278em;"><span style="top:-2.931em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span></span></span></span>. (<em>系统响应用户输入动作, 产生 System Action <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mi>m</mi></msub></mrow><annotation encoding="application/x-tex">a_m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></em>). 用户接受系统响应 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mi>m</mi></msub></mrow><annotation encoding="application/x-tex">a_m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>, 进入到下一时刻状态 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>S</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub></mrow><annotation encoding="application/x-tex">S_{t+1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8917em;vertical-align:-0.2083em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span></span></span></span>.</p><p>基于上述用户与系统的交互流程, 用户建模可以划分为三个部分:</p><ul><li>Action Selection: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><msub><mi>a</mi><mi>u</mi></msub><mi mathvariant="normal">∣</mi><msub><mi>S</mi><mi>t</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P(a_u | S_t)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">u</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">∣</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>, 用户在对话状态 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>S</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">S_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 下, 产生 User Action <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mi>u</mi></msub></mrow><annotation encoding="application/x-tex">a_u</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">u</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 的概率.</li><li>User action based State Transition: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><msubsup><mi>S</mi><mi>t</mi><msup><mrow></mrow><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></msubsup><mi mathvariant="normal">∣</mi><msub><mi>a</mi><mi>u</mi></msub><mo separator="true">,</mo><msub><mi>S</mi><mi>t</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P(S_t^{&#x27;} | a_u, S_t)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1925em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9425em;"><span style="top:-2.453em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8278em;"><span style="top:-2.931em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mord">∣</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">u</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>, 用户在对话状态 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>S</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">S_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 执行 User Action <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mi>u</mi></msub></mrow><annotation encoding="application/x-tex">a_u</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">u</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>, 转移到临时状态 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>S</mi><mi>t</mi><msup><mrow></mrow><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></msubsup></mrow><annotation encoding="application/x-tex">S_t^{&#x27;}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1895em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9425em;"><span style="top:-2.453em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8278em;"><span style="top:-2.931em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span></span></span></span> 的概率</li><li>System action based State Transition: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><msub><mi>S</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub><mi mathvariant="normal">∣</mi><msub><mi>a</mi><mi>m</mi></msub><mo separator="true">,</mo><msubsup><mi>S</mi><mi>t</mi><msup><mrow></mrow><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></msubsup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P(S_{t+1} | a_m, S_t^{&#x27;})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1925em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mord">∣</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9425em;"><span style="top:-2.453em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8278em;"><span style="top:-2.931em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>, 用户在临时状态 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>S</mi><mi>t</mi><msup><mrow></mrow><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></msubsup></mrow><annotation encoding="application/x-tex">S_t^{&#x27;}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1895em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9425em;"><span style="top:-2.453em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8278em;"><span style="top:-2.931em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span></span></span></span> 下接收 System Action <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mi>m</mi></msub></mrow><annotation encoding="application/x-tex">a_m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 转移到新的状态 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>S</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub></mrow><annotation encoding="application/x-tex">S_{t+1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8917em;vertical-align:-0.2083em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span></span></span></span> 的概率</li></ul><hr><p>Agenda-based User Simulator 的工作过程如下:</p><ol><li><p>在对话开始时, Simulator 会随机设置 User Goal. 而 User Goal 中的 Constraints 则转换成 <strong>Inform Acts</strong> 压入 Agenda 中, User Goal 中的 Requests 则转换为 <strong>Request Acts</strong> 压入 Agenda 中.</p></li><li><p>在对话过程中, User Goal 和 Agenda 都会动态更新. Agenda 的顶部元素会用来生成 User Act <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mi>u</mi></msub></mrow><annotation encoding="application/x-tex">a_u</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">u</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>; 而系统响应 System Act <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mi>m</mi></msub></mrow><annotation encoding="application/x-tex">a_m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 到来时, 新的 User Acts 被压入 Agenda 中, 而不再需要的 User Acts 则从 Agenda 中移除. <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mi>m</mi></msub></mrow><annotation encoding="application/x-tex">a_m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 中携带的槽位信息会用于更新 User Goal (主要跟新 User Goal 中的 Requests 部分).</p></li></ol><p>关于 Simulator 的工作过程, 建议参考文章 <a href="https://www.aclweb.org/anthology/N07-2038/">Schatzmann et al, 2017, Agenda-based user simulation for bootstrapping a POMDP dialogue system</a> 中的 Figure 1 给出的示例.</p><h2 id="User-Action-Selection-Model">User Action Selection Model</h2><p>User Simulator 的第一个问题是 <strong>User Action Selection</strong>  <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><msub><mi>a</mi><mi>u</mi></msub><mi mathvariant="normal">∣</mi><msub><mi>S</mi><mi>t</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P(a_u | S_t)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">u</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">∣</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>, 即用户在对话状态 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>S</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">S_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 下, 生成 User Action <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mi>u</mi></msub></mrow><annotation encoding="application/x-tex">a_u</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">u</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 的概率.</p><p>如前所述, 对话状态由 User Agenda 和 User Goal 两部分组成,  <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mo>=</mo><mo>&lt;</mo><mi>A</mi><mo separator="true">,</mo><mi>G</mi><mo>&gt;</mo></mrow><annotation encoding="application/x-tex">S = &lt;A, G&gt;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7224em;vertical-align:-0.0391em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">A</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">G</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&gt;</span></span></span></span>,  因此可以将 User Action Selection Model 进行拆分:</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><msub><mi>a</mi><mi>u</mi></msub><mi mathvariant="normal">∣</mi><msub><mi>S</mi><mi>t</mi></msub><mo stretchy="false">)</mo><mover><mo stretchy="true" minsize="3.0em">=</mo><mpadded width="+0.6em" lspace="0.3em"><mrow><msub><mi>S</mi><mi>t</mi></msub><mo>=</mo><mo>&lt;</mo><msub><mi>A</mi><mi>t</mi></msub><mo separator="true">,</mo><msub><mi>G</mi><mi>t</mi></msub><mo>&gt;</mo></mrow></mpadded></mover><mi>P</mi><mo stretchy="false">(</mo><msub><mi>a</mi><mi>u</mi></msub><mi mathvariant="normal">∣</mi><mo>&lt;</mo><msub><mi>A</mi><mi>t</mi></msub><mo separator="true">,</mo><msub><mi>G</mi><mi>t</mi></msub><mo>&gt;</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P(a_u | S_t) \xlongequal{S_t = &lt;A_t, G_t&gt;} P(a_u | &lt;A_t, G_t&gt;)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2563em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">u</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">∣</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel x-arrow"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.0063em;"><span style="top:-3.228em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight x-arrow-pad"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2963em;"><span style="top:-2.357em;margin-left:-0.0576em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mrel mtight">=&lt;</span><span class="mord mtight"><span class="mord mathnormal mtight">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2963em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mpunct mtight">,</span><span class="mord mtight"><span class="mord mathnormal mtight">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2963em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mrel mtight">&gt;</span></span></span></span><span class="svg-align" style="top:-2.783em;"><span class="pstrut" style="height:2.7em;"></span><span class="hide-tail" style="height:0.334em;min-width:0.888em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="0.334em" viewBox="0 0 400000 334" preserveAspectRatio="xMinYMin slice"><path d="M0 50 h400000 v40H0z m0 194h40000v40H0zM0 50 h400000 v40H0z m0 194h40000v40H0z"/></svg></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">u</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">∣</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&gt;</span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mclose">)</span></span></span></span></span></p><p>又因为当前 User Action 的选择与当前的 User Goal 没有直接关系 (User Goal 中的信息已经在 Agenda 中体现了), 因此, 问题可以简化为:</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi>P</mi><mo stretchy="false">(</mo><msub><mi>a</mi><mi>u</mi></msub><mi mathvariant="normal">∣</mi><msub><mi>S</mi><mi>t</mi></msub><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mi>P</mi><mo stretchy="false">(</mo><msub><mi>a</mi><mi>u</mi></msub><mi mathvariant="normal">∣</mi><mo>&lt;</mo><msub><mi>A</mi><mi>t</mi></msub><mo separator="true">,</mo><msub><mi>G</mi><mi>t</mi></msub><mo>&gt;</mo><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mi>P</mi><mo stretchy="false">(</mo><msub><mi>a</mi><mi>u</mi></msub><mi mathvariant="normal">∣</mi><msub><mi>A</mi><mi>t</mi></msub><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned}P(a_u | S_t) &amp; = P(a_u | &lt;A_t, G_t&gt;) \\    &amp; = P(a_u | A_t)\end{aligned}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:3em;vertical-align:-1.25em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.75em;"><span style="top:-3.91em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">u</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">∣</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.25em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.75em;"><span style="top:-3.91em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">u</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">∣</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&gt;</span><span class="mclose">)</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">u</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">∣</span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.25em;"><span></span></span></span></span></span></span></span></span></span></span></span></p><p>我们只使用了 Agenda 中优先级最高的顶部 n 个元素 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mo stretchy="false">[</mo><mo>−</mo><mi>n</mi><mo>:</mo><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">A[-n:]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">A</span><span class="mopen">[</span><span class="mord">−</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">:</span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mclose">]</span></span></span></span> 参与预测  User Action <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mi>u</mi></msub></mrow><annotation encoding="application/x-tex">a_u</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">u</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>, 则问题建模可做如下简化:</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi>P</mi><mo stretchy="false">(</mo><msub><mi>a</mi><mi>u</mi></msub><mi mathvariant="normal">∣</mi><msub><mi>S</mi><mi>t</mi></msub><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mi>P</mi><mo stretchy="false">(</mo><msub><mi>a</mi><mi>u</mi></msub><mi mathvariant="normal">∣</mi><mo>&lt;</mo><msub><mi>A</mi><mi>t</mi></msub><mo separator="true">,</mo><msub><mi>G</mi><mi>t</mi></msub><mo>&gt;</mo><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mi>P</mi><mo stretchy="false">(</mo><msub><mi>a</mi><mi>u</mi></msub><mi mathvariant="normal">∣</mi><msub><mi>A</mi><mi>t</mi></msub><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mi>P</mi><mo stretchy="false">(</mo><msub><mi>a</mi><mi>u</mi></msub><mi mathvariant="normal">∣</mi><msub><mi>A</mi><mi>t</mi></msub><mo stretchy="false">[</mo><mo>−</mo><mi>n</mi><mo>:</mo><mo stretchy="false">]</mo><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mi>δ</mi><mo stretchy="false">(</mo><msub><mi>a</mi><mi>u</mi></msub><mo separator="true">,</mo><msub><mi>A</mi><mi>t</mi></msub><mo stretchy="false">[</mo><mo>−</mo><mi>n</mi><mo>:</mo><mo stretchy="false">]</mo><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned}P(a_u | S_t) &amp; = P(a_u | &lt;A_t, G_t&gt;) \\    &amp; = P(a_u | A_t) \\    &amp;= P(a_u | A_t[-n:]) \\    &amp;= \delta (a_u, A_t [-n:])\end{aligned}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:6em;vertical-align:-2.75em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.25em;"><span style="top:-5.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">u</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">∣</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-3.91em;"><span class="pstrut" style="height:3em;"></span><span class="mord"></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"></span></span><span style="top:-0.91em;"><span class="pstrut" style="height:3em;"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.75em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.25em;"><span style="top:-5.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">u</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">∣</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&gt;</span><span class="mclose">)</span></span></span><span style="top:-3.91em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">u</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">∣</span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">u</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">∣</span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">[</span><span class="mord">−</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">:</span><span class="mclose">])</span></span></span><span style="top:-0.91em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord mathnormal" style="margin-right:0.03785em;">δ</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">u</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">[</span><span class="mord">−</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">:</span><span class="mclose">])</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.75em;"><span></span></span></span></span></span></span></span></span></span></span></span></p><h2 id="User-action-based-State-Transition-Model">User action based State Transition Model</h2><p>User Simulator 的第二个问题是 <strong>User action based State Transition</strong>, 即: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><msubsup><mi>S</mi><mi>t</mi><msup><mrow></mrow><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></msubsup><mi mathvariant="normal">∣</mi><msub><mi>a</mi><mi>u</mi></msub><mo separator="true">,</mo><msub><mi>S</mi><mi>t</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P(S_t^{&#x27;} | a_u, S_t)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1925em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9425em;"><span style="top:-2.453em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8278em;"><span style="top:-2.931em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mord">∣</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">u</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>, 用户在状态 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>S</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">S_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 下执行 User Action <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mi>u</mi></msub></mrow><annotation encoding="application/x-tex">a_u</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">u</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>, 转移到临时状态 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>S</mi><mi>t</mi><msup><mrow></mrow><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></msubsup></mrow><annotation encoding="application/x-tex">S_t^{&#x27;}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1895em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9425em;"><span style="top:-2.453em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8278em;"><span style="top:-2.931em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span></span></span></span> 的概率.</p><p>同样, 我们需要根据 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mo>=</mo><mo>&lt;</mo><mi>A</mi><mo separator="true">,</mo><mi>G</mi><mo>&gt;</mo></mrow><annotation encoding="application/x-tex">S = &lt;A, G&gt;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7224em;vertical-align:-0.0391em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">A</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">G</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&gt;</span></span></span></span> 对模型进行拆分, 因此:</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><msubsup><mi>S</mi><mi>t</mi><msup><mrow></mrow><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></msubsup><mi mathvariant="normal">∣</mi><msub><mi>a</mi><mi>u</mi></msub><mo separator="true">,</mo><msub><mi>S</mi><mi>t</mi></msub><mo stretchy="false">)</mo><mover><mo stretchy="true" minsize="3.0em">=</mo><mpadded width="+0.6em" lspace="0.3em"><mrow><msub><mi>S</mi><mi>t</mi></msub><mo>=</mo><mo>&lt;</mo><msub><mi>A</mi><mi>t</mi></msub><mo separator="true">,</mo><msub><mi>G</mi><mi>t</mi></msub><mo>&gt;</mo></mrow></mpadded></mover><mi>P</mi><mo stretchy="false">(</mo><mo>&lt;</mo><msubsup><mi>A</mi><mi>t</mi><msup><mrow></mrow><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></msubsup><mo separator="true">,</mo><msubsup><mi>G</mi><mi>t</mi><msup><mrow></mrow><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></msubsup><mo>&gt;</mo><mi mathvariant="normal">∣</mi><msub><mi>a</mi><mi>u</mi></msub><mo separator="true">,</mo><mo>&lt;</mo><msub><mi>A</mi><mi>t</mi></msub><mo separator="true">,</mo><msub><mi>G</mi><mi>t</mi></msub><mo>&gt;</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P(S_t^{&#x27;} | a_u, S_t)  \xlongequal{S_t = &lt;A_t, G_t&gt;} P(&lt;A_t^{&#x27;}, G_t^{&#x27;}&gt; | a_u, &lt;A_t, G_t&gt;)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2563em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9925em;"><span style="top:-2.453em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8278em;"><span style="top:-2.931em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mord">∣</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">u</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel x-arrow"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.0063em;"><span style="top:-3.228em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight x-arrow-pad"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2963em;"><span style="top:-2.357em;margin-left:-0.0576em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mrel mtight">=&lt;</span><span class="mord mtight"><span class="mord mathnormal mtight">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2963em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mpunct mtight">,</span><span class="mord mtight"><span class="mord mathnormal mtight">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2963em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mrel mtight">&gt;</span></span></span></span><span class="svg-align" style="top:-2.783em;"><span class="pstrut" style="height:2.7em;"></span><span class="hide-tail" style="height:0.334em;min-width:0.888em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="0.334em" viewBox="0 0 400000 334" preserveAspectRatio="xMinYMin slice"><path d="M0 50 h400000 v40H0z m0 194h40000v40H0zM0 50 h400000 v40H0z m0 194h40000v40H0z"/></svg></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.2395em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9925em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8278em;"><span style="top:-2.931em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9925em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8278em;"><span style="top:-2.931em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">∣</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">u</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&gt;</span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mclose">)</span></span></span></span></span></p><p>其中 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>A</mi><mi>t</mi><msup><mrow></mrow><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></msubsup><mo separator="true">,</mo><msubsup><mi>G</mi><mi>t</mi><msup><mrow></mrow><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></msubsup></mrow><annotation encoding="application/x-tex">A_t^{&#x27;}, G_t^{&#x27;}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1895em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9425em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8278em;"><span style="top:-2.931em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9425em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8278em;"><span style="top:-2.931em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span></span></span></span> 分别代表执行 User Action <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mi>u</mi></msub></mrow><annotation encoding="application/x-tex">a_u</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">u</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 后, 临时的 User Agenda 和 User Goal.</p><p>同时, 我们假设 Simulator 在执行 User Act 时, 其 User Goal 是不变化的, 即</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msubsup><mi>G</mi><mi>t</mi><msup><mrow></mrow><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></msubsup><mo>↮</mo><msub><mi>a</mi><mi>u</mi></msub></mrow><annotation encoding="application/x-tex">G_t^{&#x27;}  \nleftrightarrow a_u</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2395em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord mathnormal">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9925em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8278em;"><span style="top:-2.931em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel amsrm">↮</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">u</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></p><p>同时, 根据前述的 User Action Selection 模型可知, User Action <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mi>u</mi></msub></mrow><annotation encoding="application/x-tex">a_u</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">u</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 是一个关于 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>A</mi><mi>t</mi></msub><mo stretchy="false">[</mo><mo>−</mo><mi>n</mi><mo>:</mo><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">A_t [-n:]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">[</span><span class="mord">−</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">:</span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mclose">]</span></span></span></span> 的函数,</p><p>因此 System State Transition 可以拆分为:</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi>P</mi><mo stretchy="false">(</mo><msubsup><mi>S</mi><mi>t</mi><msup><mrow></mrow><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></msubsup><mi mathvariant="normal">∣</mi><msub><mi>a</mi><mi>u</mi></msub><mo separator="true">,</mo><msub><mi>S</mi><mi>t</mi></msub><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mi>P</mi><mo stretchy="false">(</mo><mo>&lt;</mo><msubsup><mi>A</mi><mi>t</mi><msup><mrow></mrow><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></msubsup><mo separator="true">,</mo><msubsup><mi>G</mi><mi>t</mi><msup><mrow></mrow><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></msubsup><mo>&gt;</mo><mi mathvariant="normal">∣</mi><msub><mi>a</mi><mi>u</mi></msub><mo separator="true">,</mo><mo>&lt;</mo><msub><mi>A</mi><mi>t</mi></msub><mo separator="true">,</mo><msub><mi>G</mi><mi>t</mi></msub><mo>&gt;</mo><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mi>g</mi><mo stretchy="false">(</mo><msubsup><mi>A</mi><mi>t</mi><msup><mrow></mrow><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></msubsup><mo separator="true">,</mo><msub><mi>A</mi><mi>t</mi></msub><mo stretchy="false">)</mo><mo>∗</mo><mi>f</mi><mo stretchy="false">(</mo><msubsup><mi>G</mi><mi>t</mi><msup><mrow></mrow><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></msubsup><mo separator="true">,</mo><msub><mi>G</mi><mi>t</mi></msub><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned}P(S_t^{&#x27;} | a_u, S_t) &amp;= P(&lt;A_t^{&#x27;}, G_t^{&#x27;}&gt; | a_u, &lt;A_t, G_t&gt;) \\&amp;= g(A_t^{&#x27;}, A_t) * f(G_t^{&#x27;}, G_t)\end{aligned}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:3.305em;vertical-align:-1.4025em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.9025em;"><span style="top:-3.91em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9925em;"><span style="top:-2.453em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8278em;"><span style="top:-2.931em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mord">∣</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">u</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-2.2575em;"><span class="pstrut" style="height:3em;"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.4025em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.9025em;"><span style="top:-3.91em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9925em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8278em;"><span style="top:-2.931em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9925em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8278em;"><span style="top:-2.931em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord">∣</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">u</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&gt;</span><span class="mclose">)</span></span></span><span style="top:-2.2575em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9925em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8278em;"><span style="top:-2.931em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9925em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8278em;"><span style="top:-2.931em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.4025em;"><span></span></span></span></span></span></span></span></span></span></span></span></p><h2 id="System-action-based-State-Transition-Model">System action based State Transition Model</h2><p>与 System State Transition Model 类似, 遵循如下几个原则</p><ul><li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>A</mi><mi>t</mi><msup><mrow></mrow><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></msubsup></mrow><annotation encoding="application/x-tex">A_t^{&#x27;}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1895em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9425em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8278em;"><span style="top:-2.931em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span></span></span></span> 与 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>G</mi><mi>t</mi><msup><mrow></mrow><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></msubsup></mrow><annotation encoding="application/x-tex">G_t^{&#x27;}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1895em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord mathnormal">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9425em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8278em;"><span style="top:-2.931em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span></span></span></span> 没有其它限制</li><li>新的 User Goal <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>G</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub></mrow><annotation encoding="application/x-tex">G_{t+1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8917em;vertical-align:-0.2083em;"></span><span class="mord"><span class="mord mathnormal">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span></span></span></span> 条件独立于 Agenda <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>A</mi><mi>t</mi></msub><msup><mrow></mrow><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></mrow><annotation encoding="application/x-tex">A_t{&#x27;}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9019em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord"><span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span></li><li>链式条件概率法则</li></ul><p>User State Transition Model 可以如下分解</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi>P</mi><mo stretchy="false">(</mo><msub><mi>S</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub><mi mathvariant="normal">∣</mi><msub><mi>a</mi><mi>m</mi></msub><mo separator="true">,</mo><msubsup><mi>S</mi><mi>t</mi><msup><mrow></mrow><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></msubsup><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mi>P</mi><mo stretchy="false">(</mo><mo>&lt;</mo><msub><mi>A</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub><mo separator="true">,</mo><msub><mi>G</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub><mo>&gt;</mo><mi mathvariant="normal">∣</mi><msub><mi>a</mi><mi>u</mi></msub><mo separator="true">,</mo><mo>&lt;</mo><msubsup><mi>A</mi><mi>t</mi><msup><mrow></mrow><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></msubsup><mo separator="true">,</mo><msubsup><mi>G</mi><mi>t</mi><msup><mrow></mrow><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></msubsup><mo>&gt;</mo><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><munder><munder><mrow><mi>P</mi><mo stretchy="false">(</mo><msub><mi>A</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub><mi mathvariant="normal">∣</mi><msub><mi>a</mi><mi>m</mi></msub><mo separator="true">,</mo><msubsup><mi>A</mi><mi>t</mi><msup><mrow></mrow><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></msubsup><mo separator="true">,</mo><msub><mi>G</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub><mo stretchy="false">)</mo></mrow><mo stretchy="true">⏟</mo></munder><mtext>agenda update</mtext></munder><mo>∗</mo><munder><munder><mrow><mi>P</mi><mo stretchy="false">(</mo><msub><mi>G</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub><mi mathvariant="normal">∣</mi><msub><mi>a</mi><mi>m</mi></msub><mo separator="true">,</mo><msubsup><mi>G</mi><mi>t</mi><msup><mrow></mrow><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></msubsup><mo stretchy="false">)</mo></mrow><mo stretchy="true">⏟</mo></munder><mtext>goal update</mtext></munder></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned}P(S_{t+1} | a_m, S_t^{&#x27;}) &amp;= P( &lt;A_{t+1}, G_{t+1}&gt; | a_u, &lt;A_t^{&#x27;}, G_t^{&#x27;}&gt;) \\&amp;= \underbrace{P(A_{t+1} | a_m, A_t^{&#x27;}, G_{t+1})}_{\text{agenda update}} * \underbrace{P(G_{t+1} | a_m, G_t^{&#x27;})}_{\text{goal update}}\end{aligned}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:4.6652em;vertical-align:-2.0826em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.5826em;"><span style="top:-4.5901em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mord">∣</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9925em;"><span style="top:-2.453em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8278em;"><span style="top:-2.931em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-2.9376em;"><span class="pstrut" style="height:3em;"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.0826em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.5826em;"><span style="top:-4.5901em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord">∣</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">u</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9925em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8278em;"><span style="top:-2.931em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9925em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8278em;"><span style="top:-2.931em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&gt;</span><span class="mclose">)</span></span></span><span style="top:-2.9376em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord munder"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9925em;"><span style="top:-1.4159em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">agenda update</span></span></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord munder"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9925em;"><span class="svg-align" style="top:-2.102em;"><span class="pstrut" style="height:3em;"></span><span class="stretchy" style="height:0.548em;min-width:1.6em;"><span class="brace-left" style="height:0.548em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="0.548em" viewBox="0 0 400000 548" preserveAspectRatio="xMinYMin slice"><path d="M0 6l6-6h17c12.688 0 19.313.3 20 1 4 4 7.313 8.3 10 13 35.313 51.3 80.813 93.8 136.5 127.5 55.688 33.7 117.188 55.8 184.5 66.5.688 0 2 .3 4 1 18.688 2.7 76 4.3 172 5h399450v120H429l-6-1c-124.688-8-235-61.7-331-161C60.687 138.7 32.312 99.3 7 54L0 41V6z"/></svg></span><span class="brace-center" style="height:0.548em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="0.548em" viewBox="0 0 400000 548" preserveAspectRatio="xMidYMin slice"><path d="M199572 214c100.7 8.3 195.3 44 280 108 55.3 42 101.7 93 139 153l9 14c2.7-4 5.7-8.7 9-14 53.3-86.7 123.7-153 211-199 66.7-36 137.3-56.3 212-62h199568v120H200432c-178.3 11.7-311.7 78.3-403 201-6 8-9.7 12-11 12-.7.7-6.7 1-18 1s-17.3-.3-18-1c-1.3 0-5-4-11-12-44.7-59.3-101.3-106.3-170-141s-145.3-54.3-229-60H0V214z"/></svg></span><span class="brace-right" style="height:0.548em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="0.548em" viewBox="0 0 400000 548" preserveAspectRatio="xMaxYMin slice"><path d="M399994 0l6 6v35l-6 11c-56 104-135.3 181.3-238 232-57.3 28.7-117 45-179 50H-300V214h399897c43.3-7 81-15 113-26 100.7-33 179.7-91 237-174 2.7-5 6-9 10-13 .7-1 7.3-1 20-1h17z"/></svg></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mord">∣</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9925em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8278em;"><span style="top:-2.931em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.898em;"><span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.7202em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord munder"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9925em;"><span style="top:-1.4159em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">goal update</span></span></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord munder"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9925em;"><span class="svg-align" style="top:-2.102em;"><span class="pstrut" style="height:3em;"></span><span class="stretchy" style="height:0.548em;min-width:1.6em;"><span class="brace-left" style="height:0.548em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="0.548em" viewBox="0 0 400000 548" preserveAspectRatio="xMinYMin slice"><path d="M0 6l6-6h17c12.688 0 19.313.3 20 1 4 4 7.313 8.3 10 13 35.313 51.3 80.813 93.8 136.5 127.5 55.688 33.7 117.188 55.8 184.5 66.5.688 0 2 .3 4 1 18.688 2.7 76 4.3 172 5h399450v120H429l-6-1c-124.688-8-235-61.7-331-161C60.687 138.7 32.312 99.3 7 54L0 41V6z"/></svg></span><span class="brace-center" style="height:0.548em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="0.548em" viewBox="0 0 400000 548" preserveAspectRatio="xMidYMin slice"><path d="M199572 214c100.7 8.3 195.3 44 280 108 55.3 42 101.7 93 139 153l9 14c2.7-4 5.7-8.7 9-14 53.3-86.7 123.7-153 211-199 66.7-36 137.3-56.3 212-62h199568v120H200432c-178.3 11.7-311.7 78.3-403 201-6 8-9.7 12-11 12-.7.7-6.7 1-18 1s-17.3-.3-18-1c-1.3 0-5-4-11-12-44.7-59.3-101.3-106.3-170-141s-145.3-54.3-229-60H0V214z"/></svg></span><span class="brace-right" style="height:0.548em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="0.548em" viewBox="0 0 400000 548" preserveAspectRatio="xMaxYMin slice"><path d="M399994 0l6 6v35l-6 11c-56 104-135.3 181.3-238 232-57.3 28.7-117 45-179 50H-300V214h399897c43.3-7 81-15 113-26 100.7-33 179.7-91 237-174 2.7-5 6-9 10-13 .7-1 7.3-1 20-1h17z"/></svg></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mord">∣</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9925em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8278em;"><span style="top:-2.931em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.898em;"><span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.7202em;"><span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.0826em;"><span></span></span></span></span></span></span></span></span></span></span></span></p><p>即 User State Transition Model 可以拆分为 Goal Update Model 和 Agenda Update Model 两部分.</p><p><strong>Goal Update Model</strong></p><p>所谓 Goal Update Model, 即在给定 System Action <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mi>m</mi></msub></mrow><annotation encoding="application/x-tex">a_m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 时, 将临时状态中的 Constraints <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>C</mi><mi>t</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msubsup></mrow><annotation encoding="application/x-tex">C_t&#x27;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9989em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-2.453em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span></span></span></span> 及 Requests <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>R</mi><mi>t</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msubsup></mrow><annotation encoding="application/x-tex">R_t&#x27;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9989em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-2.453em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span></span></span></span> 更新至新状态 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>C</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub></mrow><annotation encoding="application/x-tex">C_{t+1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8917em;vertical-align:-0.2083em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span></span></span></span> 和 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>R</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub></mrow><annotation encoding="application/x-tex">R_{t+1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8917em;vertical-align:-0.2083em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span></span></span></span>.</p><p>假设新的 Requests 与旧的 Constraints 无关, 即 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>R</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub><mo>↮</mo><msubsup><mi>C</mi><mi>t</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msubsup></mrow><annotation encoding="application/x-tex">R_{t+1} \nleftrightarrow C_t&#x27;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8917em;vertical-align:-0.2083em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel amsrm">↮</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.9989em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-2.453em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span></span></span></span>, 则:</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi>P</mi><mo stretchy="false">(</mo><msub><mi>G</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub><mi mathvariant="normal">∣</mi><msub><mi>a</mi><mi>m</mi></msub><mo separator="true">,</mo><msubsup><mi>G</mi><mi>t</mi><msup><mrow></mrow><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></msubsup><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mi>P</mi><mo stretchy="false">(</mo><mo>&lt;</mo><msub><mi>C</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub><mo separator="true">,</mo><msub><mi>R</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub><mo>&gt;</mo><mi mathvariant="normal">∣</mi><msub><mi>a</mi><mi>m</mi></msub><mo separator="true">,</mo><mo>&lt;</mo><msubsup><mi>C</mi><mi>t</mi><msup><mrow></mrow><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></msubsup><mo separator="true">,</mo><msubsup><mi>R</mi><mi>t</mi><msup><mrow></mrow><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></msubsup><mo>&gt;</mo><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mover><mo stretchy="true" minsize="3.0em">=</mo><mpadded width="+0.6em" lspace="0.3em"><mrow><msub><mi>R</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub><mo>↮</mo><msubsup><mi>C</mi><mi>t</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msubsup></mrow></mpadded></mover><mi>P</mi><mo stretchy="false">(</mo><msub><mi>R</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub><mi mathvariant="normal">∣</mi><msub><mi>a</mi><mi>m</mi></msub><mo separator="true">,</mo><msubsup><mi>R</mi><mi>t</mi><msup><mrow></mrow><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></msubsup><mo separator="true">,</mo><msub><mi>C</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub><mo stretchy="false">)</mo><mo>∗</mo><mi>P</mi><mo stretchy="false">(</mo><msub><mi>C</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub><mi mathvariant="normal">∣</mi><msub><mi>a</mi><mi>m</mi></msub><mo separator="true">,</mo><msubsup><mi>R</mi><mi>t</mi><msup><mrow></mrow><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></msubsup><mo separator="true">,</mo><msubsup><mi>C</mi><mi>t</mi><msup><mrow></mrow><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></msubsup><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned}P(G_{t+1} | a_m, G_t^{&#x27;}) &amp;= P(&lt;C_{t+1}, R_{t+1}&gt; | a_m, &lt;C_t^{&#x27;}, R_t^{&#x27;}&gt;) \\    &amp; \xlongequal{R_{t+1} \nleftrightarrow C_t&#x27;} P(R_{t+1} | a_m, R_t^{&#x27;}, C_{t+1}) * P(C_{t+1} | a_m, R_t^{&#x27;},  C_t^{&#x27;})\end{aligned}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:3.42em;vertical-align:-1.46em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.96em;"><span style="top:-4.075em;"><span class="pstrut" style="height:3.1075em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mord">∣</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9925em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8278em;"><span style="top:-2.931em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-2.3075em;"><span class="pstrut" style="height:3.1075em;"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.46em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.96em;"><span style="top:-4.075em;"><span class="pstrut" style="height:3.1075em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord">∣</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9925em;"><span style="top:-2.453em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8278em;"><span style="top:-2.931em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9925em;"><span style="top:-2.453em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8278em;"><span style="top:-2.931em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&gt;</span><span class="mclose">)</span></span></span><span style="top:-2.3075em;"><span class="pstrut" style="height:3.1075em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel x-arrow"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.1075em;"><span style="top:-3.228em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight x-arrow-pad"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3173em;"><span style="top:-2.357em;margin-left:-0.0077em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2025em;"><span></span></span></span></span></span></span><span class="mrel amsrm mtight">↮</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8278em;"><span style="top:-2.214em;margin-left:-0.0715em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">t</span></span></span><span style="top:-2.931em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286em;"><span></span></span></span></span></span></span></span></span></span><span class="svg-align" style="top:-2.783em;"><span class="pstrut" style="height:2.7em;"></span><span class="hide-tail" style="height:0.334em;min-width:0.888em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="0.334em" viewBox="0 0 400000 334" preserveAspectRatio="xMinYMin slice"><path d="M0 50 h400000 v40H0z m0 194h40000v40H0zM0 50 h400000 v40H0z m0 194h40000v40H0z"/></svg></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mord">∣</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9925em;"><span style="top:-2.453em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8278em;"><span style="top:-2.931em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mord">∣</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9925em;"><span style="top:-2.453em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8278em;"><span style="top:-2.931em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9925em;"><span style="top:-2.453em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8278em;"><span style="top:-2.931em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.46em;"><span></span></span></span></span></span></span></span></span></span></span></span></p><p>同时假设 Requests 槽位之间相互独立, 并定义 Match 函数 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mo stretchy="false">(</mo><msub><mi>a</mi><mi>m</mi></msub><mo separator="true">,</mo><mi>C</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">M(a_m, C)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mclose">)</span></span></span></span>, 则:</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><msub><mi>R</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub><mi mathvariant="normal">∣</mi><msub><mi>a</mi><mi>m</mi></msub><mo separator="true">,</mo><msubsup><mi>R</mi><mi>t</mi><msup><mrow></mrow><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></msubsup><mo separator="true">,</mo><msub><mi>C</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub><mo stretchy="false">)</mo><mo>=</mo><munder><mo>∏</mo><mrow><mi>s</mi><mo>∈</mo><msub><mi>a</mi><mi>m</mi></msub></mrow></munder><mi>P</mi><mo stretchy="false">(</mo><msub><mi>R</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub><mo stretchy="false">[</mo><mi>s</mi><mo stretchy="false">]</mo><mi mathvariant="normal">∣</mi><mi>s</mi><mo separator="true">,</mo><msubsup><mi>R</mi><mi>t</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msubsup><mo stretchy="false">[</mo><mi>s</mi><mo stretchy="false">]</mo><mo separator="true">,</mo><mi>M</mi><mo stretchy="false">(</mo><msub><mi>a</mi><mi>m</mi></msub><mo separator="true">,</mo><msub><mi>C</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P(R_{t+1} | a_m, R_t^{&#x27;}, C_{t+1}) = \prod_{s \in a_m} P( R_{t+1}[s] | s, R_t&#x27; [s], M(a_m, C_{t+1}) )</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2425em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mord">∣</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9925em;"><span style="top:-2.453em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8278em;"><span style="top:-2.931em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4001em;vertical-align:-1.3501em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.05em;"><span style="top:-1.9em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">s</span><span class="mrel mtight">∈</span><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1645em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∏</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.3501em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mopen">[</span><span class="mord mathnormal">s</span><span class="mclose">]</span><span class="mord">∣</span><span class="mord mathnormal">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8019em;"><span style="top:-2.453em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mopen">[</span><span class="mord mathnormal">s</span><span class="mclose">]</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mclose">))</span></span></span></span></span></p><p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><msub><mi>C</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub><mi mathvariant="normal">∣</mi><msub><mi>a</mi><mi>m</mi></msub><mo separator="true">,</mo><msubsup><mi>R</mi><mi>t</mi><msup><mrow></mrow><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></msubsup><mo separator="true">,</mo><msubsup><mi>C</mi><mi>t</mi><msup><mrow></mrow><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></msubsup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P(C_{t+1} | a_m, R_t^{&#x27;},  C_t^{&#x27;})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1925em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mord">∣</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9425em;"><span style="top:-2.453em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8278em;"><span style="top:-2.931em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9425em;"><span style="top:-2.453em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8278em;"><span style="top:-2.931em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> 在给定 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mi>m</mi></msub></mrow><annotation encoding="application/x-tex">a_m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 下更新 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>C</mi><mi>t</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msubsup></mrow><annotation encoding="application/x-tex">C_t&#x27;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9989em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-2.453em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span></span></span></span> 主要有如下情形:</p><ul><li>将某些 Constraints 槽位更新为一个新值 (如 <code>dontcare</code> 表示不再限制该槽位, 或 <code>type=wine</code> 表示将类型由 <code>beer</code> 调整为 <code>wine</code> 等)</li><li>维持不变</li></ul><p><strong>Agenda Update Model</strong></p><p>Agenda 更新 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><msub><mi>A</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub><mi mathvariant="normal">∣</mi><msub><mi>a</mi><mi>m</mi></msub><mo separator="true">,</mo><msubsup><mi>A</mi><mi>t</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msubsup><mo separator="true">,</mo><msub><mi>G</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P(A_{t+1} | a_m, A_t&#x27;, G_{t+1})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0019em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mord">∣</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> 可以看作 一组入栈操作 和 一个 <strong>clean-up</strong> 过程.</p><p>清除过程主要用于处理 重复的 Dialogue Act / NULL Act 及 非必要的 Requests Act (如所需信息已得到), 这些可以从 Agenda 中清除掉.</p><p>下面主要看入栈操作, 假设 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mi>m</mi></msub></mrow><annotation encoding="application/x-tex">a_m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 中的每个槽位入栈相互独立, 则</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><msub><mi>A</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub><mi mathvariant="normal">∣</mi><msub><mi>a</mi><mi>m</mi></msub><mo separator="true">,</mo><msubsup><mi>A</mi><mi>t</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msubsup><mo separator="true">,</mo><msub><mi>G</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub><mo stretchy="false">)</mo><mo>=</mo><munder><mo>∏</mo><mrow><mi>s</mi><mo>∈</mo><msub><mi>a</mi><mi>m</mi></msub></mrow></munder><mi>P</mi><mo stretchy="false">(</mo><msub><mi>A</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub><mo stretchy="false">[</mo><mi>s</mi><mo stretchy="false">]</mo><mi mathvariant="normal">∣</mi><mi>s</mi><mo separator="true">,</mo><msub><mi>G</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P(A_{t+1} | a_m, A_t&#x27;, G_{t+1}) = \prod_{s \in a_m} P(A_{t+1} [s] | s, G_{t+1})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0519em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mord">∣</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8019em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4001em;vertical-align:-1.3501em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.05em;"><span style="top:-1.9em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">s</span><span class="mrel mtight">∈</span><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1645em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∏</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.3501em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mopen">[</span><span class="mord mathnormal">s</span><span class="mclose">]</span><span class="mord">∣</span><span class="mord mathnormal">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p><h1>ConvLab2 实现</h1><p>在 ConvLab2 中, 在 MultiWOZ 数据集上的 Agenda-based User Simulator 实现在 <a href="https://github.com/thu-coai/ConvLab-2/blob/master/convlab2/policy/rule/multiwoz/policy_agenda_multiwoz.py">convlab2/policy/rule/multiwoz/policy_agenda_multiwoz.py</a> 中.</p><p>具体地, 该文件定义了一个 <code>UserPolicyAgendaMultiWoz</code> 类, 该类主体架构如下:</p><pre class="shiki shiki-themes everforest-light everforest-dark" style="background-color:#fdf6e3;--shiki-dark-bg:#2d353b;color:#5c6a72;--shiki-dark:#d3c6aa" tabindex="0"><code><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">class</span><span style="color:#3A94C5;--shiki-dark:#7FBBB3"> UserPolicyAgendaMultiWoz</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(</span><span style="color:#3A94C5;--shiki-dark:#7FBBB3">Policy</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">):</span></span><span class="line"></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">    def</span><span style="color:#8DA101;--shiki-dark:#A7C080"> __init__</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(self):</span></span><span class="line"><span style="color:#939F91;--shiki-light-font-style:italic;--shiki-dark:#859289;--shiki-dark-font-style:italic">        # 一些限制条件</span></span><span class="line"><span style="color:#DF69BA;--shiki-dark:#D699B6">        self</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">max_turn </span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#DF69BA;--shiki-dark:#D699B6"> 40</span></span><span class="line"><span style="color:#DF69BA;--shiki-dark:#D699B6">        self</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">max_initiative </span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#DF69BA;--shiki-dark:#D699B6"> 4</span></span><span class="line"></span><span class="line"><span style="color:#939F91;--shiki-light-font-style:italic;--shiki-dark:#859289;--shiki-dark-font-style:italic">        # 目标生成器, 用于初始化 Simulator</span></span><span class="line"><span style="color:#DF69BA;--shiki-dark:#D699B6">        self</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">goal_generator </span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#8DA101;--shiki-dark:#A7C080"> GoalGenerator</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">()</span></span><span class="line"></span><span class="line"><span style="color:#DF69BA;--shiki-dark:#D699B6">        self</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">__turn </span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#DF69BA;--shiki-dark:#D699B6"> 0</span></span><span class="line"></span><span class="line"><span style="color:#939F91;--shiki-light-font-style:italic;--shiki-dark:#859289;--shiki-dark-font-style:italic">        # 主要成员 User Goal 和 User Agenda</span></span><span class="line"><span style="color:#DF69BA;--shiki-dark:#D699B6">        self</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">goal </span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#35A77C;--shiki-dark:#83C092"> None</span></span><span class="line"><span style="color:#DF69BA;--shiki-dark:#D699B6">        self</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">agenda </span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#35A77C;--shiki-dark:#83C092"> None</span></span><span class="line"></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">        Policy</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#8DA101;--shiki-dark:#A7C080">__init__</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(</span><span style="color:#DF69BA;--shiki-dark:#D699B6">self</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">)</span></span><span class="line"></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">    def</span><span style="color:#8DA101;--shiki-dark:#A7C080"> init_session</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(self,</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> init_goal</span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#35A77C;--shiki-dark:#83C092">None</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">):</span></span><span class="line"><span style="color:#DFA000;--shiki-dark:#DBBC7F">        """初始化 User Goal 和 User Agenda"""</span></span><span class="line"><span style="color:#DF69BA;--shiki-dark:#D699B6">        self</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#8DA101;--shiki-dark:#A7C080">reset_turn</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">()</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">        if</span><span style="color:#F57D26;--shiki-dark:#E69875"> not</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> ini_goal:</span></span><span class="line"><span style="color:#DF69BA;--shiki-dark:#D699B6">            self</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">goal </span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#8DA101;--shiki-dark:#A7C080"> Goal</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(</span><span style="color:#DF69BA;--shiki-dark:#D699B6">self</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">goal_generator)</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">        else</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">:</span></span><span class="line"><span style="color:#DF69BA;--shiki-dark:#D699B6">            self</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">goal </span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> ini_goal</span></span><span class="line"><span style="color:#DF69BA;--shiki-dark:#D699B6">        self</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">domain_goals </span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#DF69BA;--shiki-dark:#D699B6"> self</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">goal</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">domain_goals</span></span><span class="line"><span style="color:#DF69BA;--shiki-dark:#D699B6">        self</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">agenda </span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#8DA101;--shiki-dark:#A7C080"> Agenda</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(</span><span style="color:#DF69BA;--shiki-dark:#D699B6">self</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">goal)</span></span><span class="line"></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">    def</span><span style="color:#8DA101;--shiki-dark:#A7C080"> predict</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(self,</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> sys_dialog_act):</span></span><span class="line"><span style="color:#DFA000;--shiki-dark:#DBBC7F">        """给定 System Action, 生成 User Action</span></span><span class="line"><span style="color:#DFA000;--shiki-dark:#DBBC7F">        </span></span><span class="line"><span style="color:#DFA000;--shiki-dark:#DBBC7F">        该函数会完成 Agenda-based User Simulator 的三个过程:</span></span><span class="line"><span style="color:#DFA000;--shiki-dark:#DBBC7F">        1. System Action based State Transition</span></span><span class="line"><span style="color:#DFA000;--shiki-dark:#DBBC7F">        2. User Action Selection</span></span><span class="line"><span style="color:#DFA000;--shiki-dark:#DBBC7F">        3. User Action based State Transition</span></span><span class="line"><span style="color:#DFA000;--shiki-dark:#DBBC7F">        """</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">        ...</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">        sys_action </span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#DF69BA;--shiki-dark:#D699B6"> self</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#8DA101;--shiki-dark:#A7C080">_transform_sysact_in</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(sys_action)</span></span><span class="line"></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">        ...</span></span><span class="line"><span style="color:#DF69BA;--shiki-dark:#D699B6">        self</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">agenda</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#8DA101;--shiki-dark:#A7C080">update</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(sys_action, </span><span style="color:#DF69BA;--shiki-dark:#D699B6">self</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">goal)</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">        </span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">        ...</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">        action </span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#DF69BA;--shiki-dark:#D699B6"> self</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">agenda</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#8DA101;--shiki-dark:#A7C080">get_action</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(</span><span style="color:#DF69BA;--shiki-dark:#D699B6">self</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">max_initiative)</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">        action </span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#DF69BA;--shiki-dark:#D699B6"> self</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#8DA101;--shiki-dark:#A7C080">_transform_usract_out</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(action)</span></span></code></pre><p>Agenda-based Simulator 中最重要的两个元素是 User Goal 和 Agenda, 在 ConvLab2 中分别使用了 <code>Goal</code> 和 <code>Agenda</code> 两个类实现.</p><h2 id="Goal-实现">Goal 实现</h2><p>ConvLab2 中 Goal 类也在 <code>policy_agenda_multiwoz.py</code> 文件中实现.</p><pre class="shiki shiki-themes everforest-light everforest-dark" style="background-color:#fdf6e3;--shiki-dark-bg:#2d353b;color:#5c6a72;--shiki-dark:#d3c6aa" tabindex="0"><code><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">class</span><span style="color:#3A94C5;--shiki-dark:#7FBBB3"> Goal</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(</span><span style="color:#3A94C5;--shiki-dark:#7FBBB3">object</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">):</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">    def</span><span style="color:#8DA101;--shiki-dark:#A7C080"> __init__</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(self,</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> goal_generator:</span><span style="color:#8DA101;--shiki-dark:#A7C080"> GoalGenerator</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">):</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">        pass</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">    def</span><span style="color:#8DA101;--shiki-dark:#A7C080"> set_user_goal</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(self,</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> user_goal:</span><span style="color:#3A94C5;--shiki-dark:#7FBBB3"> dict</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">):</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">        pass</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">    def</span><span style="color:#8DA101;--shiki-dark:#A7C080"> task_complete</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(self)</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> -></span><span style="color:#3A94C5;--shiki-dark:#7FBBB3"> bool</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">:</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">        pass</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">    def</span><span style="color:#8DA101;--shiki-dark:#A7C080"> next_domain_incomplete</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(self):</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">        pass</span></span></code></pre><p>Goal 接收一个 <code>GoalGenerator</code> 初始化参数. GoalGenerator 可以随机生成特定数据集的 User Goal, 示例如下:</p><pre class="shiki shiki-themes everforest-light everforest-dark" style="background-color:#fdf6e3;--shiki-dark-bg:#2d353b;color:#5c6a72;--shiki-dark:#d3c6aa" tabindex="0"><code><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">&#123;</span></span><span class="line"><span style="color:#939F91;--shiki-dark:#859289">    "</span><span style="color:#F57D26;--shiki-dark:#E69875">train</span><span style="color:#939F91;--shiki-dark:#859289">"</span><span style="color:#939F91;--shiki-dark:#859289">:</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">&#123;</span></span><span class="line"><span style="color:#939F91;--shiki-dark:#859289">        "</span><span style="color:#F57D26;--shiki-dark:#E69875">info</span><span style="color:#939F91;--shiki-dark:#859289">"</span><span style="color:#939F91;--shiki-dark:#859289">:</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">&#123;</span></span><span class="line"><span style="color:#939F91;--shiki-dark:#859289">            "</span><span style="color:#F57D26;--shiki-dark:#E69875">arriveBy</span><span style="color:#939F91;--shiki-dark:#859289">"</span><span style="color:#939F91;--shiki-dark:#859289">:</span><span style="color:#939F91;--shiki-dark:#859289">"</span><span style="color:#8DA101;--shiki-dark:#A7C080">12:15</span><span style="color:#939F91;--shiki-dark:#859289">"</span><span style="color:#939F91;--shiki-dark:#859289">,</span></span><span class="line"><span style="color:#939F91;--shiki-dark:#859289">            "</span><span style="color:#F57D26;--shiki-dark:#E69875">day</span><span style="color:#939F91;--shiki-dark:#859289">"</span><span style="color:#939F91;--shiki-dark:#859289">:</span><span style="color:#939F91;--shiki-dark:#859289">"</span><span style="color:#8DA101;--shiki-dark:#A7C080">tuesday</span><span style="color:#939F91;--shiki-dark:#859289">"</span><span style="color:#939F91;--shiki-dark:#859289">,</span></span><span class="line"><span style="color:#939F91;--shiki-dark:#859289">            "</span><span style="color:#F57D26;--shiki-dark:#E69875">departure</span><span style="color:#939F91;--shiki-dark:#859289">"</span><span style="color:#939F91;--shiki-dark:#859289">:</span><span style="color:#939F91;--shiki-dark:#859289">"</span><span style="color:#8DA101;--shiki-dark:#A7C080">cambridge</span><span style="color:#939F91;--shiki-dark:#859289">"</span><span style="color:#939F91;--shiki-dark:#859289">,</span></span><span class="line"><span style="color:#939F91;--shiki-dark:#859289">            "</span><span style="color:#F57D26;--shiki-dark:#E69875">destination</span><span style="color:#939F91;--shiki-dark:#859289">"</span><span style="color:#939F91;--shiki-dark:#859289">:</span><span style="color:#939F91;--shiki-dark:#859289">"</span><span style="color:#8DA101;--shiki-dark:#A7C080">peterborough</span><span style="color:#939F91;--shiki-dark:#859289">"</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">        &#125;</span><span style="color:#939F91;--shiki-dark:#859289">,</span></span><span class="line"><span style="color:#939F91;--shiki-dark:#859289">        "</span><span style="color:#F57D26;--shiki-dark:#E69875">reqt</span><span style="color:#939F91;--shiki-dark:#859289">"</span><span style="color:#939F91;--shiki-dark:#859289">:</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">[</span></span><span class="line"><span style="color:#939F91;--shiki-dark:#859289">            "</span><span style="color:#8DA101;--shiki-dark:#A7C080">trainID</span><span style="color:#939F91;--shiki-dark:#859289">"</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">        ]</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">    &#125;</span><span style="color:#939F91;--shiki-dark:#859289">,</span></span><span class="line"><span style="color:#939F91;--shiki-dark:#859289">    "</span><span style="color:#F57D26;--shiki-dark:#E69875">attraction</span><span style="color:#939F91;--shiki-dark:#859289">"</span><span style="color:#939F91;--shiki-dark:#859289">:</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">&#123;</span></span><span class="line"><span style="color:#939F91;--shiki-dark:#859289">        "</span><span style="color:#F57D26;--shiki-dark:#E69875">info</span><span style="color:#939F91;--shiki-dark:#859289">"</span><span style="color:#939F91;--shiki-dark:#859289">:</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">&#123;</span></span><span class="line"><span style="color:#939F91;--shiki-dark:#859289">            "</span><span style="color:#F57D26;--shiki-dark:#E69875">area</span><span style="color:#939F91;--shiki-dark:#859289">"</span><span style="color:#939F91;--shiki-dark:#859289">:</span><span style="color:#939F91;--shiki-dark:#859289">"</span><span style="color:#8DA101;--shiki-dark:#A7C080">east</span><span style="color:#939F91;--shiki-dark:#859289">"</span><span style="color:#939F91;--shiki-dark:#859289">,</span></span><span class="line"><span style="color:#939F91;--shiki-dark:#859289">            "</span><span style="color:#F57D26;--shiki-dark:#E69875">type</span><span style="color:#939F91;--shiki-dark:#859289">"</span><span style="color:#939F91;--shiki-dark:#859289">:</span><span style="color:#939F91;--shiki-dark:#859289">"</span><span style="color:#8DA101;--shiki-dark:#A7C080">museum</span><span style="color:#939F91;--shiki-dark:#859289">"</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">        &#125;</span><span style="color:#939F91;--shiki-dark:#859289">,</span></span><span class="line"><span style="color:#939F91;--shiki-dark:#859289">        "</span><span style="color:#F57D26;--shiki-dark:#E69875">reqt</span><span style="color:#939F91;--shiki-dark:#859289">"</span><span style="color:#939F91;--shiki-dark:#859289">:</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">[</span></span><span class="line"><span style="color:#939F91;--shiki-dark:#859289">            "</span><span style="color:#8DA101;--shiki-dark:#A7C080">entrance fee</span><span style="color:#939F91;--shiki-dark:#859289">"</span><span style="color:#939F91;--shiki-dark:#859289">,</span></span><span class="line"><span style="color:#939F91;--shiki-dark:#859289">            "</span><span style="color:#8DA101;--shiki-dark:#A7C080">phone</span><span style="color:#939F91;--shiki-dark:#859289">"</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">        ]</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">    &#125;</span><span style="color:#939F91;--shiki-dark:#859289">,</span></span><span class="line"><span style="color:#939F91;--shiki-dark:#859289">    "</span><span style="color:#F57D26;--shiki-dark:#E69875">domain_ordering</span><span style="color:#939F91;--shiki-dark:#859289">"</span><span style="color:#939F91;--shiki-dark:#859289">:</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">[</span></span><span class="line"><span style="color:#939F91;--shiki-dark:#859289">        "</span><span style="color:#8DA101;--shiki-dark:#A7C080">train</span><span style="color:#939F91;--shiki-dark:#859289">"</span><span style="color:#939F91;--shiki-dark:#859289">,</span></span><span class="line"><span style="color:#939F91;--shiki-dark:#859289">        "</span><span style="color:#8DA101;--shiki-dark:#A7C080">attraction</span><span style="color:#939F91;--shiki-dark:#859289">"</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">    ]</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">&#125;</span></span></code></pre><blockquote><p><strong>说明</strong><br>MultiWOZ 是一个 multi-domain 数据集, 因此, 生成的 User Goal 也包括多个 Domain, 并通过 <code>domain_ordering</code> 字段控制 Domain 的优先顺序.</p><p>具体到每个 Domain, 其 User Goal 主要包括两项内容: <code>info</code> 与 <code>reqt</code>, 这对应 User Goal 中的 Constraints 和 Requests.</p></blockquote><h2 id="Agenda">Agenda</h2><p>ConvLab2 中 Agenda 类也在 <code>policy_agenda_multiwoz.py</code> 文件中实现.</p><pre class="shiki shiki-themes everforest-light everforest-dark" style="background-color:#fdf6e3;--shiki-dark-bg:#2d353b;color:#5c6a72;--shiki-dark:#d3c6aa" tabindex="0"><code><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">class</span><span style="color:#3A94C5;--shiki-dark:#7FBBB3"> Agenda</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(</span><span style="color:#3A94C5;--shiki-dark:#7FBBB3">object</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">):</span></span><span class="line"></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">    def</span><span style="color:#8DA101;--shiki-dark:#A7C080"> __init__</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(self,</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> goal:</span><span style="color:#8DA101;--shiki-dark:#A7C080"> Goal</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">):</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">        ...</span></span><span class="line"><span style="color:#DF69BA;--shiki-dark:#D699B6">        self</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">__stack </span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> []</span></span><span class="line"></span><span class="line"><span style="color:#DF69BA;--shiki-dark:#D699B6">        self</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#8DA101;--shiki-dark:#A7C080">__push</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(</span><span style="color:#DF69BA;--shiki-dark:#D699B6">self</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">CLOSE_ACT)        </span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">        for</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> idx </span><span style="color:#F85552;--shiki-dark:#E67E80">in</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> ran</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">        </span></span><span class="line"><span style="color:#8DA101;--shiki-dark:#A7C080">        ge</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(</span><span style="color:#8DA101;--shiki-dark:#A7C080">len</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(goal</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">domains) </span><span style="color:#F57D26;--shiki-dark:#E69875">-</span><span style="color:#DF69BA;--shiki-dark:#D699B6"> 1</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">, </span><span style="color:#F57D26;--shiki-dark:#E69875">-</span><span style="color:#DF69BA;--shiki-dark:#D699B6">1</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">, </span><span style="color:#F57D26;--shiki-dark:#E69875">-</span><span style="color:#DF69BA;--shiki-dark:#D699B6">1</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">):</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">            ...</span></span><span class="line"><span style="color:#DF69BA;--shiki-dark:#D699B6">            self</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#8DA101;--shiki-dark:#A7C080">__push</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(domain </span><span style="color:#F57D26;--shiki-dark:#E69875">+</span><span style="color:#DFA000;--shiki-dark:#DBBC7F"> '-inform'</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">, </span><span style="color:#DFA000;--shiki-dark:#DBBC7F">"none"</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">, </span><span style="color:#DFA000;--shiki-dark:#DBBC7F">"none"</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">)</span></span><span class="line"></span><span class="line"><span style="color:#DF69BA;--shiki-dark:#D699B6">        self</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">cur_domain </span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#35A77C;--shiki-dark:#83C092"> None</span></span><span class="line"></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">    def</span><span style="color:#8DA101;--shiki-dark:#A7C080"> update</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(self,</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> sys_action,</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> goal:</span><span style="color:#8DA101;--shiki-dark:#A7C080"> Goal</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">):</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">        pass</span></span><span class="line"></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">    def</span><span style="color:#8DA101;--shiki-dark:#A7C080"> get_action</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(self,</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> initiative</span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#DF69BA;--shiki-dark:#D699B6">1</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">):</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">        pass</span></span></code></pre><p>Agenda 的主要目的是 存储尚需进一步处理的 User Action 以及 生成新的 User Action.</p><p>存储 User Action 使用了 <code>self.__stack = []</code>. 鉴于 Stack 是后进先出的, 在初始化时, 首先压入了 <code>CLOSE_ACT</code> (即 <code>generate_bye</code>), 作为对话结束时的 User Action.<br>然后, 根据生成的 User Goal 中各个 Domain 的先后顺序, 将优先级靠后的 Domain 中的槽位构造为 <code>&lt;&#123;domain&#125;-inform, &#123;slot&#125;, &#123;value&#125;&gt;</code> Action 入栈. 这可以确保优先级较高的 User Action 先于优先级较低的 User Action 出栈.</p><p>Agenda 提供了 <code>update(self, sys_action, goal: Goal)</code> 方法, 用于在新的 System Action 到来之时更新 Agenda.</p><p>Agenda 的 <code>get_ation(self, initiative=1)</code> 方法用于生成新的 User Action, 以便 Simulator 可以与 System 持续交互.</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;为了自动评估 ConvLab 对话系统的能力, ConvLab 提供了 User Simulator, 用来模拟用户.&lt;/p&gt;
&lt;p&gt;User Simulator 中最重要的是 User Policy. User Policy 以预设的 User Goal 和 当前的系统答</summary>
      
    
    
    
    <category term="对话系统" scheme="https://loveychen.github.io/categories/%E5%AF%B9%E8%AF%9D%E7%B3%BB%E7%BB%9F/"/>
    
    <category term="ConvLab2" scheme="https://loveychen.github.io/categories/%E5%AF%B9%E8%AF%9D%E7%B3%BB%E7%BB%9F/ConvLab2/"/>
    
    
    <category term="TOD" scheme="https://loveychen.github.io/tags/TOD/"/>
    
    <category term="ConvLab2" scheme="https://loveychen.github.io/tags/ConvLab2/"/>
    
    <category term="User Simulator" scheme="https://loveychen.github.io/tags/User-Simulator/"/>
    
    <category term="Agenda" scheme="https://loveychen.github.io/tags/Agenda/"/>
    
  </entry>
  
  <entry>
    <title>gRPC 源码解析</title>
    <link href="https://loveychen.github.io/2021/01/07/grpc-concepts/"/>
    <id>https://loveychen.github.io/2021/01/07/grpc-concepts/</id>
    <published>2021-01-07T20:07:49.000Z</published>
    <updated>2025-08-05T17:48:18.794Z</updated>
    
    <content type="html"><![CDATA[<h1>通用概念</h1><p>gRPC 中, 有部分概念在服务端和客户端由类似的定义, 比如:</p><ul><li>拦截器 Interceptor</li><li>上下文 Context</li></ul><h2 id="拦截器-Interceptor">拦截器 Interceptor</h2><p>拦截器是在各种网络框架中经常使用的概念, 主要用于对网络请求进行前置和后置操作.</p><p>gRPC 的客户端和服务端都有自己的拦截器.</p><h3 id="服务端拦截器">服务端拦截器</h3><p>请参考 <a href="">服务端概念-&gt;服务端拦截器</a></p><h3 id="客户端拦截器">客户端拦截器</h3><p>请参考 <a href="">客户端概念-&gt;客户端拦截器</a></p><h2 id="上下文-Context">上下文 Context</h2><p>gRPC 提供了三种类型的 Context:</p><ul><li>共享 Context <code>grpc.RpcContext</code></li><li>服务端 Context <code>grpc.ServicerContext</code></li><li>客户端 Context <code>grpc.Call</code></li></ul><h3 id="共享-Context">共享 Context</h3><p>共享 Context 接口定义为 <code>grpc.RpcContext</code> , 该接口定义如下:</p><pre class="shiki shiki-themes everforest-light everforest-dark" style="background-color:#fdf6e3;--shiki-dark-bg:#2d353b;color:#5c6a72;--shiki-dark:#d3c6aa" tabindex="0"><code><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">class</span><span style="color:#3A94C5;--shiki-dark:#7FBBB3"> RpcContext</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(</span><span style="color:#3A94C5;--shiki-dark:#7FBBB3">six</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#3A94C5;--shiki-dark:#7FBBB3">with_metaclass</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(abc</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">ABCMeta)):</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">    def</span><span style="color:#8DA101;--shiki-dark:#A7C080"> is_active</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(self):</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">        pass</span></span><span class="line"></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">    def</span><span style="color:#8DA101;--shiki-dark:#A7C080"> time_remaining</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(self):</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">        pass</span></span><span class="line"></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">    def</span><span style="color:#8DA101;--shiki-dark:#A7C080"> cancel</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(self):</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">        pass</span></span><span class="line"></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">    def</span><span style="color:#8DA101;--shiki-dark:#A7C080"> add_callback</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(self,</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> callback):</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">        pass</span></span></code></pre><p>服务端上下文 <code>grpc.ServicerContext</code>和客户端上下文 <code>grpc.Call</code> 均为该类的子类.</p><h3 id="服务端-Context">服务端 Context</h3><p>请参考 <a href="">服务端概念-&gt;服务端上下文</a></p><h3 id="客户端-Context">客户端 Context</h3><p>请参考 <a href="">客户端概念-&gt;客户端上下文</a></p><h1>服务端概念</h1><p>服务端的基本概念有:</p><ul><li>服务端 Server</li><li>服务 Servicer</li><li>接口 Handler</li><li>服务拦截器 Interceptor</li><li><code>ServicerContext</code></li></ul><h2 id="服务端-Server">服务端 Server</h2><h3 id="创建服务-grpc-server">创建服务 <code>grpc.server()</code></h3><pre class="shiki shiki-themes everforest-light everforest-dark" style="background-color:#fdf6e3;--shiki-dark-bg:#2d353b;color:#5c6a72;--shiki-dark:#d3c6aa" tabindex="0"><code><span class="line"><span style="color:#939F91;--shiki-light-font-style:italic;--shiki-dark:#859289;--shiki-dark-font-style:italic"># grpc/__init__.py</span></span><span class="line"></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">def</span><span style="color:#8DA101;--shiki-dark:#A7C080"> server</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">thread_pool:</span><span style="color:#8DA101;--shiki-dark:#A7C080"> futures</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#8DA101;--shiki-dark:#A7C080">ThreadPoolExecutor</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">,</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">handlers:</span><span style="color:#8DA101;--shiki-dark:#A7C080"> List</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">[</span><span style="color:#8DA101;--shiki-dark:#A7C080">GenericRpcHandler</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">]</span><span style="color:#F57D26;--shiki-dark:#E69875"> =</span><span style="color:#35A77C;--shiki-dark:#83C092"> None</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">,</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">interceptors:</span><span style="color:#8DA101;--shiki-dark:#A7C080"> List</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">[</span><span style="color:#8DA101;--shiki-dark:#A7C080">ServerInterceptor</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">]</span><span style="color:#F57D26;--shiki-dark:#E69875"> =</span><span style="color:#35A77C;--shiki-dark:#83C092"> None</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">,</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">options:</span><span style="color:#8DA101;--shiki-dark:#A7C080"> list</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">[</span><span style="color:#3A94C5;--shiki-dark:#7FBBB3">tuple</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">]</span><span style="color:#F57D26;--shiki-dark:#E69875"> =</span><span style="color:#35A77C;--shiki-dark:#83C092"> None</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">,</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">maximum_concurrent_rpcs:</span><span style="color:#3A94C5;--shiki-dark:#7FBBB3"> int</span><span style="color:#F57D26;--shiki-dark:#E69875"> =</span><span style="color:#35A77C;--shiki-dark:#83C092"> None</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">,</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">compression:</span><span style="color:#8DA101;--shiki-dark:#A7C080"> grpc</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#8DA101;--shiki-dark:#A7C080">Compression </span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#35A77C;--shiki-dark:#83C092"> None</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">,</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">):</span></span><span class="line"></span><span class="line"><span style="color:#DFA000;--shiki-dark:#DBBC7F">    """Creates a Server with which RPCs can be serviced.</span></span><span class="line"></span><span class="line"><span style="color:#DFA000;--shiki-dark:#DBBC7F">    Args:</span></span><span class="line"><span style="color:#DFA000;--shiki-dark:#DBBC7F">      thread_pool: A futures.ThreadPoolExecutor to be used by the Server</span></span><span class="line"><span style="color:#DFA000;--shiki-dark:#DBBC7F">        to execute RPC handlers.</span></span><span class="line"><span style="color:#DFA000;--shiki-dark:#DBBC7F">      handlers: An optional list of GenericRpcHandlers used for executing RPCs.</span></span><span class="line"><span style="color:#DFA000;--shiki-dark:#DBBC7F">        More handlers may be added by calling add_generic_rpc_handlers any time</span></span><span class="line"><span style="color:#DFA000;--shiki-dark:#DBBC7F">        before the server is started.</span></span><span class="line"><span style="color:#DFA000;--shiki-dark:#DBBC7F">      interceptors: An optional list of ServerInterceptor objects that observe</span></span><span class="line"><span style="color:#DFA000;--shiki-dark:#DBBC7F">        and optionally manipulate the incoming RPCs before handing them over to</span></span><span class="line"><span style="color:#DFA000;--shiki-dark:#DBBC7F">        handlers. The interceptors are given control in the order they are</span></span><span class="line"><span style="color:#DFA000;--shiki-dark:#DBBC7F">        specified. This is an EXPERIMENTAL API.</span></span><span class="line"><span style="color:#DFA000;--shiki-dark:#DBBC7F">      options: An optional list of key-value pairs (:term:`channel_arguments` in gRPC runtime)</span></span><span class="line"><span style="color:#DFA000;--shiki-dark:#DBBC7F">        to configure the channel.</span></span><span class="line"><span style="color:#DFA000;--shiki-dark:#DBBC7F">      maximum_concurrent_rpcs: The maximum number of concurrent RPCs this server</span></span><span class="line"><span style="color:#DFA000;--shiki-dark:#DBBC7F">        will service before returning RESOURCE_EXHAUSTED status, or None to</span></span><span class="line"><span style="color:#DFA000;--shiki-dark:#DBBC7F">        indicate no limit.</span></span><span class="line"><span style="color:#DFA000;--shiki-dark:#DBBC7F">      compression: An element of grpc.compression, e.g.</span></span><span class="line"><span style="color:#DFA000;--shiki-dark:#DBBC7F">        grpc.compression.Gzip. This compression algorithm will be used for the</span></span><span class="line"><span style="color:#DFA000;--shiki-dark:#DBBC7F">        lifetime of the server unless overridden. This is an EXPERIMENTAL option.</span></span><span class="line"></span><span class="line"><span style="color:#DFA000;--shiki-dark:#DBBC7F">    Returns:</span></span><span class="line"><span style="color:#DFA000;--shiki-dark:#DBBC7F">      A Server object.</span></span><span class="line"><span style="color:#DFA000;--shiki-dark:#DBBC7F">    """</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">    pass</span></span></code></pre><h3 id="Server-接口-grpc-Server">Server 接口 <code>grpc.Server</code></h3><p><code>grpc.Server</code> 抽象类定义如下</p><pre class="shiki shiki-themes everforest-light everforest-dark" style="background-color:#fdf6e3;--shiki-dark-bg:#2d353b;color:#5c6a72;--shiki-dark:#d3c6aa" tabindex="0"><code><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">class</span><span style="color:#3A94C5;--shiki-dark:#7FBBB3"> Server</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(</span><span style="color:#3A94C5;--shiki-dark:#7FBBB3">six</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#3A94C5;--shiki-dark:#7FBBB3">with_metaclass</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(abc</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">ABCMeta)):</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">    def</span><span style="color:#8DA101;--shiki-dark:#A7C080"> add_generic_rpc_handlers</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(self,</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> generic_rpc_handlers):</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">        pass</span></span><span class="line"></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">    def</span><span style="color:#8DA101;--shiki-dark:#A7C080"> add_insecure_port</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(self,</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> address):</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">        pass</span></span><span class="line"></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">    def</span><span style="color:#8DA101;--shiki-dark:#A7C080"> add_secure_port</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(self,</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> address,</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> server_credentials):</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">        pass</span></span><span class="line"></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">    def</span><span style="color:#8DA101;--shiki-dark:#A7C080"> start</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(self):</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">        pass</span></span><span class="line"></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">    def</span><span style="color:#8DA101;--shiki-dark:#A7C080"> stop</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(self,</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> grace):</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">        pass</span></span><span class="line"></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">    def</span><span style="color:#8DA101;--shiki-dark:#A7C080"> wait_for_termination</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(self,</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> timeout</span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#35A77C;--shiki-dark:#83C092">None</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">):</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">        pass</span></span></code></pre><h3 id="Cython-实现-cygrpc-Server">Cython 实现 <code>cygrpc.Server</code></h3><p>其具体实现在 <code>src/python/grpcio/grpc/_server.py#_Server</code> 中. 而 <code>_Server</code> 类则调用了<code>src/python/grpcio/grpc/_cython/_cygrpc/server.pyx.pxi</code> 中使用 <a href="https://cython.org/">Cython</a> 实现的 <code>cygrpc.Server</code> 类.</p><p><code>cygrpc.Server</code> 的初始化函数定义如下:</p><pre class="shiki shiki-themes everforest-light everforest-dark" style="background-color:#fdf6e3;--shiki-dark-bg:#2d353b;color:#5c6a72;--shiki-dark:#d3c6aa" tabindex="0"><code><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">  def</span><span style="color:#8DA101;--shiki-dark:#A7C080"> __cinit__</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(self,</span><span style="color:#8DA101;--shiki-dark:#A7C080"> object </span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">arguments):</span></span><span class="line"><span style="color:#8DA101;--shiki-dark:#A7C080">    fork_handlers_and_grpc_init</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">()</span></span><span class="line"><span style="color:#DF69BA;--shiki-dark:#D699B6">    self</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">references </span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> []</span></span><span class="line"><span style="color:#DF69BA;--shiki-dark:#D699B6">    self</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">registered_completion_queues </span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> []</span></span><span class="line"><span style="color:#DF69BA;--shiki-dark:#D699B6">    self</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">is_started </span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#35A77C;--shiki-dark:#83C092"> False</span></span><span class="line"><span style="color:#DF69BA;--shiki-dark:#D699B6">    self</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">is_shutting_down </span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#35A77C;--shiki-dark:#83C092"> False</span></span><span class="line"><span style="color:#DF69BA;--shiki-dark:#D699B6">    self</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">is_shutdown </span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#35A77C;--shiki-dark:#83C092"> False</span></span><span class="line"><span style="color:#DF69BA;--shiki-dark:#D699B6">    self</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">c_server </span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> NULL</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">    cdef _ChannelArgs channel_args </span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#8DA101;--shiki-dark:#A7C080"> _ChannelArgs</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(arguments)</span></span><span class="line"><span style="color:#DF69BA;--shiki-dark:#D699B6">    self</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">c_server </span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#8DA101;--shiki-dark:#A7C080"> grpc_server_create</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(channel_args</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#8DA101;--shiki-dark:#A7C080">c_args</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(), NULL)</span></span><span class="line"><span style="color:#DF69BA;--shiki-dark:#D699B6">    self</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">references</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#8DA101;--shiki-dark:#A7C080">append</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(arguments)</span></span></code></pre><h3 id="CPP-实现-grpc-server-与-grpc-core-Server">CPP 实现 <code>grpc_server</code> 与 <code>grpc_core::Server</code></h3><p><code>cython.Server</code> 调用 C 函数 <code>grpc_server_create</code> 创建了 <code>grpc_server</code>, <code>grpc_server</code> 是对 <code>grpc_core::Server</code> 的封装, 后者是 gRPC 中 server 的最终实现.</p><p><code>grpc_server_create</code> 函数在 <code>include/grpc/grpc.h</code> 中声明, 在 <code>src/core/lib/surface/server.cc</code> 文件实现.</p><p><code>grpc_server</code> 则定义在 <code>src/core/lib/surface/server.h</code> 文件中.</p><p><code>grpc_core::Server</code> 在 <code>src/core/lib/surface/server.h</code> 定义, 大部分成员函数在 <code>src/core/lib/surface/server.cc</code> 中实现.</p><h2 id="服务-Servicer">服务 Servicer</h2><p>当我们编译 <code>.proto</code> 文件时, <code>grpcio_tools.protoc</code> 中的 gRPC 编译器扩展会基于 <code>.proto</code> 中的 <code>service</code> 定义自动生成 <code>XXXServicer</code> 抽象类 以及对应的辅助函数 <code>add_XXXServicer_to_server(servicer: XXXServicer, server: grpc.Server)</code>.</p><p><code>XXXServicer</code> 与 <code>.proto</code> 中的 <code>service</code> 定义一致, 我们重点关注其中的接口函数.</p><p>以较为复杂的双向流接口为例:</p><p><code>.proto</code> 文件中定义如下:</p><pre class="shiki shiki-themes everforest-light everforest-dark" style="background-color:#fdf6e3;--shiki-dark-bg:#2d353b;color:#5c6a72;--shiki-dark:#d3c6aa" tabindex="0"><code><span class="line"><span style="color:#939F91;--shiki-light-font-style:italic;--shiki-dark:#859289;--shiki-dark-font-style:italic">// 文件名 examples/protos/route_guide.proto</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">service</span><span style="color:#35A77C;--shiki-dark:#83C092"> examples</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">/python/route_guide/route_guide_pb2_grpc.py &#123;</span></span><span class="line"><span style="color:#939F91;--shiki-light-font-style:italic;--shiki-dark:#859289;--shiki-dark-font-style:italic">  // 省略其它内容</span></span><span class="line"></span><span class="line"><span style="color:#939F91;--shiki-light-font-style:italic;--shiki-dark:#859289;--shiki-dark-font-style:italic">  // A Bidirectional streaming RPC.</span></span><span class="line"><span style="color:#939F91;--shiki-light-font-style:italic;--shiki-dark:#859289;--shiki-dark-font-style:italic">  //</span></span><span class="line"><span style="color:#939F91;--shiki-light-font-style:italic;--shiki-dark:#859289;--shiki-dark-font-style:italic">  // Accepts a stream of RouteNotes sent while a route is being traversed,</span></span><span class="line"><span style="color:#939F91;--shiki-light-font-style:italic;--shiki-dark:#859289;--shiki-dark-font-style:italic">  // while receiving other RouteNotes (e.g. from other users).</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">  rpc</span><span style="color:#8DA101;--shiki-dark:#A7C080"> RouteChat</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(</span><span style="color:#F85552;--shiki-dark:#E67E80">stream</span><span style="color:#35A77C;--shiki-dark:#83C092"> RouteNote</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">) </span><span style="color:#F85552;--shiki-dark:#E67E80">returns</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> (</span><span style="color:#F85552;--shiki-dark:#E67E80">stream</span><span style="color:#35A77C;--shiki-dark:#83C092"> RouteNote</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">) &#123;&#125;</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">&#125;</span></span></code></pre><p>生成的 <code>Servicer</code> 定义如下:</p><pre class="shiki shiki-themes everforest-light everforest-dark" style="background-color:#fdf6e3;--shiki-dark-bg:#2d353b;color:#5c6a72;--shiki-dark:#d3c6aa" tabindex="0"><code><span class="line"><span style="color:#939F91;--shiki-light-font-style:italic;--shiki-dark:#859289;--shiki-dark-font-style:italic"># 文件名 examples/python/route_guide/route_guide_pb2_grpc.py</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">class</span><span style="color:#3A94C5;--shiki-dark:#7FBBB3"> RouteGuideServicer</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(</span><span style="color:#3A94C5;--shiki-dark:#7FBBB3">object</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">):</span></span><span class="line"></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">  def</span><span style="color:#8DA101;--shiki-dark:#A7C080"> RouteChat</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">      self,</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">      request_iterator:</span><span style="color:#8DA101;--shiki-dark:#A7C080"> grpc</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#8DA101;--shiki-dark:#A7C080">_server</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#8DA101;--shiki-dark:#A7C080">_RequestIterator</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">,</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">      context:</span><span style="color:#8DA101;--shiki-dark:#A7C080"> grpc</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#8DA101;--shiki-dark:#A7C080">ServicerContext</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">,</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">  ):</span></span><span class="line"><span style="color:#DFA000;--shiki-dark:#DBBC7F">    """A Bidirectional streaming RPC.</span></span><span class="line"></span><span class="line"><span style="color:#DFA000;--shiki-dark:#DBBC7F">    Accepts a stream of RouteNotes sent while a route is being traversed,</span></span><span class="line"><span style="color:#DFA000;--shiki-dark:#DBBC7F">    while receiving other RouteNotes (e.g. from other users).</span></span><span class="line"><span style="color:#DFA000;--shiki-dark:#DBBC7F">    """</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">    context</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#8DA101;--shiki-dark:#A7C080">set_code</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(grpc</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">StatusCode</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">UNIMPLEMENTED)</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">    context</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#8DA101;--shiki-dark:#A7C080">set_details</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(</span><span style="color:#DFA000;--shiki-dark:#DBBC7F">'Method not implemented!'</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">)</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">    raise</span><span style="color:#3A94C5;--shiki-dark:#7FBBB3"> NotImplementedError</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(</span><span style="color:#DFA000;--shiki-dark:#DBBC7F">'Method not implemented!'</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">)</span></span></code></pre><p>辅助函数则是对 <code>grpc.Server.add_generic_rpc_handlers</code> 的封装, 其定义如下:</p><pre class="shiki shiki-themes everforest-light everforest-dark" style="background-color:#fdf6e3;--shiki-dark-bg:#2d353b;color:#5c6a72;--shiki-dark:#d3c6aa" tabindex="0"><code><span class="line"><span style="color:#939F91;--shiki-light-font-style:italic;--shiki-dark:#859289;--shiki-dark-font-style:italic"># 文件名 examples/python/route_guide/route_guide_pb2_grpc.py</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">def</span><span style="color:#8DA101;--shiki-dark:#A7C080"> add_RouteGuideServicer_to_server</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(servicer:</span><span style="color:#8DA101;--shiki-dark:#A7C080"> RouteGuideServicer</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">,</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> server:</span><span style="color:#8DA101;--shiki-dark:#A7C080"> grpc</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#8DA101;--shiki-dark:#A7C080">Server</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">):</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">  rpc_method_handlers </span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> &#123;</span></span><span class="line"><span style="color:#939F91;--shiki-light-font-style:italic;--shiki-dark:#859289;--shiki-dark-font-style:italic">      # 省略其它内容</span></span><span class="line"><span style="color:#DFA000;--shiki-dark:#DBBC7F">      'RouteChat'</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">: grpc</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#8DA101;--shiki-dark:#A7C080">stream_stream_rpc_method_handler</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">          servicer</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">RouteChat,</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">          request_deserializer</span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">route__guide__pb2</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">RouteNote</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">FromString,</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">          response_serializer</span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">route__guide__pb2</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">RouteNote</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">SerializeToString,</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">      ),</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">  &#125;</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">  generic_handler </span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> grpc</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#8DA101;--shiki-dark:#A7C080">method_handlers_generic_handler</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(</span><span style="color:#DFA000;--shiki-dark:#DBBC7F">'routeguide.RouteGuide'</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">, rpc_method_handlers)</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">  server</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#8DA101;--shiki-dark:#A7C080">add_generic_rpc_handlers</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">((generic_handler,))</span></span></code></pre><p>上面的 <code>generic_handler</code> 是一个 <code>grpc._utilities.DictionaryGenericHandler</code> 对象, 其属性 <code>_method_handlers</code> 是一个字典, key 为 <code>/service/method</code> (如上述 <code>/routeguide.RouteGuide/RouteChat</code>), 其 value 是 <code>grpc._utilities.RpcMethodHandler</code> 对象.</p><h2 id="接口-Handler">接口 Handler</h2><p>gRPC 提供了两种 Handler 接口:</p><ul><li><code>grpc.RpcMethodHandler</code> 方法 Handler</li><li><code>grpc.ServiceRpcHandler</code> 服务 Handler</li></ul><p>方法 Handler 和 服务 Handler 一般由 gRPC 编译器 <code>grpc_tools.protoc</code> 自动生成, 无需我们自行创建.</p><h3 id="方法-Handler">方法 Handler</h3><p>方法 Handler 的接口定义为 <code>grpc.RpcMethodHandler</code>, 具体实现则为 <code>grpc._utilities.RpcMethodHandler</code>.</p><p>其继承关系图如下</p><pre class="shiki shiki-themes everforest-light everforest-dark" style="background-color:#fdf6e3;--shiki-dark-bg:#2d353b;color:#5c6a72;--shiki-dark:#d3c6aa" tabindex="0"><code><span class="line"><span>grpc._utilities.RpcMethodHandler</span></span><span class="line"><span>-> grpc.RpcMethodHandler</span></span><span class="line"><span>-> abc.ABCMeta (metaclass)</span></span><span class="line"><span>    -> collections.namedtuple</span></span></code></pre><p>gRPC 提供了四种创建 <code>grpc.RpcMethodHandler</code> 的方法:</p><ul><li><code>unary_unary_rpc_method_handler</code></li><li><code>unary_stream_rpc_method_handler</code></li><li><code>stream_unary_rpc_method_handler</code></li><li><code>stream_stream_rpc_method_handler</code></li></ul><p>这些方法与 gRPC 提供的四种接口类型一一对应. 这些方法拥有相似的函数签名,</p><pre class="shiki shiki-themes everforest-light everforest-dark" style="background-color:#fdf6e3;--shiki-dark-bg:#2d353b;color:#5c6a72;--shiki-dark:#d3c6aa" tabindex="0"><code><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">def</span><span style="color:#8DA101;--shiki-dark:#A7C080"> xxx_yyy_rpc_method_handler</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">    behavior:</span><span style="color:#8DA101;--shiki-dark:#A7C080"> Callable</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">,</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">    request_deserializer</span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#35A77C;--shiki-dark:#83C092">None</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">,</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">    response_serializer</span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#35A77C;--shiki-dark:#83C092">None</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">,</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">):</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">    pass</span></span></code></pre><p>其中 <code>behavior</code> 是生成的 Servicer 中对应 <code>.proto</code> 中的 RPC 方法, <code>request_deserializer</code> 是 RPC 方法的输入参数 request 的反序列化方法, <code>response_serialzer</code> RPC 方法的输出 response 的 序列化方法.</p><p><code>grpc._utilities.RpcMethodHandler </code> 的定义如下:</p><pre class="shiki shiki-themes everforest-light everforest-dark" style="background-color:#fdf6e3;--shiki-dark-bg:#2d353b;color:#5c6a72;--shiki-dark:#d3c6aa" tabindex="0"><code><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">class</span><span style="color:#3A94C5;--shiki-dark:#7FBBB3"> RpcMethodHandler</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(</span></span><span class="line"><span style="color:#3A94C5;--shiki-dark:#7FBBB3">        collections</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#3A94C5;--shiki-dark:#7FBBB3">namedtuple</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(</span><span style="color:#DFA000;--shiki-dark:#DBBC7F">'_RpcMethodHandler'</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">, (</span></span><span class="line"><span style="color:#DFA000;--shiki-dark:#DBBC7F">            'request_streaming'</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">,</span></span><span class="line"><span style="color:#DFA000;--shiki-dark:#DBBC7F">            'response_streaming'</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">,</span></span><span class="line"><span style="color:#DFA000;--shiki-dark:#DBBC7F">            'request_deserializer'</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">,</span></span><span class="line"><span style="color:#DFA000;--shiki-dark:#DBBC7F">            'response_serializer'</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">,</span></span><span class="line"><span style="color:#DFA000;--shiki-dark:#DBBC7F">            'unary_unary'</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">,</span></span><span class="line"><span style="color:#DFA000;--shiki-dark:#DBBC7F">            'unary_stream'</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">,</span></span><span class="line"><span style="color:#DFA000;--shiki-dark:#DBBC7F">            'stream_unary'</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">,</span></span><span class="line"><span style="color:#DFA000;--shiki-dark:#DBBC7F">            'stream_stream'</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">,</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">        )), </span><span style="color:#3A94C5;--shiki-dark:#7FBBB3">grpc</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#3A94C5;--shiki-dark:#7FBBB3">RpcMethodHandler</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">):</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">    pass</span></span></code></pre><p>其父类 <code>grpc.RpcMethodHandler</code> 没有定义自己的方法和属性, 因此其所有该类有 8 个属性:</p><ul><li><code>request_streaming</code>, <code>bool</code> 变量, 表明请求是否为流式</li><li><code>response_streaming</code>, <code>bool</code> 变量, 表明响应是否为流式</li><li><code>request_deserializer</code>, 请求序列化方法 (在编译时自动生成)</li><li><code>response_serializer</code>, 响应序列化方法 (在编译时自动生成)</li><li><code>unary_unary</code>, 响应函数</li><li><code>unary_stream</code>, 响应函数</li><li><code>stream_unary</code>, 响应函数</li><li><code>stream_stream</code>, 响应函数</li></ul><p>不同类型的 handler 只需要赋值不同的属性即可, 如 <code>stream_stream_rpc_method_handler</code> 类 handler, 其初始化方法为:</p><pre class="shiki shiki-themes everforest-light everforest-dark" style="background-color:#fdf6e3;--shiki-dark-bg:#2d353b;color:#5c6a72;--shiki-dark:#d3c6aa" tabindex="0"><code><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">_utilities</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#8DA101;--shiki-dark:#A7C080">RpcMethodHandler</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">request_streaming</span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#35A77C;--shiki-dark:#83C092">True</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">,</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">response_streaming</span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#35A77C;--shiki-dark:#83C092">True</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">,</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">request_deserializer</span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">request_deserializer,</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">response_serializer</span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">response_serializer,</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">unary_unary</span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#35A77C;--shiki-dark:#83C092">None</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">,</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">unary_stream</span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#35A77C;--shiki-dark:#83C092">None</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">,</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">stream_unary</span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#35A77C;--shiki-dark:#83C092">None</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">,</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">stream_stream</span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">behavior,</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">)</span></span></code></pre><h3 id="服务-Handler">服务 Handler</h3><p>服务 Handler 是一种特殊的 Handler, 可以将其理解为同一服务的各个方法 Handler 组成的集合.</p><p>服务 Handler 的接口定义为 <code>grpc.ServiceRpcHandler</code>, 该接口是 <code>grpc.GenericRpcHandler</code> 的子接口. 具体实现则为 <code>grpc._utilities.DictionaryGenericHandler</code>.</p><p>继承关系图如下:</p><pre class="shiki shiki-themes everforest-light everforest-dark" style="background-color:#fdf6e3;--shiki-dark-bg:#2d353b;color:#5c6a72;--shiki-dark:#d3c6aa" tabindex="0"><code><span class="line"><span>grpc._utilities.DictionaryGenericHandler</span></span><span class="line"><span>-> grpc.ServiceRpcHandler</span></span><span class="line"><span>-> abc.ABCMeta (metaclass)</span></span><span class="line"><span>        -> grpc.GenericRpcHandler (metaclass)</span></span><span class="line"><span>        -> abc.ABCMeta (metaclass)</span></span></code></pre><p>可以使用 gRPC 提供的 <code>grpc.method_handlers_generic_handler</code> 创建服务 Handler.</p><p><code>grpc._utilities.DictionaryGenericHandler</code> 的定义如下:</p><pre class="shiki shiki-themes everforest-light everforest-dark" style="background-color:#fdf6e3;--shiki-dark-bg:#2d353b;color:#5c6a72;--shiki-dark:#d3c6aa" tabindex="0"><code><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">class</span><span style="color:#3A94C5;--shiki-dark:#7FBBB3"> DictionaryGenericHandler</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(</span><span style="color:#3A94C5;--shiki-dark:#7FBBB3">grpc</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#3A94C5;--shiki-dark:#7FBBB3">ServiceRpcHandler</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">):</span></span><span class="line"></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">    def</span><span style="color:#8DA101;--shiki-dark:#A7C080"> __init__</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">        self,</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">        service:</span><span style="color:#3A94C5;--shiki-dark:#7FBBB3"> str</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">,</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">        method_handlers:</span><span style="color:#8DA101;--shiki-dark:#A7C080"> Mapping</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">[</span><span style="color:#3A94C5;--shiki-dark:#7FBBB3">str</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">,</span><span style="color:#8DA101;--shiki-dark:#A7C080"> grpc</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#8DA101;--shiki-dark:#A7C080">RpcMethodHandler</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">],</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">    ):</span></span><span class="line"><span style="color:#DF69BA;--shiki-dark:#D699B6">        self</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">_name </span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> service</span></span><span class="line"><span style="color:#DF69BA;--shiki-dark:#D699B6">        self</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">_method_handlers </span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> &#123;</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">            _common</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#8DA101;--shiki-dark:#A7C080">fully_qualified_method</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(service, method): method_handler</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">            for</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> method, method_handler </span><span style="color:#F85552;--shiki-dark:#E67E80">in</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> six</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#8DA101;--shiki-dark:#A7C080">iteritems</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(method_handlers)</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">        &#125;</span></span><span class="line"></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">    def</span><span style="color:#8DA101;--shiki-dark:#A7C080"> service_name</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(self)</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> -></span><span style="color:#3A94C5;--shiki-dark:#7FBBB3"> str</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">:</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">        return</span><span style="color:#DF69BA;--shiki-dark:#D699B6"> self</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">_name</span></span><span class="line"></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">    def</span><span style="color:#8DA101;--shiki-dark:#A7C080"> service</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(self,</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> handler_call_details:</span><span style="color:#8DA101;--shiki-dark:#A7C080"> grpc</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#8DA101;--shiki-dark:#A7C080">HandlerCallDetails</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">)</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> -></span><span style="color:#8DA101;--shiki-dark:#A7C080"> grpc</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#8DA101;--shiki-dark:#A7C080">RpcMethodHandler</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">:</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">        return</span><span style="color:#DF69BA;--shiki-dark:#D699B6"> self</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">_method_handlers</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#8DA101;--shiki-dark:#A7C080">get</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(handler_call_details</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">method)</span></span></code></pre><p>其中 <code>service_name()</code> 是从 <code>grpc.ServiceRpcHandler</code> 继承的方法, <code>service(handler_call_details: grpc.HandlerCallDetails)</code> 是从 <code>grpc.GenericRpcHandler</code> 类继承的方法.</p><h2 id="服务端拦截器-2">服务端拦截器</h2><p>服务端拦截器的接口定义为 <code>grpc.ServerInterceptor</code>, 主要提供了一个方法 <code>intercept_service</code>, 该方法签名如下:</p><pre class="shiki shiki-themes everforest-light everforest-dark" style="background-color:#fdf6e3;--shiki-dark-bg:#2d353b;color:#5c6a72;--shiki-dark:#d3c6aa" tabindex="0"><code><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">def</span><span style="color:#8DA101;--shiki-dark:#A7C080"> intercept_service</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">    self,</span></span><span class="line"><span style="color:#939F91;--shiki-light-font-style:italic;--shiki-dark:#859289;--shiki-dark-font-style:italic">    # continuation 是一个函数, 该函数接收一个 grpc.HandlerCallDetails 参数</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">    continuation:</span><span style="color:#8DA101;--shiki-dark:#A7C080"> Callable</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">,</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">    handler_call_details:</span><span style="color:#8DA101;--shiki-dark:#A7C080"> grpc</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#8DA101;--shiki-dark:#A7C080">HandlerCallDetails</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">,</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">):</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">    pass</span></span></code></pre><p>其中参数 <code>handler_call_details</code> 记录了一个方法的的基本信息, 如:</p><ul><li><code>method</code> 方法名</li><li><code>invocation_metadata</code> 客户端调用时传入的元数据</li><li>等</li></ul><p>gRPC 没有提供内置的服务端拦截器实现, 具体实现可以参考:</p><ul><li><code>examples/python/interceptors/headers/request_header_validator_interceptor.py</code></li><li><code>examples/python/auth/customized_auth_server.py</code></li><li><code>src/python/grpcio_tests/tests/unit/_interceptor_test.py</code></li></ul><p>一个服务端拦截器实现示例如下:</p><pre class="shiki shiki-themes everforest-light everforest-dark" style="background-color:#fdf6e3;--shiki-dark-bg:#2d353b;color:#5c6a72;--shiki-dark:#d3c6aa" tabindex="0"><code><span class="line"><span style="color:#939F91;--shiki-light-font-style:italic;--shiki-dark:#859289;--shiki-dark-font-style:italic"># 文件: src/python/grpcio_tests/tests/unit/_interceptor_test.py</span></span><span class="line"></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">class</span><span style="color:#3A94C5;--shiki-dark:#7FBBB3"> _GenericServerInterceptor</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(</span><span style="color:#3A94C5;--shiki-dark:#7FBBB3">grpc</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#3A94C5;--shiki-dark:#7FBBB3">ServerInterceptor</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">):</span></span><span class="line"></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">    def</span><span style="color:#8DA101;--shiki-dark:#A7C080"> __init__</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(self,</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> fn):</span></span><span class="line"><span style="color:#DF69BA;--shiki-dark:#D699B6">        self</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">_fn </span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> fn</span></span><span class="line"></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">    def</span><span style="color:#8DA101;--shiki-dark:#A7C080"> intercept_service</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(self,</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> continuation,</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> handler_call_details):</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">        return</span><span style="color:#DF69BA;--shiki-dark:#D699B6"> self</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#8DA101;--shiki-dark:#A7C080">_fn</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(continuation, handler_call_details)</span></span><span class="line"></span><span class="line"></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">def</span><span style="color:#8DA101;--shiki-dark:#A7C080"> _filter_server_interceptor</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(condition,</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> interceptor):</span></span><span class="line"></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">    def</span><span style="color:#8DA101;--shiki-dark:#A7C080"> intercept_service</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(continuation,</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> handler_call_details):</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">        if</span><span style="color:#8DA101;--shiki-dark:#A7C080"> condition</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(handler_call_details):</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">            return</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> interceptor</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#8DA101;--shiki-dark:#A7C080">intercept_service</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(continuation,</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">                                                 handler_call_details)</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">        return</span><span style="color:#8DA101;--shiki-dark:#A7C080"> continuation</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(handler_call_details)</span></span><span class="line"></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">    return</span><span style="color:#8DA101;--shiki-dark:#A7C080"> _GenericServerInterceptor</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(intercept_service)</span></span></code></pre><h2 id="服务端上下文">服务端上下文</h2><p>服务端上下文接口定义为 <code>grpc.ServicerContext</code>, 该类继承了共享上下文 <code>grpc.RpcContext</code>.</p><p><code>grpc.ServicerContext</code> 在 <code>grpc.RpcContext</code> 的基础上新增了 13 个服务接口.</p><pre class="shiki shiki-themes everforest-light everforest-dark" style="background-color:#fdf6e3;--shiki-dark-bg:#2d353b;color:#5c6a72;--shiki-dark:#d3c6aa" tabindex="0"><code><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">class</span><span style="color:#3A94C5;--shiki-dark:#7FBBB3"> ServicerContext</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(</span><span style="color:#3A94C5;--shiki-dark:#7FBBB3">six</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#3A94C5;--shiki-dark:#7FBBB3">with_metaclass</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(abc</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">ABCMeta, RpcContext)):</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">    def</span><span style="color:#8DA101;--shiki-dark:#A7C080"> invocation_metadata</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(self):</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">        pass</span></span><span class="line"></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">    def</span><span style="color:#8DA101;--shiki-dark:#A7C080"> peer</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(self):</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">        pass</span></span><span class="line"></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">    def</span><span style="color:#8DA101;--shiki-dark:#A7C080"> peer_identities</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(self):</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">        pass</span></span><span class="line"></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">    def</span><span style="color:#8DA101;--shiki-dark:#A7C080"> peer_identity_key</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(self):</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">        pass</span></span><span class="line"></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">    def</span><span style="color:#8DA101;--shiki-dark:#A7C080"> auth_context</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(self):</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">        pass</span></span><span class="line"></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">    def</span><span style="color:#8DA101;--shiki-dark:#A7C080"> set_compression</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(self,</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> compression):</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">        pass</span></span><span class="line"></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">    def</span><span style="color:#8DA101;--shiki-dark:#A7C080"> send_initial_metadata</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(self,</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> initial_metadata):</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">        pass</span></span><span class="line"></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">    def</span><span style="color:#8DA101;--shiki-dark:#A7C080"> set_trailing_metadata</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(self,</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> trailing_metadata):</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">        pass</span></span><span class="line"></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">    def</span><span style="color:#8DA101;--shiki-dark:#A7C080"> abort</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(self,</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> code,</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> details):</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">        pass</span></span><span class="line"></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">    def</span><span style="color:#8DA101;--shiki-dark:#A7C080"> abort_with_status</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(self,</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> status):</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">        pass</span></span><span class="line"></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">    def</span><span style="color:#8DA101;--shiki-dark:#A7C080"> set_code</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(self,</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> code):</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">        pass</span></span><span class="line"></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">    def</span><span style="color:#8DA101;--shiki-dark:#A7C080"> set_details</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(self,</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> details):</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">        pass</span></span><span class="line"></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">    def</span><span style="color:#8DA101;--shiki-dark:#A7C080"> disable_next_mssage_compression</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(self):</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">        pass</span></span></code></pre><p>根据 gRPC 的设计理念, gRPC 服务中的异常都建议使用 <code>grpc.ServicerContext</code> 回传给调用方, 而不是使用自定义响应包中的 <code>error_code</code> 和 <code>error_message</code>.</p><p><code>grpc.ServicerContext</code> 中有一个重要方法 <code>set_code()</code>, 该方法可以设置一个 <code>grpc.StatusCode</code>, 并最终由客户端上下文 <code>grpc.Call</code> 中的 <code>code()</code> 方法返回给调用者.</p><p>状态码 <code>grpc.StatusCode</code> 是一个枚举类型, 定义了 gRPC 工作过程中常用的状态码, 如 <code>OK</code>, <code>CANCELLED</code>, <code>RESOURCE_EXHAUSTED</code> 等. 具体可以参考 <a href="https://grpc.github.io/grpc/python/grpc.html#grpc-status-code">gRPC Status Code 官方文档</a>.</p><p>服务端 Context 的具体实现为 <code>grpc._server._Context</code>, 该类定义在 <code>src/python/grpcio/grpc/_server.py</code> 文件中, 在此不详细展开.</p><h1>客户端概念</h1><p>客户端的主要概念有:</p><ul><li>Stub</li><li>Channel</li><li>接口 Callable</li><li>客户端拦截器 Interceptor</li><li>客户端上下文 Context</li><li>异步调用结果 Future</li></ul><h2 id="客户端-Stub">客户端 Stub</h2><p>客户端 Stub 是编译 <code>.proto</code> 文件时自动生成的. Stub 初始化时需要传入 Channel, 对 Stub 的所有请求最终都会由 Channel 来完成.</p><p>还是以前面的 <code>RouteGuide</code> 为例, 生成的 <code>RouteGuideStub</code> 如下:</p><pre class="shiki shiki-themes everforest-light everforest-dark" style="background-color:#fdf6e3;--shiki-dark-bg:#2d353b;color:#5c6a72;--shiki-dark:#d3c6aa" tabindex="0"><code><span class="line"><span style="color:#939F91;--shiki-light-font-style:italic;--shiki-dark:#859289;--shiki-dark-font-style:italic"># 文件名 examples/python/route_guide/route_guide_pb2_grpc.py</span></span><span class="line"></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">class</span><span style="color:#3A94C5;--shiki-dark:#7FBBB3"> RouteGuideStub</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(</span><span style="color:#3A94C5;--shiki-dark:#7FBBB3">object</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">):</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">  def</span><span style="color:#8DA101;--shiki-dark:#A7C080"> __init__</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(self,</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> channel):</span></span><span class="line"><span style="color:#939F91;--shiki-light-font-style:italic;--shiki-dark:#859289;--shiki-dark-font-style:italic"># 省略其它内容</span></span><span class="line"><span style="color:#DF69BA;--shiki-dark:#D699B6">    self</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">RouteChat </span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> channel</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#8DA101;--shiki-dark:#A7C080">stream_stream</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(</span></span><span class="line"><span style="color:#DFA000;--shiki-dark:#DBBC7F">        '/routeguide.RouteGuide/RouteChat'</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">,</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">        request_serializer</span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">route__guide__pb2</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">RouteNote</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">SerializeToString,</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">        response_deserializer</span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">route__guide__pb2</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">RouteNote</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">FromString,</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">        )</span></span></code></pre><p>调用 <code>RouteGuideStub.RouteChat()</code> 方法实际上是在调用 <code>channel.stream_stream()</code> 返回的 <code>grpc.StreamStreamMultiCallable</code> 对象.</p><h2 id="Channel">Channel</h2><h3 id="创建-Channel">创建 Channel</h3><pre class="shiki shiki-themes everforest-light everforest-dark" style="background-color:#fdf6e3;--shiki-dark-bg:#2d353b;color:#5c6a72;--shiki-dark:#d3c6aa" tabindex="0"><code><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">def</span><span style="color:#8DA101;--shiki-dark:#A7C080"> insecure_channel</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">    target:</span><span style="color:#3A94C5;--shiki-dark:#7FBBB3"> str</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">,</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">    options:</span><span style="color:#8DA101;--shiki-dark:#A7C080"> List</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">[</span><span style="color:#3A94C5;--shiki-dark:#7FBBB3">tuple</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">]</span><span style="color:#F57D26;--shiki-dark:#E69875"> =</span><span style="color:#35A77C;--shiki-dark:#83C092"> None</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">,</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">    compression:</span><span style="color:#8DA101;--shiki-dark:#A7C080"> grpc</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#8DA101;--shiki-dark:#A7C080">Compression </span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#35A77C;--shiki-dark:#83C092"> None</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">,</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">):</span></span><span class="line"><span style="color:#DFA000;--shiki-dark:#DBBC7F">    """Creates an insecure Channel to a server.</span></span><span class="line"></span><span class="line"><span style="color:#DFA000;--shiki-dark:#DBBC7F">    The returned Channel is thread-safe.</span></span><span class="line"></span><span class="line"><span style="color:#DFA000;--shiki-dark:#DBBC7F">    Args:</span></span><span class="line"><span style="color:#DFA000;--shiki-dark:#DBBC7F">      target: The server address</span></span><span class="line"><span style="color:#DFA000;--shiki-dark:#DBBC7F">      options: An optional list of key-value pairs (:term:`channel_arguments`</span></span><span class="line"><span style="color:#DFA000;--shiki-dark:#DBBC7F">        in gRPC Core runtime) to configure the channel.</span></span><span class="line"><span style="color:#DFA000;--shiki-dark:#DBBC7F">      compression: An optional value indicating the compression method to be</span></span><span class="line"><span style="color:#DFA000;--shiki-dark:#DBBC7F">        used over the lifetime of the channel. This is an EXPERIMENTAL option.</span></span><span class="line"></span><span class="line"><span style="color:#DFA000;--shiki-dark:#DBBC7F">    Returns:</span></span><span class="line"><span style="color:#DFA000;--shiki-dark:#DBBC7F">      A Channel.</span></span><span class="line"><span style="color:#DFA000;--shiki-dark:#DBBC7F">    """</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">    pass</span></span></code></pre><h3 id="接口定义-grpc-Channel">接口定义 <code>grpc.Channel</code></h3><p>Channel 的接口 <code>grpc.Channel</code> 定义在 <code>src/python/grpcio/grpc/__init__.py</code> 中. 主体定义如下:</p><pre class="shiki shiki-themes everforest-light everforest-dark" style="background-color:#fdf6e3;--shiki-dark-bg:#2d353b;color:#5c6a72;--shiki-dark:#d3c6aa" tabindex="0"><code><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">class</span><span style="color:#3A94C5;--shiki-dark:#7FBBB3"> Channel</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(</span><span style="color:#3A94C5;--shiki-dark:#7FBBB3">six</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#3A94C5;--shiki-dark:#7FBBB3">with_metaclass</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(abc</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">ABCMeta)):</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">    def</span><span style="color:#8DA101;--shiki-dark:#A7C080"> subscribe</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(self,</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> callback,</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> try_to_connect</span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#35A77C;--shiki-dark:#83C092">False</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">):</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">        pass</span></span><span class="line"></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">    def</span><span style="color:#8DA101;--shiki-dark:#A7C080"> unsubscribe</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(self,</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> callback):</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">        pass</span></span><span class="line"></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">    def</span><span style="color:#8DA101;--shiki-dark:#A7C080"> unary_unary</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(self,</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> method,</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> request_serializer</span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#35A77C;--shiki-dark:#83C092">None</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">,</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> response_deserializer</span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#35A77C;--shiki-dark:#83C092">None</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">):</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">        pass</span></span><span class="line"></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">    def</span><span style="color:#8DA101;--shiki-dark:#A7C080"> unary_stream</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(self,</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> method,</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> request_serializer</span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#35A77C;--shiki-dark:#83C092">None</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">,</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> response_deserializer</span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#35A77C;--shiki-dark:#83C092">None</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">):</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">        pass</span></span><span class="line"></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">    def</span><span style="color:#8DA101;--shiki-dark:#A7C080"> stream_unary</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(self,</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> method,</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> request_serializer</span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#35A77C;--shiki-dark:#83C092">None</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">,</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> response_deserializer</span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#35A77C;--shiki-dark:#83C092">None</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">):</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">        pass</span></span><span class="line"></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">    def</span><span style="color:#8DA101;--shiki-dark:#A7C080"> stream_stream</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(self,</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> method,</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> request_serializer</span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#35A77C;--shiki-dark:#83C092">None</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">,</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> response_deserializer</span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#35A77C;--shiki-dark:#83C092">None</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">):</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">        pass</span></span><span class="line"></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">    def</span><span style="color:#8DA101;--shiki-dark:#A7C080"> close</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(self):</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">        pass</span></span><span class="line"></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">    def</span><span style="color:#8DA101;--shiki-dark:#A7C080"> __enter__</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(self):</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">        pass</span></span><span class="line"></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">    def</span><span style="color:#8DA101;--shiki-dark:#A7C080"> __exit__</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(self,</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> exc_type,</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> exc_val,</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> exc_tb):</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">        pass</span></span></code></pre><p>gRPC 中, Channel 本质上是 HTTP2 长连接的抽象, gRPC 请求应该尽可能地复用 Channel.</p><p>参考资料:</p><ol><li><a href="https://stackoverflow.com/questions/63749113/grpc-call-channel-connection-and-http-2-lifecycle/63839453#63839453">Stack overflow: gRPC call, channel, connection and HTTP/2 lifecycle</a></li><li><a href="https://docs.microsoft.com/en-us/aspnet/core/grpc/performance?view=aspnetcore-5.0">Performance best practices with gRPC</a></li></ol><h3 id="接口实现-grpc-channel-Channel">接口实现 <code>grpc._channel.Channel</code></h3><p>模块 <code>src/python/grpcio/grpc/_channel.py</code> 给出了 <code>grpc.Channel</code> 接口的实现. 其初始化函数:</p><pre class="shiki shiki-themes everforest-light everforest-dark" style="background-color:#fdf6e3;--shiki-dark-bg:#2d353b;color:#5c6a72;--shiki-dark:#d3c6aa" tabindex="0"><code><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">class</span><span style="color:#3A94C5;--shiki-dark:#7FBBB3"> Channel</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(</span><span style="color:#3A94C5;--shiki-dark:#7FBBB3">grpc</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#3A94C5;--shiki-dark:#7FBBB3">Channel</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">):</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">    def</span><span style="color:#8DA101;--shiki-dark:#A7C080"> __init__</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">        self,</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">        target:</span><span style="color:#3A94C5;--shiki-dark:#7FBBB3"> str</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">,</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">        options:</span><span style="color:#8DA101;--shiki-dark:#A7C080"> List</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">[</span><span style="color:#3A94C5;--shiki-dark:#7FBBB3">tuple</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">],</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">        credentials:</span><span style="color:#8DA101;--shiki-dark:#A7C080"> grpc</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#8DA101;--shiki-dark:#A7C080">ChannelCredentials</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">,</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">        compression:</span><span style="color:#8DA101;--shiki-dark:#A7C080"> grpc</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#8DA101;--shiki-dark:#A7C080">Compression</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">,</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">    ):</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">        python_options, core_options </span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#8DA101;--shiki-dark:#A7C080"> _separate_channel_options</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(options)</span></span><span class="line"><span style="color:#DF69BA;--shiki-dark:#D699B6">        self</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">_single_threaded_unary_stream </span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> _DEFAULT_SINGLE_THREADED_UNARY_STREAM</span></span><span class="line"><span style="color:#DF69BA;--shiki-dark:#D699B6">        self</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#8DA101;--shiki-dark:#A7C080">_process_python_options</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(python_options)</span></span><span class="line"><span style="color:#DF69BA;--shiki-dark:#D699B6">        self</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">_channel </span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> cygrpc</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#8DA101;--shiki-dark:#A7C080">Channel</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">            _common</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#8DA101;--shiki-dark:#A7C080">encode</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(target), </span><span style="color:#8DA101;--shiki-dark:#A7C080">_augment_options</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(core_options, compression),</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">            credentials)</span></span><span class="line"><span style="color:#DF69BA;--shiki-dark:#D699B6">        self</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">_call_state </span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#8DA101;--shiki-dark:#A7C080"> _ChannelCallState</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(</span><span style="color:#DF69BA;--shiki-dark:#D699B6">self</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">_channel)</span></span><span class="line"><span style="color:#DF69BA;--shiki-dark:#D699B6">        self</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">_connectivity_state </span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#8DA101;--shiki-dark:#A7C080"> _ChannelConnectivityState</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(</span><span style="color:#DF69BA;--shiki-dark:#D699B6">self</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">_channel)</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">        cygrpc</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#8DA101;--shiki-dark:#A7C080">fork_register_channel</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(</span><span style="color:#DF69BA;--shiki-dark:#D699B6">self</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">)</span></span></code></pre><p>由上述代码可知, <code>grpc._channel.Channel</code> 使用了 Cython 实现 <code>cygrpc.Channel</code>.</p><p><code>cygrpc.Channel</code> 的初始化函数如下:</p><pre class="shiki shiki-themes everforest-light everforest-dark" style="background-color:#fdf6e3;--shiki-dark-bg:#2d353b;color:#5c6a72;--shiki-dark:#d3c6aa" tabindex="0"><code><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">cdef </span><span style="color:#F85552;--shiki-dark:#E67E80">class</span><span style="color:#3A94C5;--shiki-dark:#7FBBB3"> Channel</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">:</span></span><span class="line"></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">  def</span><span style="color:#8DA101;--shiki-dark:#A7C080"> __cinit__</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">      self,</span></span><span class="line"><span style="color:#8DA101;--shiki-dark:#A7C080">      bytes </span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">target,</span></span><span class="line"><span style="color:#8DA101;--shiki-dark:#A7C080">      object </span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">arguments,</span></span><span class="line"><span style="color:#8DA101;--shiki-dark:#A7C080">      ChannelCredentials </span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">channel_credentials,</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">  ):</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">    arguments </span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> () </span><span style="color:#F85552;--shiki-dark:#E67E80">if</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> arguments </span><span style="color:#F57D26;--shiki-dark:#E69875">is</span><span style="color:#35A77C;--shiki-dark:#83C092"> None</span><span style="color:#F85552;--shiki-dark:#E67E80"> else</span><span style="color:#3A94C5;--shiki-dark:#7FBBB3"> tuple</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(arguments)</span></span><span class="line"><span style="color:#8DA101;--shiki-dark:#A7C080">    fork_handlers_and_grpc_init</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">()</span></span><span class="line"><span style="color:#DF69BA;--shiki-dark:#D699B6">    self</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">_state </span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#8DA101;--shiki-dark:#A7C080"> _ChannelState</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">()</span></span><span class="line"><span style="color:#DF69BA;--shiki-dark:#D699B6">    self</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">_state</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">c_call_completion_queue </span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> (</span></span><span class="line"><span style="color:#8DA101;--shiki-dark:#A7C080">        grpc_completion_queue_create_for_next</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(NULL))</span></span><span class="line"><span style="color:#DF69BA;--shiki-dark:#D699B6">    self</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">_state</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">c_connectivity_completion_queue </span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> (</span></span><span class="line"><span style="color:#8DA101;--shiki-dark:#A7C080">        grpc_completion_queue_create_for_next</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(NULL))</span></span><span class="line"><span style="color:#DF69BA;--shiki-dark:#D699B6">    self</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">_arguments </span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> arguments</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">    cdef _ChannelArgs channel_args </span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#8DA101;--shiki-dark:#A7C080"> _ChannelArgs</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(arguments)</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">    if</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> channel_credentials </span><span style="color:#F57D26;--shiki-dark:#E69875">is</span><span style="color:#35A77C;--shiki-dark:#83C092"> None</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">:</span></span><span class="line"><span style="color:#DF69BA;--shiki-dark:#D699B6">      self</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">_state</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">c_channel </span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#8DA101;--shiki-dark:#A7C080"> grpc_insecure_channel_create</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(</span></span><span class="line"><span style="color:#F57D26;--shiki-dark:#E69875">          &#x3C;</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">char </span><span style="color:#F57D26;--shiki-dark:#E69875">*></span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">target, channel_args</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#8DA101;--shiki-dark:#A7C080">c_args</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(), NULL)</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">    else</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">:</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">      c_channel_credentials </span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> channel_credentials</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#8DA101;--shiki-dark:#A7C080">c</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">()</span></span><span class="line"><span style="color:#DF69BA;--shiki-dark:#D699B6">      self</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">_state</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">c_channel </span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#8DA101;--shiki-dark:#A7C080"> grpc_secure_channel_create</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">          c_channel_credentials, </span><span style="color:#F57D26;--shiki-dark:#E69875">&#x3C;</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">char </span><span style="color:#F57D26;--shiki-dark:#E69875">*></span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">target, channel_args</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#8DA101;--shiki-dark:#A7C080">c_args</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(), NULL)</span></span><span class="line"><span style="color:#8DA101;--shiki-dark:#A7C080">      grpc_channel_credentials_release</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(c_channel_credentials)</span></span></code></pre><p><code>cygrpc.Channel</code> 会调用 C 函数 <code>grpc_insecure_channel_create()</code> 或 <code>grpc_secure_channel_create()</code> , 这两者都会返回 <code>grpc_channel</code> 对象.</p><p><code>grpc_channel</code> 定义在 <code>src/core/lib/surface/channel.h</code> 文件中, 同时该文件还定义了一组操作 <code>grpc_channel</code> 的方法.</p><h3 id="Channel-的状态">Channel 的状态</h3><p><code>grpc.Channel</code> 有自己的状态, 状态使用 <code>grpc.ChannelConnectivity</code> 变量存储.</p><p><code>grpc.ChannelConnectivity</code> 是一个 <code>enum.Enum</code> 枚举类型, 一共有五个不同的枚举变量:</p><pre class="shiki shiki-themes everforest-light everforest-dark" style="background-color:#fdf6e3;--shiki-dark-bg:#2d353b;color:#5c6a72;--shiki-dark:#d3c6aa" tabindex="0"><code><span class="line"><span style="color:#939F91;--shiki-dark:#859289">@</span><span style="color:#8DA101;--shiki-dark:#A7C080">enum</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#8DA101;--shiki-dark:#A7C080">unique</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">class</span><span style="color:#3A94C5;--shiki-dark:#7FBBB3"> ChannelConnectivity</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(</span><span style="color:#3A94C5;--shiki-dark:#7FBBB3">enum</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#3A94C5;--shiki-dark:#7FBBB3">Enum</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">):</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">    IDLE </span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> (_cygrpc</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">ConnectivityState</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">idle, </span><span style="color:#DFA000;--shiki-dark:#DBBC7F">'idle'</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">)</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">    CONNECTING </span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> (_cygrpc</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">ConnectivityState</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">connecting, </span><span style="color:#DFA000;--shiki-dark:#DBBC7F">'connecting'</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">)</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">    READY </span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> (_cygrpc</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">ConnectivityState</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">ready, </span><span style="color:#DFA000;--shiki-dark:#DBBC7F">'ready'</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">)</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">    TRANSIENT_FAILURE </span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> (_cygrpc</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">ConnectivityState</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">transient_failure,</span><span style="color:#DFA000;--shiki-dark:#DBBC7F">'transient failure'</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">)</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">    SHUTDOWN </span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> (_cygrpc</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">ConnectivityState</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">shutdown, </span><span style="color:#DFA000;--shiki-dark:#DBBC7F">'shutdown'</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">)</span></span></code></pre><p>从上面的源码可以看到, 每个枚举变量都是一个 元组, 该元素表示了 <code>grpc.Channel</code> 的状态 与 <code>cygrpc.Channel</code> 的状态的对应关系. 后者的状态使用了枚举类 <code>cygrpc.ConnectivityState</code> (位于文件 <code>src/python/grpcio/grpc/_cython/_cygrpc/records.pyx.pxi</code> 中)来存储.</p><h2 id="Callable">Callable</h2><p>前面讲到, 调用 Stub 的方法实际上是对相应的 <code>Callable</code> 类的调用.</p><p>gRPC 的四种接口分别对应了四种 <code>Callable</code></p><ul><li><code>grpc.UnaryUnaryMultiCallable</code></li><li><code>grpc.UnaryStreamMultiCallable</code></li><li><code>grpc.StreamUnaryMultiCallable</code></li><li><code>grpc.StreamStreamMultiCallable</code></li></ul><p>上述 Callable 类在 <code>src/python/grpcio/grpc/__init__.py</code> 中给出了抽象接口, 在 <code>src/python/grpcio/grpc/_channel.py</code> 给出具体实现.</p><blockquote><p>上述四种 Multi-Callable 中, <code>grpc.xxxUnaryyyy</code> 两个类表示返回的非流数据, 这两个类除了定义 <code>__call__()</code> 方法外, 还定义了</p><ul><li><code>future()</code> 实现异步调用</li><li><code>with_call()</code> 实现同步调用</li></ul><p>两个方法. 具体可以参考对应的接口定义和实现.</p></blockquote><p>我们重点关注较为复杂的 <code>grpc.StreamStreamMultiCallable</code> 及其实现 <code>grpc._channel.StreamStreamMultiCallable</code>.</p><h3 id="接口-grpc-StreamStreamMultiCallable">接口: <code>grpc.StreamStreamMultiCallable</code></h3><p>其调用参数为</p><pre class="shiki shiki-themes everforest-light everforest-dark" style="background-color:#fdf6e3;--shiki-dark-bg:#2d353b;color:#5c6a72;--shiki-dark:#d3c6aa" tabindex="0"><code><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">class</span><span style="color:#3A94C5;--shiki-dark:#7FBBB3"> StreamStreamMultiCallable</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(</span><span style="color:#3A94C5;--shiki-dark:#7FBBB3">six</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#3A94C5;--shiki-dark:#7FBBB3">with_metaclass</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(abc</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">ABCMeta)):</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">    def</span><span style="color:#8DA101;--shiki-dark:#A7C080"> __call__</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">        self,</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">        request_iterator:</span><span style="color:#8DA101;--shiki-dark:#A7C080"> Iterator</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">,</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">        timeout:</span><span style="color:#3A94C5;--shiki-dark:#7FBBB3"> float</span><span style="color:#F57D26;--shiki-dark:#E69875"> =</span><span style="color:#35A77C;--shiki-dark:#83C092"> None</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">,</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">        metadata:</span><span style="color:#8DA101;--shiki-dark:#A7C080"> List</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">[</span><span style="color:#3A94C5;--shiki-dark:#7FBBB3">tuple</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">]</span><span style="color:#F57D26;--shiki-dark:#E69875"> =</span><span style="color:#35A77C;--shiki-dark:#83C092"> None</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">,</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">        credentials:</span><span style="color:#8DA101;--shiki-dark:#A7C080"> grpc</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#8DA101;--shiki-dark:#A7C080">CallCredentials </span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#35A77C;--shiki-dark:#83C092"> None</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">,</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">        wait_for_ready:</span><span style="color:#3A94C5;--shiki-dark:#7FBBB3"> bool</span><span style="color:#F57D26;--shiki-dark:#E69875"> =</span><span style="color:#35A77C;--shiki-dark:#83C092"> None</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">,</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">        compression:</span><span style="color:#8DA101;--shiki-dark:#A7C080"> grpc</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#8DA101;--shiki-dark:#A7C080">Compression </span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#35A77C;--shiki-dark:#83C092"> None</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">,</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">    ):</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">        pass</span></span></code></pre><h3 id="实现-grpc-channel-StreamStreamMultiCallable">实现: <code>grpc._channel._StreamStreamMultiCallable</code></h3><pre class="shiki shiki-themes everforest-light everforest-dark" style="background-color:#fdf6e3;--shiki-dark-bg:#2d353b;color:#5c6a72;--shiki-dark:#d3c6aa" tabindex="0"><code><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">class</span><span style="color:#3A94C5;--shiki-dark:#7FBBB3"> _StreamStreamMultiCallable</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(</span><span style="color:#3A94C5;--shiki-dark:#7FBBB3">grpc</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#3A94C5;--shiki-dark:#7FBBB3">StreamStreamMultiCallable</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">):</span></span><span class="line"></span><span class="line"><span style="color:#939F91;--shiki-light-font-style:italic;--shiki-dark:#859289;--shiki-dark-font-style:italic">    # pylint: disable=too-many-arguments</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">    def</span><span style="color:#8DA101;--shiki-dark:#A7C080"> __init__</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">        self,</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">        channel:</span><span style="color:#8DA101;--shiki-dark:#A7C080"> grpc</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#8DA101;--shiki-dark:#A7C080">Channel</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">,</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">        managed_call:</span><span style="color:#8DA101;--shiki-dark:#A7C080"> cygrpc</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#8DA101;--shiki-dark:#A7C080">IntegratedCall</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">,</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">        method:</span><span style="color:#3A94C5;--shiki-dark:#7FBBB3"> bytes</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">,</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">        request_serializer,</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">        response_deserializer,</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">    ):</span></span><span class="line"><span style="color:#DF69BA;--shiki-dark:#D699B6">        self</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">_channel </span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> channel</span></span><span class="line"><span style="color:#DF69BA;--shiki-dark:#D699B6">        self</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">_managed_call </span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> managed_call</span></span><span class="line"><span style="color:#DF69BA;--shiki-dark:#D699B6">        self</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">_method </span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> method</span></span><span class="line"><span style="color:#DF69BA;--shiki-dark:#D699B6">        self</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">_request_serializer </span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> request_serializer</span></span><span class="line"><span style="color:#DF69BA;--shiki-dark:#D699B6">        self</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">_response_deserializer </span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> response_deserializer</span></span><span class="line"><span style="color:#DF69BA;--shiki-dark:#D699B6">        self</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">_context </span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> cygrpc</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#8DA101;--shiki-dark:#A7C080">build_census_context</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">()</span></span><span class="line"></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">    def</span><span style="color:#8DA101;--shiki-dark:#A7C080"> __call__</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">        self,</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">        request_iterator:</span><span style="color:#8DA101;--shiki-dark:#A7C080"> Iterator</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">,</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">        timeout:</span><span style="color:#3A94C5;--shiki-dark:#7FBBB3"> float</span><span style="color:#F57D26;--shiki-dark:#E69875"> =</span><span style="color:#35A77C;--shiki-dark:#83C092"> None</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">,</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">        metadata:</span><span style="color:#8DA101;--shiki-dark:#A7C080"> List</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">[</span><span style="color:#3A94C5;--shiki-dark:#7FBBB3">tuple</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">]</span><span style="color:#F57D26;--shiki-dark:#E69875"> =</span><span style="color:#35A77C;--shiki-dark:#83C092"> None</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">,</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">        credentials:</span><span style="color:#8DA101;--shiki-dark:#A7C080"> grpc</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#8DA101;--shiki-dark:#A7C080">CallCredentials </span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#35A77C;--shiki-dark:#83C092"> None</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">,</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">        wait_for_ready:</span><span style="color:#3A94C5;--shiki-dark:#7FBBB3"> bool</span><span style="color:#F57D26;--shiki-dark:#E69875"> =</span><span style="color:#35A77C;--shiki-dark:#83C092"> None</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">,</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">        compression:</span><span style="color:#8DA101;--shiki-dark:#A7C080"> grpc</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#8DA101;--shiki-dark:#A7C080">Compression </span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#35A77C;--shiki-dark:#83C092"> None</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">,</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">    ):</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">        deadline </span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#8DA101;--shiki-dark:#A7C080"> _deadline</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(timeout)</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">        state </span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#8DA101;--shiki-dark:#A7C080"> _RPCState</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(_STREAM_STREAM_INITIAL_DUE, </span><span style="color:#35A77C;--shiki-dark:#83C092">None</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">, </span><span style="color:#35A77C;--shiki-dark:#83C092">None</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">, </span><span style="color:#35A77C;--shiki-dark:#83C092">None</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">, </span><span style="color:#35A77C;--shiki-dark:#83C092">None</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">)</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">        initial_metadata_flags </span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#8DA101;--shiki-dark:#A7C080"> _InitialMetadataFlags</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">()</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#8DA101;--shiki-dark:#A7C080">with_wait_for_ready</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(wait_for_ready)</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">        augmented_metadata </span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> _compression</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#8DA101;--shiki-dark:#A7C080">augment_metadata</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(metadata, compression)</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">        operationses </span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> (</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">            (</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">                cygrpc</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#8DA101;--shiki-dark:#A7C080">SendInitialMetadataOperation</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(augmented_metadata,initial_metadata_flags),</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">                cygrpc</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#8DA101;--shiki-dark:#A7C080">ReceiveStatusOnClientOperation</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(_EMPTY_FLAGS),</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">            ),</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">            (cygrpc</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#8DA101;--shiki-dark:#A7C080">ReceiveInitialMetadataOperation</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(_EMPTY_FLAGS),),</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">        )</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">        event_handler </span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#8DA101;--shiki-dark:#A7C080"> _event_handler</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(state, </span><span style="color:#DF69BA;--shiki-dark:#D699B6">self</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">_response_deserializer)</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">        call </span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#DF69BA;--shiki-dark:#D699B6"> self</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#8DA101;--shiki-dark:#A7C080">_managed_call</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">            cygrpc</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">PropagationConstants</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">GRPC_PROPAGATE_DEFAULTS,</span></span><span class="line"><span style="color:#DF69BA;--shiki-dark:#D699B6">            self</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">_method,</span></span><span class="line"><span style="color:#35A77C;--shiki-dark:#83C092">            None</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">,</span></span><span class="line"><span style="color:#8DA101;--shiki-dark:#A7C080">            _determine_deadline</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(deadline),</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">            augmented_metadata,</span></span><span class="line"><span style="color:#35A77C;--shiki-dark:#83C092">            None</span><span style="color:#F85552;--shiki-dark:#E67E80"> if</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> credentials </span><span style="color:#F85552;--shiki-dark:#E67E80">is</span><span style="color:#35A77C;--shiki-dark:#83C092"> None</span><span style="color:#F85552;--shiki-dark:#E67E80"> else</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> credentials</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">_credentials,</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">            operationses,</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">            event_handler,</span></span><span class="line"><span style="color:#DF69BA;--shiki-dark:#D699B6">            self</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">_context,</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">        )</span></span><span class="line"><span style="color:#8DA101;--shiki-dark:#A7C080">        _consume_request_iterator</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">            request_iterator,</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">            state,</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">            call,</span></span><span class="line"><span style="color:#DF69BA;--shiki-dark:#D699B6">            self</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">_request_serializer,</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">            event_handler,</span></span><span class="line"><span style="color:#5C6A72;--shiki-dark:#D3C6AA">        )</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">        return</span><span style="color:#8DA101;--shiki-dark:#A7C080"> _MultiThreadedRendezvous</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(state, call, </span><span style="color:#DF69BA;--shiki-dark:#D699B6">self</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">_response_deserializer, deadline)</span></span></code></pre><blockquote><p><strong>census</strong>, 其中文释义为 <code>人口普查; (官方的)调查</code> 等, 来自 <code>self._context = cygrpc.build_census_context()</code></p><p><strong>rendezvous</strong>, 其中文释义为 <code>约会, 聚会, 集合; 约会地点, 聚会场所</code> 等含义 , 来自 <code>_MultiThreadedRendezvous(state, call, self._response_deserializer, deadline)</code></p></blockquote><p>从上述代码可知, 输入流是通过 <code>grpc._channel._consume_request_iterator()</code> 方法实现的, 该方法内部为一个 <code>while True</code> 循环.</p><p><code>grpc._channel.StreamStreamMultiCallable</code> 最终会由 <code>grpc._channel._MultiThreadedRendezvous</code> 类来实现.</p><p>继承关系图</p><pre class="shiki shiki-themes everforest-light everforest-dark" style="background-color:#fdf6e3;--shiki-dark-bg:#2d353b;color:#5c6a72;--shiki-dark:#d3c6aa" tabindex="0"><code><span class="line"><span>grpc._channel._MultiThreadedRendezvous</span></span><span class="line"><span>-> grpc._channel._Rendezvous</span></span><span class="line"><span>-> grpc.RpcError -> Exception</span></span><span class="line"><span>-> grpc.RpcContext -> abc.ABCMeta (metaclass)</span></span><span class="line"><span>-> grpc.Call</span></span><span class="line"><span>-> abc.ABCMeta (metaclass)</span></span><span class="line"><span>-> grpc.RpcContext (metaclass) -> abc.ABCMeta (metaclass)</span></span><span class="line"><span>-> grpc.Future</span></span><span class="line"><span>-> abc.ABCMeta (metaclass)</span></span></code></pre><p>其父类 <code>grpc._channel._Rendezvous</code> 实现了 <code>__iter__()</code> 和 <code>__next__()</code> 方法, 表明 <code>grpc._channel._MultiThreadedRendezvous</code> 既是迭代器, 也是可迭代对象.</p><h2 id="客户端拦截器-2">客户端拦截器</h2><p>gRPC 提供了四种客户端拦截器:</p><ul><li><code>UnaryUnaryClientInterceptor</code></li><li><code>UnaryStreamClientInterceptor</code></li><li><code>StreamUnaryClientInterceptor</code></li><li><code>StreamStreamClientInterceptor</code></li></ul><p>每个拦截器都定义了一个拦截器方法, 分别如下:</p><pre class="shiki shiki-themes everforest-light everforest-dark" style="background-color:#fdf6e3;--shiki-dark-bg:#2d353b;color:#5c6a72;--shiki-dark:#d3c6aa" tabindex="0"><code><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">class</span><span style="color:#3A94C5;--shiki-dark:#7FBBB3"> UnaryUnaryClientInterceptor</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(</span><span style="color:#3A94C5;--shiki-dark:#7FBBB3">six</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#3A94C5;--shiki-dark:#7FBBB3">with_metaclass</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(abc</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">ABCMeta)):</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">    def</span><span style="color:#8DA101;--shiki-dark:#A7C080"> intercept_unary_unary</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(self,</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> continuation,</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> client_call_details,</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> request):</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">        pass</span></span><span class="line"></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">class</span><span style="color:#3A94C5;--shiki-dark:#7FBBB3"> UnaryStreamClientInterceptor</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(</span><span style="color:#3A94C5;--shiki-dark:#7FBBB3">six</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#3A94C5;--shiki-dark:#7FBBB3">with_metaclass</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(abc</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">ABCMeta)):</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">    def</span><span style="color:#8DA101;--shiki-dark:#A7C080"> intercept_unary_stream</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(self,</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> continuation,</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> client_call_details,</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> request):</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">        pass</span></span><span class="line"></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">class</span><span style="color:#3A94C5;--shiki-dark:#7FBBB3"> StreamUnaryClientInterceptor</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(</span><span style="color:#3A94C5;--shiki-dark:#7FBBB3">six</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#3A94C5;--shiki-dark:#7FBBB3">with_metaclass</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(abc</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">ABCMeta)):</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">    def</span><span style="color:#8DA101;--shiki-dark:#A7C080"> intercept_stream_unary</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(self,</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> continuation,</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> client_call_details,</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> request_iterator):</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">        pass</span></span><span class="line"></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">class</span><span style="color:#3A94C5;--shiki-dark:#7FBBB3"> StreamStreamClientInterceptor</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(</span><span style="color:#3A94C5;--shiki-dark:#7FBBB3">six</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#3A94C5;--shiki-dark:#7FBBB3">with_metaclass</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(abc</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">ABCMeta)):</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">    def</span><span style="color:#8DA101;--shiki-dark:#A7C080"> intercept_stream_stream</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(self,</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> continuation,</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> client_call_details,</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> request_iterator):</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">        pass</span></span></code></pre><p>这些接口拥有相似的函数签名:</p><ul><li><code>continuation</code> 是一个函数, 该函数接收 <code>grpc.ClientCallDetails</code> 类型的参数, 也就是接口的下一个参数 <code>client_call_details</code></li><li><code>client_call_details</code> 是一个 <code>grpc.ClientCallDetails</code> 类型参数</li><li><code>request</code> 和 <code>request_iterator</code> 是对应函数的请求参数</li></ul><p>参数 <code>client_call_details</code> 记录了一个客户端请求的详细信息, 如:</p><ul><li><code>method</code> 方法名</li><li><code>timeout</code> 超时时间</li><li><code>metadata</code> 请求元数据</li><li><code>credentials</code> 请求证书</li><li><code>wait_for_ready</code> 等待就绪标识, 具体参考 <a href="https://grpc.github.io/grpc/python/glossary.html#term-wait_for_ready">术语 <code>wait_for_ready</code></a></li><li><code>compression</code> 客户端请求压缩方法</li><li>等等, 具体参考 <code>grpc.ClientCallDetails</code> 类实现</li></ul><p>同样, gRPC 也没有提供内置的客户端拦截器实现. 客户端拦截器实现可以参考:</p><ul><li><code>examples/python/interceptors/headers/generic_client_interceptor.py</code></li><li><code>src/python/grpcio_tests/tests/unit/_interceptor_test.py</code></li></ul><p><code>src/python/grpcio_tests/tests/unit/_interceptor_test.py</code> 文件中的 <code>_LoggingInterceptor</code> 给出了一个较好的拦截器实现示例.</p><h2 id="客户端上下文">客户端上下文</h2><p>客户端上下文接口定义为 <code>grpc.Call</code> , 该接口继承了 <code>grpc.RpcContext</code>.</p><p><code>grpc.Call</code> 在 <code>grpc.RpcContext</code> 的基础上新增了 4 个接口.</p><pre class="shiki shiki-themes everforest-light everforest-dark" style="background-color:#fdf6e3;--shiki-dark-bg:#2d353b;color:#5c6a72;--shiki-dark:#d3c6aa" tabindex="0"><code><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">class</span><span style="color:#3A94C5;--shiki-dark:#7FBBB3"> Call</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(</span><span style="color:#3A94C5;--shiki-dark:#7FBBB3">six</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#3A94C5;--shiki-dark:#7FBBB3">with_metaclass</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(abc</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">ABCMeta, RpcContext)):</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">    def</span><span style="color:#8DA101;--shiki-dark:#A7C080"> initial_metadata</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(self):</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">        pass</span></span><span class="line"></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">    def</span><span style="color:#8DA101;--shiki-dark:#A7C080"> trailing_metadata</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(self):</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">        pass</span></span><span class="line"></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">    def</span><span style="color:#8DA101;--shiki-dark:#A7C080"> code</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(self):</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">        pass</span></span><span class="line"></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">    def</span><span style="color:#8DA101;--shiki-dark:#A7C080"> details</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(self):</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">        pass</span></span></code></pre><p><code>grpc.Call</code> 及其子类 实际上就是一次 gRPC 请求的返回接口. <code>grpc.Channel</code> 的各个 Callable (如前面介绍的 <code>grpc._channel._StreamStreamMultiCallable</code> 等) 调用时的返回值都是 <code>grpc.Call</code> 的实现, 如:</p><ul><li><p><code>grpc._channel._SingleThreadedRendezvous</code></p></li><li><p><code>grpc._channel._MultiThreadedRendezvous</code></p></li><li><p><code>grpc._channel._InactiveRpcError</code></p></li><li><p><code>grpc._interceptor._FailureOutcome</code></p></li><li><p><code>grpc._interceptor._UnaryOutcome</code></p></li><li><p>等等</p></li></ul><p>从这些实现来看, 它们都同时继承了 <code>grpc.Call</code> 和 <code>grpc.Future</code>.</p><p>客户端上下文中有一个重要的方法 <code>code()</code> , 客户端可以通过该方法获取服务端设置的状态码. 该状态码一般由服务端上下文 <code>grpc.ServicerContext</code> 的 <code>set_code()</code> 方法设置.</p><h2 id="异步调用结果-Future">异步调用结果 Future</h2><p>前面讲到, <code>grpc.Call</code> 代表 gRPC 请求的返回结果. 实现了 <code>grpc.Call</code> 接口的方法都实现了 <code>grpc.Future</code> 用于实现异步调用 gRPC.</p><p><code>grpc.Future</code> 提供了如下方法:</p><pre class="shiki shiki-themes everforest-light everforest-dark" style="background-color:#fdf6e3;--shiki-dark-bg:#2d353b;color:#5c6a72;--shiki-dark:#d3c6aa" tabindex="0"><code><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">class</span><span style="color:#3A94C5;--shiki-dark:#7FBBB3"> Future</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(</span><span style="color:#3A94C5;--shiki-dark:#7FBBB3">six</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#3A94C5;--shiki-dark:#7FBBB3">with_metaclass</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(abc</span><span style="color:#939F91;--shiki-dark:#859289">.</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">ABCMeta)):</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">    def</span><span style="color:#8DA101;--shiki-dark:#A7C080"> cancel</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(self):</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">        pass</span></span><span class="line"></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">    def</span><span style="color:#8DA101;--shiki-dark:#A7C080"> cancelled</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(self):</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">        pass</span></span><span class="line"></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">    def</span><span style="color:#8DA101;--shiki-dark:#A7C080"> running</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(self):</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">        pass</span></span><span class="line"></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">    def</span><span style="color:#8DA101;--shiki-dark:#A7C080"> done</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(self):</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">        pass</span></span><span class="line"></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">    def</span><span style="color:#8DA101;--shiki-dark:#A7C080"> result</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(self,</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> timeout</span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#35A77C;--shiki-dark:#83C092">None</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">):</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">        pass</span></span><span class="line"></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">    def</span><span style="color:#8DA101;--shiki-dark:#A7C080"> exception</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(self,</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> timeout</span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#35A77C;--shiki-dark:#83C092">None</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">):</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">        pass</span></span><span class="line"></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">    def</span><span style="color:#8DA101;--shiki-dark:#A7C080"> traceback</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(self,</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> timeout</span><span style="color:#F57D26;--shiki-dark:#E69875">=</span><span style="color:#35A77C;--shiki-dark:#83C092">None</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">):</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">        pass</span></span><span class="line"></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">    def</span><span style="color:#8DA101;--shiki-dark:#A7C080"> add_done_callback</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA">(self,</span><span style="color:#5C6A72;--shiki-dark:#D3C6AA"> fn):</span></span><span class="line"><span style="color:#F85552;--shiki-dark:#E67E80">        pass</span></span></code></pre><p>除了前面提到的 <code>grpc.Call</code> 与 <code>grpc.Future</code>的共同子类外, <code>grpc.Future</code> 还有一个额外的子类 <code>grpc._utilities._ChannelReadyFuture</code>, 这个类由 <code>grpc.channel_ready_future()</code> 方法暴露给调用方使用.</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;通用概念&lt;/h1&gt;
&lt;p&gt;gRPC 中, 有部分概念在服务端和客户端由类似的定义, 比如:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;拦截器 Interceptor&lt;/li&gt;
&lt;li&gt;上下文 Context&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;拦截器-Interceptor&quot;&gt;拦截器 </summary>
      
    
    
    
    <category term="系统架构" scheme="https://loveychen.github.io/categories/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/"/>
    
    
    <category term="gRPC" scheme="https://loveychen.github.io/tags/gRPC/"/>
    
    <category term="源码解析" scheme="https://loveychen.github.io/tags/%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"/>
    
  </entry>
  
</feed>
